<!doctype html>
<html lang="sq">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MIA — Mjekët e Inteligjencës Artificiale</title>
  <style>
    :root{
      --bg0:#030712;
      --bg1:#020817;
      --ink:#e6f1ff;
      --muted:#9bb3d3;
      --glass: rgba(255,255,255,.08);
      --glass2: rgba(255,255,255,.12);
      --line: rgba(255,255,255,.16);
      --aero1: rgba(120,190,255,.22);
      --aero2: rgba(0,170,255,.12);
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius: 22px;
      --radius2: 28px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", sans-serif;
      color:var(--ink);
      background: radial-gradient(1200px 700px at 10% 0%, rgba(40,120,255,.22), transparent 60%),
                  radial-gradient(900px 600px at 80% 20%, rgba(0,220,255,.14), transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
    }

    /* --- Smooth page system --- */
    .app{ height:100%; width:100%; position:relative; }
    .screen{
      position:absolute; inset:0;
      display:grid;
      place-items:center;
      padding:24px;
      opacity:0;
      transform: translateY(18px) scale(.985);
      pointer-events:none;
      transition: opacity .5s ease, transform .55s cubic-bezier(.2,.9,.2,1);
    }
    .screen.active{
      opacity:1;
      transform: translateY(0) scale(1);
      pointer-events:auto;
    }

    /* --- Background ECG layer --- */
    .bg{
      position:absolute; inset:0;
      overflow:hidden;
    }
    .noise{
      position:absolute; inset:-40px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='120' height='120' filter='url(%23n)' opacity='.28'/%3E%3C/svg%3E");
      mix-blend-mode: overlay;
      opacity:.12;
      transform: rotate(3deg);
      pointer-events:none;
    }
    canvas#ecg{
      position:absolute; inset:0;
      width:100%; height:100%;
      opacity:.9;
      filter: drop-shadow(0 0 16px rgba(0,180,255,.25));
    }
    .vignette{
      position:absolute; inset:0;
      background: radial-gradient(1000px 600px at 50% 30%, transparent 30%, rgba(0,0,0,.55) 80%);
      pointer-events:none;
    }

    /* --- Cards / Aero glass --- */
    .card{
      width:min(980px, 94vw);
      border-radius: var(--radius2);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute; inset:-1px;
      background: radial-gradient(700px 240px at 20% 0%, rgba(140,220,255,.20), transparent 60%),
                  radial-gradient(600px 240px at 90% 20%, rgba(0,160,255,.16), transparent 55%);
      pointer-events:none;
    }
    .cardInner{
      position:relative;
      padding: 26px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      margin-bottom:18px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;
      align-items:baseline;
      gap:10px;
      user-select:none;
    }
    .brand .mia{
      font-weight:900;
      letter-spacing:.16em;
      font-size: 22px;
      text-shadow: 0 0 18px rgba(0,190,255,.22);
    }
    .brand .tag{
      font-size: 13px;
      color: var(--muted);
      letter-spacing:.02em;
    }

    .pill{
      font-size:12px;
      color: rgba(230,241,255,.86);
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      padding: 8px 10px;
      border-radius: 999px;
      display:flex;
      gap:8px;
      align-items:center;
      max-width: 520px;
    }
    .pill strong{ font-weight:700; }

    /* --- Buttons (iOS glass + Aero shine) --- */
    .btnRow{ display:flex; gap:14px; flex-wrap:wrap; }
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      color: var(--ink);
      padding: 14px 16px;
      border-radius: 18px;
      font-weight:700;
      letter-spacing:.01em;
      cursor:pointer;
      min-width: 240px;
      transition: transform .15s ease, border-color .2s ease, box-shadow .2s ease, background .2s ease;
      box-shadow: 0 10px 28px rgba(0,0,0,.25);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      position:relative;
      overflow:hidden;
    }
    .btn::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(300px 80px at 20% 0%, rgba(255,255,255,.28), transparent 55%),
        radial-gradient(280px 90px at 80% 10%, rgba(120,220,255,.22), transparent 55%);
      opacity:.75;
      pointer-events:none;
      transform: translateY(-10px);
    }
    .btn:hover{
      transform: translateY(-1px);
      border-color: rgba(170,230,255,.35);
      box-shadow: 0 16px 38px rgba(0,0,0,.30);
    }
    .btn:active{ transform: translateY(0); }
    .btn.small{ min-width:auto; padding: 11px 14px; border-radius: 16px; font-size: 13px; }
    .btn.ghost{
      background: rgba(0,0,0,.10);
      border-color: rgba(255,255,255,.14);
      box-shadow:none;
    }
    .btn.primary{
      background: linear-gradient(180deg, rgba(120,220,255,.22), rgba(0,140,255,.10));
      border-color: rgba(140,220,255,.28);
    }

    /* --- Landing --- */
    .landingWrap{
      width:min(920px, 94vw);
      text-align:center;
      padding: 30px 22px;
    }
    .bigMIA{
      font-size: clamp(54px, 10vw, 96px);
      font-weight: 950;
      letter-spacing: .22em;
      margin: 0;
      display:inline-block;
      cursor:pointer;
      position:relative;
      text-shadow: 0 0 22px rgba(0,200,255,.25);
      user-select:none;
    }
    .bigMIA::after{
      content:"";
      position:absolute; left:50%; top:100%;
      width: 70%;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(120,220,255,.75), transparent);
      transform: translateX(-50%);
      opacity:.7;
    }
    .subtitle{
      margin: 14px 0 0;
      color: var(--muted);
      font-size: clamp(14px, 2.2vw, 18px);
      letter-spacing:.02em;
    }
    .hint{
      margin-top: 22px;
      color: rgba(230,241,255,.75);
      font-size: 13px;
      opacity:.9;
    }
    .kbd{
      display:inline-block;
      padding: 3px 8px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      margin: 0 6px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
    }

    /* --- Forms --- */
    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 720px){
      .grid{ grid-template-columns: 1fr; }
      .btn{ min-width: 100%; }
    }

    .field{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      border-radius: 18px;
      padding: 12px 12px 10px;
      position:relative;
    }
    .field label{
      display:block;
      font-size: 12px;
      color: rgba(230,241,255,.80);
      margin-bottom: 8px;
      letter-spacing:.02em;
    }
    .field .req{
      color: rgba(180,240,255,.95);
      font-weight:700;
      margin-left: 6px;
      font-size: 11px;
      opacity:.9;
    }
    input, select, textarea{
      width:100%;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--ink);
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 14px;
      outline:none;
      transition: border-color .2s ease, box-shadow .2s ease;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(140,220,255,.32);
      box-shadow: 0 0 0 4px rgba(80,180,255,.10);
    }

    .note{
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 18px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(230,241,255,.85);
      font-size: 13px;
      line-height: 1.35;
    }
    .note strong{ color: rgba(220,250,255,.95); }

    .statusRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-top: 14px;
      flex-wrap:wrap;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      font-size: 12px;
      color: rgba(230,241,255,.86);
    }

    /* --- Output --- */
    .out{
      margin-top: 14px;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.14);
      padding: 14px;
    }
    .out h3{
      margin: 0 0 10px;
      font-size: 15px;
      letter-spacing:.02em;
    }
    .out p, .out li{
      color: rgba(230,241,255,.86);
      line-height: 1.45;
      font-size: 13.5px;
    }
    .out ul{ margin: 8px 0 0 18px; }

    .twoCol{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
      margin-top: 12px;
    }
    @media (max-width: 860px){ .twoCol{ grid-template-columns: 1fr; } }

    .week{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      padding: 12px;
    }
    .week .day{
      padding: 10px 10px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      margin-bottom: 10px;
    }
    .week .day:last-child{ margin-bottom:0; }
    .week .day strong{ display:block; margin-bottom: 6px; letter-spacing:.02em; }

    /* --- Scrollable Analysis Panel + Floating buttons --- */
    .analysisPanel{
      margin-top:14px;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.14);
      padding: 14px;
      max-height: 62vh;
      overflow:auto;
      scroll-behavior:smooth;
      position:relative;
    }
    .analysisActions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
      margin-top: 12px;
    }
    .fab{
      position:absolute;
      right: 14px;
      bottom: 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:5;
    }
    .fab .btn{ min-width:auto; }
    @media (max-width:720px){
      .analysisPanel{ max-height: 58vh; }
    }

    /* --- Chat --- */
    .chatBox{
      height: 320px;
      overflow:auto;
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
    }
    .msg{
      max-width: 92%;
      padding: 10px 12px;
      border-radius: 16px;
      margin: 8px 0;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      line-height: 1.35;
      font-size: 13.5px;
      white-space: pre-wrap;
    }
    .msg.me{
      margin-left:auto;
      background: linear-gradient(180deg, rgba(120,220,255,.16), rgba(255,255,255,.06));
      border-color: rgba(140,220,255,.20);
    }
    .chatRow{
      display:flex; gap:10px; margin-top: 12px;
    }
    .chatRow input{ flex:1; }

    .footer{
      margin-top: 14px;
      color: rgba(230,241,255,.62);
      font-size: 12px;
      line-height: 1.35;
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="bg">
      <canvas id="ecg"></canvas>
      <div class="noise"></div>
      <div class="vignette"></div>
    </div>

    <!-- SCREEN 1: Landing -->
    <section class="screen active" id="screen-landing" aria-label="Faqja hyrëse">
      <div class="landingWrap">
        <h1 class="bigMIA" id="miaLogo" title="Kliko për të vazhduar">MIA</h1>
        <div class="subtitle">Mjekët e Inteligjencës Artificiale</div>
        <div class="hint">Kliko mbi <span class="kbd">MIA</span> ose shtyp <span class="kbd">Enter</span>.</div>
      </div>
    </section>

    <!-- SCREEN 2: Main Menu -->
    <section class="screen" id="screen-menu" aria-label="Menuja">
      <div class="card">
        <div class="cardInner">
          <div class="topbar">
            <div class="brand">
              <div class="mia">MIA</div>
              <div class="tag">Mjekët e Inteligjencës Artificiale</div>
            </div>
            <div class="pill" id="profilePill">
              <strong>Profili:</strong> ende pa të dhëna — plotëso “Vendos të dhënat”
            </div>
          </div>

          <div class="btnRow">
            <button class="btn primary" id="btnData">Vendos të dhënat (e detyrueshme)</button>
            <button class="btn" id="btnRoutine">Gjenero Rutinën Personale</button>
            <button class="btn" id="btnAI">Pyet Asistentin AI</button>
          </div>

          <div class="note" style="margin-top:16px;">
            <strong>Shënim:</strong> Ky projekt është edukativ për panairin e shkencës. Nuk bën diagnozë dhe nuk zëvendëson mjekun.
          </div>
        </div>
      </div>
    </section>

    <!-- SCREEN 3: Data Form -->
    <section class="screen" id="screen-data" aria-label="Vendos të dhënat">
      <div class="card">
        <div class="cardInner">
          <div class="topbar">
            <div class="brand">
              <div class="mia">MIA</div>
              <div class="tag">Vendos të dhënat</div>
            </div>
            <button class="btn small ghost" id="backToMenu1">Kthehu</button>
          </div>

          <div class="grid">
            <div class="field">
              <label>Mosha <span class="req">(e detyrueshme)</span></label>
              <input id="age" type="number" min="5" max="120" placeholder="p.sh. 16" />
            </div>

            <div class="field">
              <label>Gjinia <span class="req">(e detyrueshme)</span></label>
              <select id="gender">
                <option value="">Zgjidh…</option>
                <option value="F">Femër</option>
                <option value="M">Mashkull</option>
                <option value="X">Tjetër / preferoj të mos them</option>
              </select>
            </div>

            <div class="field">
              <label>Problemi i zemrës <span style="opacity:.7">(opsional)</span></label>
              <select id="heartIssue">
                <option value="">—</option>
                <option value="tachy">Takikardi / rrahje të shpejta</option>
                <option value="brady">Bradikardi / rrahje të ngadalta</option>
                <option value="arr">Aritmi (të parregullta)</option>
                <option value="bp">Tension i lartë / presion</option>
                <option value="pain">Dhimbje gjoksi / shqetësim</option>
                <option value="other">Tjetër</option>
              </select>
            </div>

            <div class="field">
              <label>Emri <span class="req">(e detyrueshme)</span></label>
              <input id="name" type="text" placeholder="p.sh. Ardi" maxlength="32" />
            </div>
          </div>

          <div class="statusRow">
            <div class="chip" id="formStatus">Plotëso fushat e detyrueshme për të aktivizuar kthimin.</div>
            <button class="btn small primary" id="btnReturnFromData" style="display:none;">Kthehu në faqen kryesore</button>
          </div>

          <div class="footer">
            * Fushat e detyrueshme: Mosha, Gjinia, Emri. “Problemi i zemrës” është opsional.
          </div>
        </div>
      </div>
    </section>

    <!-- SCREEN 4: Routine Generator -->
    <section class="screen" id="screen-routine" aria-label="Gjenero rutinën">
      <div class="card">
        <div class="cardInner">
          <div class="topbar">
            <div class="brand">
              <div class="mia">MIA</div>
              <div class="tag">Rutina personale (edukative)</div>
            </div>
            <button class="btn small ghost" id="backToMenu2">Kthehu</button>
          </div>

          <div class="note">
            Jep <strong>numrin e rrahjeve të zemrës për 1 minutë (BPM)</strong>. MIA do të përgatisë një plan edukativ javor në bazë të të dhënave të vendosura.
          </div>

          <div class="grid" style="margin-top:12px;">
            <div class="field">
              <label>Rrahjet e zemrës (BPM) <span class="req">(e detyrueshme)</span></label>
              <input id="bpm" type="number" min="30" max="220" placeholder="p.sh. 92" />
            </div>
            <div class="field">
              <label>Kur u mat? <span style="opacity:.7">(opsional)</span></label>
              <select id="bpmContext">
                <option value="rest">Në qetësi / ulur</option>
                <option value="after">Pas aktiviteti të lehtë</option>
                <option value="stress">Në stres / ankth</option>
                <option value="unknown">Nuk jam i sigurt</option>
              </select>
            </div>
          </div>

          <div class="statusRow">
            <div class="chip" id="bpmStatus">Vendos BPM për të gjeneruar planin.</div>
            <button class="btn small primary" id="btnGenerate">Gjenero planin</button>
          </div>

          <!-- ANALYSIS / OUTPUT (scrollable) -->
          <div id="analysisWrap" style="display:none;">
            <div class="analysisPanel" id="analysisPanel">
              <div class="fab">
                <button class="btn small ghost" id="btnScrollTop" title="Shko lart">⬆︎ Lart</button>
                <button class="btn small primary" id="btnBackFromAnalysis" title="Kthehu mbrapa">↩︎ Kthehu</button>
              </div>

              <div class="out" style="margin-top:0;">
                <h3 id="outTitle">Plani javor</h3>
                <div class="twoCol">
                  <div>
                    <div id="outSummary"></div>
                    <div id="outTips"></div>
                  </div>
                  <div class="week" id="outWeek"></div>
                </div>
              </div>

              <div class="analysisActions">
                <button class="btn small ghost" id="btnScrollTop2">⬆︎ Scroll Top</button>
                <button class="btn small primary" id="btnBackFromAnalysis2">Kthehu në faqen e mëparshme</button>
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- SCREEN 5: AI Assistant (REAL via Worker) -->
    <section class="screen" id="screen-ai" aria-label="Asistenti AI">
      <div class="card">
        <div class="cardInner">
          <div class="topbar">
            <div class="brand">
              <div class="mia">MIA</div>
              <div class="tag">Asistenti AI (online, edukativ)</div>
            </div>
            <button class="btn small ghost" id="backToMenu4">Kthehu</button>
          </div>

          <div class="note">
            Pyet për BPM, zakone të shëndetshme, si të organizosh rutinën, etj.
            Nëse ke shenja alarmi (dhimbje gjoksi, të fikët, gulçim i fortë), kërko ndihmë mjekësore.
          </div>

          <div class="chatBox" id="chatBox" aria-live="polite"></div>

          <div class="chatRow">
            <input id="chatInput" type="text" placeholder="Shkruaj pyetjen…" />
            <button class="btn small primary" id="chatSend">Dërgo</button>
          </div>

          <div class="footer">
            * Asistenti jep përgjigje edukative. Nuk zëvendëson mjekun.
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    /***********************
     * CONFIG (AI Worker)
     ***********************/
    const WORKER_URL = "https://sparkling-flower-928d.renibeshiri.workers.dev";

    /***********************
     * Router
     ***********************/
    const screens = {
      landing: document.getElementById("screen-landing"),
      menu: document.getElementById("screen-menu"),
      data: document.getElementById("screen-data"),
      routine: document.getElementById("screen-routine"),
      ai: document.getElementById("screen-ai"),
    };

    function go(to){
      Object.values(screens).forEach(s => s.classList.remove("active"));
      screens[to].classList.add("active");
      setTimeout(() => {
        const focusables = screens[to].querySelectorAll("button, input, select, textarea");
        if (focusables.length) focusables[0].focus({preventScroll:true});
      }, 60);
    }

    /***********************
     * State
     ***********************/
    const state = {
      profile: { age:null, gender:"", heartIssue:"", name:"" }
    };

    const profilePill = document.getElementById("profilePill");
    function escapeHtml(str){
      return (str ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function updateProfilePill(){
      const p = state.profile;
      const ok = (p.age && p.gender && p.name);
      if(!ok){
        profilePill.innerHTML = "<strong>Profili:</strong> ende pa të dhëna — plotëso “Vendos të dhënat”";
        return;
      }
      const issueLabel = ({
        "": "pa problem të deklaruar",
        "tachy":"takikardi",
        "brady":"bradikardi",
        "arr":"aritmi",
        "bp":"tension i lartë",
        "pain":"shqetësim/dhimbje gjoksi",
        "other":"tjetër"
      })[p.heartIssue ?? ""] || "—";

      const g = (p.gender==="F" ? "F" : (p.gender==="M" ? "M" : "X"));
      profilePill.innerHTML =
        `<strong>Profili:</strong> ${escapeHtml(p.name)} · ${p.age} vjeç · gjinia ${g} · ${issueLabel}`;
    }

    /***********************
     * Landing
     ***********************/
    document.getElementById("miaLogo").addEventListener("click", () => go("menu"));
    window.addEventListener("keydown", (e) => {
      if(screens.landing.classList.contains("active") && e.key === "Enter") go("menu");
    });

    /***********************
     * Menu
     ***********************/
    document.getElementById("btnData").addEventListener("click", () => go("data"));

    document.getElementById("btnRoutine").addEventListener("click", () => {
      const p = state.profile;
      if(!(p.age && p.gender && p.name)){
        go("data");
        flash(document.getElementById("formStatus"), "Duhet të plotësosh fillimisht Mosha, Gjinia, Emri.", 2200);
        return;
      }
      go("routine");
    });

    document.getElementById("btnAI").addEventListener("click", () => {
      go("ai");
      bootChat();
      setTimeout(() => document.getElementById("chatInput").focus(), 120);
    });

    /***********************
     * Data Form
     ***********************/
    const ageEl = document.getElementById("age");
    const genderEl = document.getElementById("gender");
    const heartIssueEl = document.getElementById("heartIssue");
    const nameEl = document.getElementById("name");
    const formStatus = document.getElementById("formStatus");
    const btnReturnFromData = document.getElementById("btnReturnFromData");

    function validateProfile(){
      const age = parseInt(ageEl.value, 10);
      const gender = genderEl.value;
      const name = nameEl.value.trim();

      const ageOk = Number.isFinite(age) && age >= 5 && age <= 120;
      const genderOk = !!gender;
      const nameOk = name.length >= 2;

      const ok = ageOk && genderOk && nameOk;

      if(ok){
        formStatus.textContent = "Gati ✅ Tani mund të kthehesh në faqen kryesore.";
        btnReturnFromData.style.display = "inline-flex";
      } else {
        let missing = [];
        if(!ageOk) missing.push("Mosha (5–120)");
        if(!genderOk) missing.push("Gjinia");
        if(!nameOk) missing.push("Emri (min 2 shkronja)");
        formStatus.textContent = "Plotëso: " + missing.join(" · ");
        btnReturnFromData.style.display = "none";
      }
      return ok;
    }

    function saveProfile(){
      state.profile.age = parseInt(ageEl.value, 10);
      state.profile.gender = genderEl.value;
      state.profile.heartIssue = heartIssueEl.value;
      state.profile.name = nameEl.value.trim();
      updateProfilePill();
    }

    [ageEl, genderEl, heartIssueEl, nameEl].forEach(el => {
      el.addEventListener("input", validateProfile);
      el.addEventListener("change", validateProfile);
    });

    btnReturnFromData.addEventListener("click", () => {
      if(validateProfile()){
        saveProfile();
        go("menu");
      }
    });

    document.getElementById("backToMenu1").addEventListener("click", () => go("menu"));

    /***********************
     * Routine Generator + Analysis Scroll/Back
     ***********************/
    document.getElementById("backToMenu2").addEventListener("click", () => go("menu"));

    const bpmEl = document.getElementById("bpm");
    const bpmContextEl = document.getElementById("bpmContext");
    const bpmStatus = document.getElementById("bpmStatus");
    const btnGenerate = document.getElementById("btnGenerate");

    const analysisWrap = document.getElementById("analysisWrap");
    const analysisPanel = document.getElementById("analysisPanel");
    const btnScrollTop = document.getElementById("btnScrollTop");
    const btnScrollTop2 = document.getElementById("btnScrollTop2");
    const btnBackFromAnalysis = document.getElementById("btnBackFromAnalysis");
    const btnBackFromAnalysis2 = document.getElementById("btnBackFromAnalysis2");

    const outTitle = document.getElementById("outTitle");
    const outSummary = document.getElementById("outSummary");
    const outTips = document.getElementById("outTips");
    const outWeek = document.getElementById("outWeek");

    function bpmOk(){
      const bpm = parseInt(bpmEl.value, 10);
      const ok = Number.isFinite(bpm) && bpm >= 30 && bpm <= 220;
      bpmStatus.textContent = ok ? "BPM i vlefshëm ✅" : "Vendos BPM (30–220).";
      return ok;
    }
    bpmEl.addEventListener("input", bpmOk);

    function backFromAnalysis(){
      analysisWrap.style.display = "none";
      // keep user on routine screen with inputs visible
      analysisPanel.scrollTop = 0;
    }
    btnBackFromAnalysis.addEventListener("click", backFromAnalysis);
    btnBackFromAnalysis2.addEventListener("click", backFromAnalysis);

    function scrollTopAnalysis(){
      analysisPanel.scrollTo({ top: 0, behavior: "smooth" });
    }
    btnScrollTop.addEventListener("click", scrollTopAnalysis);
    btnScrollTop2.addEventListener("click", scrollTopAnalysis);

    btnGenerate.addEventListener("click", () => {
      const p = state.profile;
      if(!(p.age && p.gender && p.name)){
        go("data");
        flash(formStatus, "Plotëso të dhënat e detyrueshme përpara rutinës.", 2200);
        return;
      }
      if(!bpmOk()){
        flash(bpmStatus, "BPM nuk është i vlefshëm. Provoni 30–220.", 2000);
        return;
      }
      const bpm = parseInt(bpmEl.value, 10);
      const ctx = bpmContextEl.value;
      const plan = buildPlan(p, bpm, ctx);
      renderPlan(p, bpm, ctx, plan);

      analysisWrap.style.display = "block";
      analysisPanel.scrollTop = 0;
      analysisWrap.scrollIntoView({behavior:"smooth", block:"start"});
    });

    function buildPlan(profile, bpm, ctx){
      const age = profile.age;
      const isTeen = age >= 12 && age <= 19;
      const isYoungAdult = age >= 20 && age <= 35;
      const isAdult = age >= 36 && age <= 59;
      const isSenior = age >= 60;

      const zone = (bpm < 60) ? "low" : (bpm <= 100 ? "normal" : "high");

      const ctxNote = {
        rest: "Matje në qetësi: më e krahasueshme me vlerat standarde.",
        after: "Pas aktiviteti: BPM rritet natyrshëm; prit disa minuta dhe mat sërish në qetësi.",
        stress: "Në stres: ankthi dhe frymëmarrja e shpejtë e rrisin përkohësisht BPM.",
        unknown: "Kontekst i panjohur: interpreto me kujdes dhe mat sërish në qetësi."
      }[ctx] || "";

      const issue = profile.heartIssue || "";

      let waterL = 1.6;
      if(isTeen) waterL = 1.8;
      if(isYoungAdult) waterL = 2.0;
      if(isAdult) waterL = 1.9;
      if(isSenior) waterL = 1.7;
      if(zone === "high") waterL += 0.2;

      let sleepH = 8;
      if(isTeen) sleepH = 8.5;
      if(isYoungAdult) sleepH = 7.5;
      if(isAdult) sleepH = 7.5;
      if(isSenior) sleepH = 7.0;

      let activity = {
        cardio: "20–30 min ecje e shpejtë, 4–5 ditë/javë",
        strength: "2 ditë/javë ushtrime të lehta (peshë e trupit)",
        mobility: "5–8 min shtrirje çdo ditë"
      };

      if(zone === "high"){
        activity.cardio = "15–25 min ecje e moderuar, 4 ditë/javë (pa e tepruar)";
        activity.strength = "2 ditë/javë ushtrime të lehta + pauza";
        activity.mobility = "8–10 min shtrirje + frymëmarrje";
      }
      if(zone === "low"){
        activity.cardio = "20 min ecje e lehtë, 4 ditë/javë + ngrohje e gjatë";
        activity.strength = "2 ditë/javë (ritëm i kontrolluar)";
      }

      const emphasis = [];
      if(isTeen && (issue === "tachy" || zone === "high")){
        emphasis.push("Te adoleshentët, stresi, energizantët/kafeina, mungesa e gjumit dhe nikotina mund të rrisin rrahjet.");
      }
      if(issue === "tachy" || zone === "high"){
        emphasis.push("Kufizo energizantët/kafeinën, pi ujë rregullisht dhe bëj pauza frymëmarrjeje.");
      }
      if(issue === "arr"){
        emphasis.push("Nëse ndjen rrahje të parregullta + marramendje, mat pulsin në qetësi dhe konsultohu me mjek.");
      }
      if(issue === "bp"){
        emphasis.push("Ushqim më i balancuar, më pak kripë dhe ecje e rregullt janë hapa edukativë të dobishëm.");
      }
      if(issue === "pain"){
        emphasis.push("Dhimbja e gjoksit kërkon vëmendje profesionale—mos e injoro, sidomos me gulçim/të fikët.");
      }

      const timing = [
        {t:"08:00", a:"Ujë 250ml + mëngjes i lehtë (fruta/drithëra/produkte qumështi)"},
        {t:"11:00", a:"Ujë 250ml + pushim 3 min frymëmarrje (4-4-6)"},
        {t:"14:00", a:"Drekë e balancuar + ujë 300ml"},
        {t:"17:00", a:`Aktivitet: ${activity.cardio}`},
        {t:"20:30", a:`Shtrirje: ${activity.mobility} + ul ekranet 30 min para gjumit`},
      ];

      const week = [
        {d:"E Hënë", items:["Ecje 20–25 min", "Shtrirje 8 min", "Shënim: energji/stres"]},
        {d:"E Martë", items:["Ushtrime të lehta 15–20 min", "Pushime të shkurtra gjatë ditës", "Hidratim i rregullt"]},
        {d:"E Mërkurë", items:["Ecje 20–30 min", "Frymëmarrje 5 min", "Gjumë në orar"]},
        {d:"E Enjte", items:["Ushtrime të lehta 15–20 min", "Shtrirje 8 min", "Më pak kafeinë pas orës 15:00"]},
        {d:"E Premte", items:["Ecje 20–30 min", "Aktivitet relaksues (lexim/muzikë)", "Hidratim + vakt i lehtë"]},
        {d:"E Shtunë", items:["Aktivitet i lirë: ecje/biçikletë", "Shtrirje 10 min", "Koha jashtë 30–60 min"]},
        {d:"E Diel", items:["Ditë rikuperimi: ecje e lehtë", "Planifikim i javës", "Gjumë më herët"]},
      ];

      if(zone === "high"){
        week[0].items[0] = "Ecje moderuar 15–20 min (jo sprint)";
        week[2].items[0] = "Ecje 15–25 min + pauzë nëse rritet shumë BPM";
        week[5].items[0] = "Aktivitet i lehtë: shëtitje / ecje e qetë";
      }

      const caution = [];
      if(zone === "high" && ctx === "rest"){
        caution.push("Nëse BPM i lartë në qetësi përsëritet, është arsye e mirë për kontroll mjekësor.");
      }
      if(zone === "low" && ctx === "rest"){
        caution.push("BPM i ulët në qetësi mund të jetë normal te sportistët; nëse shoqërohet me lodhje/të fikët, konsultohu.");
      }
      caution.push("Kjo është udhëzues edukativ, jo diagnozë.");

      return { meta:{zone, ctxNote}, waterL, sleepH, activity, timing, week, emphasis, caution };
    }

    function renderPlan(profile, bpm, ctx, plan){
      const zoneLabel = plan.meta.zone === "high" ? "i lartë" : (plan.meta.zone==="low" ? "i ulët" : "normal");
      const issueLabel = ({
        "": "pa problem të deklaruar",
        "tachy":"takikardi",
        "brady":"bradikardi",
        "arr":"aritmi",
        "bp":"tension i lartë",
        "pain":"dhimbje/shqetësim gjoksi",
        "other":"tjetër"
      })[profile.heartIssue ?? ""] || "—";

      outTitle.textContent = `Analiza & Plani javor për ${profile.name}`;

      const headline = `
        <p><strong>Profili:</strong> ${escapeHtml(profile.name)}, ${profile.age} vjeç · problemi: <strong>${issueLabel}</strong></p>
        <p><strong>BPM:</strong> ${bpm} (${zoneLabel}) · <strong>Kontekst:</strong> ${escapeHtml(ctx)}<br>
        <span style="color: rgba(230,241,255,.72);">${escapeHtml(plan.meta.ctxNote)}</span></p>
      `;

      const water = plan.waterL.toFixed(1);
      const sleep = plan.sleepH.toFixed(1);

      const summary = `
        <div class="note" style="margin-top:0;">
          <strong>Objektivi edukativ i javës:</strong> stabilitet energjie, hidratim, gjumë i rregullt dhe aktivitet i moderuar.
          <div style="margin-top:10px;">
            <span class="chip">Ujë: ~${water} L/ditë</span>
            <span class="chip">Gjumë: ~${sleep} orë/natë</span>
            <span class="chip">Aktivitet: ${escapeHtml(plan.activity.cardio)}</span>
          </div>
        </div>
      `;

      const timingList = plan.timing.map(x => `<li><strong>${x.t}</strong> — ${escapeHtml(x.a)}</li>`).join("");

      const emphasisList = (plan.emphasis.length ? `
        <div class="note" style="background: var(--aero2); border-color: rgba(120,220,255,.22);">
          <strong>Përshtatje sipas profilit:</strong>
          <ul>${plan.emphasis.map(e => `<li>${escapeHtml(e)}</li>`).join("")}</ul>
        </div>
      ` : "");

      const cautionList = (plan.caution.length ? `
        <div class="note" style="background: rgba(255,200,120,.10); border-color: rgba(255,220,140,.20);">
          <strong>Kujdes:</strong>
          <ul>${plan.caution.map(c => `<li>${escapeHtml(c)}</li>`).join("")}</ul>
        </div>
      ` : "");

      outSummary.innerHTML = headline + summary;

      outTips.innerHTML = `
        <div class="out" style="margin-top:12px;">
          <h3>Rutina ditore (shembull)</h3>
          <ul>${timingList}</ul>
          <p style="margin-top:10px; color: rgba(230,241,255,.72);">
            * Këshillat janë të përgjithshme edukative. Për gjendje specifike, ndiq këshillën e mjekut.
          </p>
        </div>
        ${emphasisList}
        ${cautionList}
      `;

      outWeek.innerHTML = plan.week.map(d => `
        <div class="day">
          <strong>${d.d}</strong>
          <ul style="margin:0 0 0 18px;">
            ${d.items.map(it => `<li>${escapeHtml(it)}</li>`).join("")}
          </ul>
        </div>
      `).join("");
    }

    /***********************
     * AI Chat (Real)
     ***********************/
    const chatBox = document.getElementById("chatBox");
    const chatInput = document.getElementById("chatInput");
    const chatSend = document.getElementById("chatSend");

    document.getElementById("backToMenu4").addEventListener("click", () => go("menu"));

    function addMsg(text, who="bot"){
      const div = document.createElement("div");
      div.className = "msg" + (who==="me" ? " me" : "");
      div.textContent = text;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function bootChat(){
      chatBox.innerHTML = "";
      addMsg("Përshëndetje! Unë jam MIA. Më pyet për BPM, rutinë, hidratim, gjumë, aktivitet fizik (edukativ).");
      const p = state.profile;
      if(p.age && p.gender && p.name){
        addMsg(`Profili yt: ${p.name}, ${p.age} vjeç. (Nëse do rutinë të personalizuar, përdor edhe “Gjenero Rutinën Personale”.)`);
      } else {
        addMsg("Nëse do përgjigje më të përshtatura, plotëso më parë “Vendos të dhënat”.");
      }
    }

    async function askAI(prompt){
      const res = await fetch(WORKER_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt, profile: state.profile })
      });

      const raw = await res.text();
      let data = {};
      try { data = raw ? JSON.parse(raw) : {}; } catch {}

      if (data.text) return data.text;
      // fallback: show something useful
      return raw ? raw.slice(0, 400) : "AI nuk u përgjigj siç duhet.";
    }

    function sendChat(){
      const q = chatInput.value.trim();
      if(!q) return;
      addMsg(q, "me");
      chatInput.value = "";

      // IMPORTANT: await only inside async function (safe)
      setTimeout(async () => {
        addMsg("Po mendoj…", "bot");
        const last = chatBox.lastChild;
        try {
          last.textContent = await askAI(q);
        } catch (e) {
          last.textContent = "Gabim lidhjeje me AI. Provo sërish.";
        }
      }, 120);
    }

    chatSend.addEventListener("click", sendChat);
    chatInput.addEventListener("keydown", (e) => { if(e.key === "Enter") sendChat(); });

    /***********************
     * Helpers
     ***********************/
    function flash(el, text, ms=1800){
      const prev = el.textContent;
      el.textContent = text;
      el.style.borderColor = "rgba(255,220,140,.28)";
      el.style.background = "rgba(255,220,140,.10)";
      setTimeout(() => {
        el.textContent = prev;
        el.style.borderColor = "";
        el.style.background = "";
      }, ms);
    }

    /***********************
     * Init
     ***********************/
    updateProfilePill();
    validateProfile();

    /***********************
     * ECG canvas animation
     ***********************/
    const canvas = document.getElementById("ecg");
    const ctx = canvas.getContext("2d");
    let W=0, H=0, t=0;

    function resize(){
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      W = canvas.clientWidth;
      H = canvas.clientHeight;
      canvas.width = Math.floor(W*dpr);
      canvas.height = Math.floor(H*dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    window.addEventListener("resize", resize);
    resize();

    function draw(){
      t += 0.016;

      ctx.fillStyle = "rgba(0,0,0,0.18)";
      ctx.fillRect(0,0,W,H);

      ctx.save();
      ctx.globalAlpha = 0.10;
      ctx.strokeStyle = "rgba(120,220,255,0.35)";
      ctx.lineWidth = 1;
      const step = 42;
      for(let x=0; x<W; x+=step){
        ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke();
      }
      for(let y=0; y<H; y+=step){
        ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke();
      }
      ctx.restore();

      const mid = H*0.52;
      const amp = Math.min(64, H*0.10);

      ctx.save();
      ctx.lineWidth = 2.2;
      ctx.strokeStyle = "rgba(140,220,255,0.95)";
      ctx.shadowColor = "rgba(0,190,255,0.35)";
      ctx.shadowBlur = 18;

      ctx.beginPath();
      const speed = 220;
      const phase = (t*speed) % W;

      for(let x=0; x<=W; x++){
        const u = ((x + phase) % 260) / 260;
        let y = 0;
        y += Math.sin((x*0.014) + t*1.6) * (amp*0.08);

        if(u > 0.30 && u < 0.34) y += -amp*0.20;
        if(u >= 0.34 && u < 0.36) y +=  amp*0.55;
        if(u >= 0.36 && u < 0.40) y += -amp*1.00;
        if(u >= 0.40 && u < 0.44) y +=  amp*0.30;
        if(u >= 0.44 && u < 0.52) y +=  Math.sin((u-0.44)*Math.PI*6) * (amp*0.10);

        const yy = mid + y;
        if(x===0) ctx.moveTo(x, yy);
        else ctx.lineTo(x, yy);
      }
      ctx.stroke();

      ctx.globalAlpha = 0.25;
      ctx.lineWidth = 6;
      ctx.strokeStyle = "rgba(0,200,255,0.35)";
      ctx.stroke();

      ctx.restore();

      requestAnimationFrame(draw);
    }
    ctx.fillStyle = "rgba(0,0,0,1)";
    ctx.fillRect(0,0,W,H);
    requestAnimationFrame(draw);
  </script>
</body>
</html>

