<!doctype html>
<html lang="sq">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MIA â€” MjekÃ«t e InteligjencÃ«s Artificiale</title>
  <style>
    :root{
      --bg0:#030712;
      --bg1:#020817;
      --ink:#e6f1ff;
      --muted:#9bb3d3;
      --glass: rgba(255,255,255,.08);
      --glass2: rgba(255,255,255,.12);
      --line: rgba(255,255,255,.16);
      --aero1: rgba(120,190,255,.22);
      --aero2: rgba(0,170,255,.12);
      --ok: rgba(80,255,190,.14);
      --warn: rgba(255,220,120,.14);
      --bad: rgba(255,120,160,.14);
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius: 22px;
      --radius2: 28px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", sans-serif;
      color:var(--ink);
      background: radial-gradient(1200px 700px at 10% 0%, rgba(40,120,255,.22), transparent 60%),
                  radial-gradient(900px 600px at 80% 20%, rgba(0,220,255,.14), transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
    }

    /* --- Smooth page system --- */
    .app{ height:100%; width:100%; position:relative; }
    .screen{
      position:absolute; inset:0;
      display:grid;
      place-items:center;
      padding:24px;
      opacity:0;
      transform: translateY(18px) scale(.985);
      pointer-events:none;
      transition: opacity .5s ease, transform .55s cubic-bezier(.2,.9,.2,1);
    }
    .screen.active{
      opacity:1;
      transform: translateY(0) scale(1);
      pointer-events:auto;
    }

    /* --- Background ECG layer --- */
    .bg{ position:absolute; inset:0; overflow:hidden; }
    .noise{
      position:absolute; inset:-40px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='120' height='120' filter='url(%23n)' opacity='.28'/%3E%3C/svg%3E");
      mix-blend-mode: overlay;
      opacity:.12;
      transform: rotate(3deg);
      pointer-events:none;
    }
    canvas#ecg{
      position:absolute; inset:0;
      width:100%; height:100%;
      opacity:.9;
      filter: drop-shadow(0 0 16px rgba(0,180,255,.25));
    }
    .vignette{
      position:absolute; inset:0;
      background: radial-gradient(1000px 600px at 50% 30%, transparent 30%, rgba(0,0,0,.55) 80%);
      pointer-events:none;
    }

    /* --- Cards / Aero glass --- */
    .card{
      width:min(980px, 94vw);
      border-radius: var(--radius2);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute; inset:-1px;
      background: radial-gradient(700px 240px at 20% 0%, rgba(140,220,255,.20), transparent 60%),
                  radial-gradient(600px 240px at 90% 20%, rgba(0,160,255,.16), transparent 55%);
      pointer-events:none;
    }
    .cardInner{
      position:relative;
      padding: 26px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      margin-bottom:18px;
    }
    .brand{
      display:flex;
      align-items:baseline;
      gap:10px;
      user-select:none;
    }
    .brand .mia{
      font-weight:900;
      letter-spacing:.16em;
      font-size: 22px;
      text-shadow: 0 0 18px rgba(0,190,255,.22);
    }
    .brand .tag{
      font-size: 13px;
      color: var(--muted);
      letter-spacing:.02em;
    }

    .pill{
      font-size:12px;
      color: rgba(230,241,255,.86);
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      padding: 8px 10px;
      border-radius: 999px;
      display:flex;
      gap:8px;
      align-items:center;
      max-width: 520px;
    }
    .pill strong{ font-weight:700; }

    /* --- Buttons --- */
    .btnRow{ display:flex; gap:14px; flex-wrap:wrap; }
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      color: var(--ink);
      padding: 14px 16px;
      border-radius: 18px;
      font-weight:700;
      letter-spacing:.01em;
      cursor:pointer;
      min-width: 240px;
      transition: transform .15s ease, border-color .2s ease, box-shadow .2s ease, background .2s ease;
      box-shadow: 0 10px 28px rgba(0,0,0,.25);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      position:relative;
      overflow:hidden;
    }
    .btn::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(300px 80px at 20% 0%, rgba(255,255,255,.28), transparent 55%),
        radial-gradient(280px 90px at 80% 10%, rgba(120,220,255,.22), transparent 55%);
      opacity:.75;
      pointer-events:none;
      transform: translateY(-10px);
    }
    .btn:hover{
      transform: translateY(-1px);
      border-color: rgba(170,230,255,.35);
      box-shadow: 0 16px 38px rgba(0,0,0,.30);
    }
    .btn:active{ transform: translateY(0); }
    .btn.small{ min-width:auto; padding: 11px 14px; border-radius: 16px; font-size: 13px; }
    .btn.ghost{
      background: rgba(0,0,0,.10);
      border-color: rgba(255,255,255,.14);
      box-shadow:none;
    }
    .btn.primary{
      background: linear-gradient(180deg, rgba(120,220,255,.22), rgba(0,140,255,.10));
      border-color: rgba(140,220,255,.28);
    }

    /* --- Landing --- */
    .landingWrap{
      width:min(920px, 94vw);
      text-align:center;
      padding: 30px 22px;
    }
    .bigMIA{
      font-size: clamp(54px, 10vw, 96px);
      font-weight: 950;
      letter-spacing: .22em;
      margin: 0;
      display:inline-block;
      cursor:pointer;
      position:relative;
      text-shadow: 0 0 22px rgba(0,200,255,.25);
      user-select:none;
    }
    .bigMIA::after{
      content:"";
      position:absolute; left:50%; top:100%;
      width: 70%;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(120,220,255,.75), transparent);
      transform: translateX(-50%);
      opacity:.7;
    }
    .subtitle{
      margin: 14px 0 0;
      color: var(--muted);
      font-size: clamp(14px, 2.2vw, 18px);
      letter-spacing:.02em;
    }
    .hint{
      margin-top: 22px;
      color: rgba(230,241,255,.75);
      font-size: 13px;
      opacity:.9;
    }
    .kbd{
      display:inline-block;
      padding: 3px 8px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      margin: 0 6px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
    }

    /* --- Forms --- */
    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 720px){
      .grid{ grid-template-columns: 1fr; }
      .btn{ min-width: 100%; }
    }

    .field{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      border-radius: 18px;
      padding: 12px 12px 10px;
      position:relative;
    }
    .field label{
      display:block;
      font-size: 12px;
      color: rgba(230,241,255,.80);
      margin-bottom: 8px;
      letter-spacing:.02em;
    }
    .field .req{
      color: rgba(180,240,255,.95);
      font-weight:700;
      margin-left: 6px;
      font-size: 11px;
      opacity:.9;
    }
    input, select, textarea{
      width:100%;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--ink);
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 14px;
      outline:none;
      transition: border-color .2s ease, box-shadow .2s ease;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(140,220,255,.32);
      box-shadow: 0 0 0 4px rgba(80,180,255,.10);
    }

    .note{
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 18px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(230,241,255,.85);
      font-size: 13px;
      line-height: 1.35;
    }
    .note strong{ color: rgba(220,250,255,.95); }

    .statusRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-top: 14px;
      flex-wrap:wrap;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      font-size: 12px;
      color: rgba(230,241,255,.86);
      margin-right: 8px;
      margin-bottom: 8px;
    }

    /* --- Output --- */
    .out{
      margin-top: 14px;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.14);
      padding: 14px;
    }
    .out h3{
      margin: 0 0 10px;
      font-size: 15px;
      letter-spacing:.02em;
    }
    .out p, .out li{
      color: rgba(230,241,255,.86);
      line-height: 1.45;
      font-size: 13.5px;
    }
    .out ul{ margin: 8px 0 0 18px; }

    .twoCol{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
      margin-top: 12px;
    }
    @media (max-width: 860px){ .twoCol{ grid-template-columns: 1fr; } }

    .week{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      padding: 12px;
    }
    .week .day{
      padding: 10px 10px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      margin-bottom: 10px;
    }
    .week .day:last-child{ margin-bottom:0; }
    .week .day strong{ display:block; margin-bottom: 6px; letter-spacing:.02em; }

    .statGrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
      margin-top: 10px;
    }
    @media (max-width: 860px){ .statGrid{ grid-template-columns: 1fr; } }
    .stat{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      padding: 10px 12px;
    }
    .stat .k{
      font-size: 12px;
      color: rgba(230,241,255,.72);
      margin-bottom: 6px;
    }
    .stat .v{
      font-size: 14px;
      font-weight: 800;
      letter-spacing:.01em;
    }
    .stat.ok{ background: var(--ok); border-color: rgba(80,255,190,.18); }
    .stat.warn{ background: var(--warn); border-color: rgba(255,220,120,.18); }
    .stat.bad{ background: var(--bad); border-color: rgba(255,120,160,.18); }

    /* --- Chat --- */
    .chatBox{
      height: 320px;
      overflow:auto;
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
    }
    .msg{
      max-width: 92%;
      padding: 10px 12px;
      border-radius: 16px;
      margin: 8px 0;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      line-height: 1.35;
      font-size: 13.5px;
      white-space: pre-wrap;
    }
    .msg.me{
      margin-left:auto;
      background: linear-gradient(180deg, rgba(120,220,255,.16), rgba(255,255,255,.06));
      border-color: rgba(140,220,255,.20);
    }
    .chatRow{
      display:flex; gap:10px; margin-top: 12px;
    }
    .chatRow input{ flex:1; }

    /* --- Floating scroll button (Routine screen) --- */
    .fab{
      position:absolute;
      right: 18px;
      bottom: 18px;
      width: 46px;
      height: 46px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(120,220,255,.18), rgba(255,255,255,.06));
      color: var(--ink);
      cursor:pointer;
      box-shadow: 0 14px 38px rgba(0,0,0,.28);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      display:none;
      align-items:center;
      justify-content:center;
      font-size: 18px;
      user-select:none;
    }

    .footer{
      margin-top: 14px;
      color: rgba(230,241,255,.62);
      font-size: 12px;
      line-height: 1.35;
    }

    .cardInner.scrollable{
      max-height: min(80vh, 720px);
      overflow:auto;
      padding-right: 18px;
    }
    .cardInner.scrollable::-webkit-scrollbar{ width:10px; }
    .cardInner.scrollable::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.12);
      border-radius: 10px;
      border: 2px solid rgba(0,0,0,.2);
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="bg">
      <canvas id="ecg"></canvas>
      <div class="noise"></div>
      <div class="vignette"></div>
    </div>

    <!-- SCREEN 1: Landing -->
    <section class="screen active" id="screen-landing" aria-label="Faqja hyrÃ«se">
      <div class="landingWrap">
        <h1 class="bigMIA" id="miaLogo" title="Kliko pÃ«r tÃ« vazhduar">MIA</h1>
        <div class="subtitle">MjekÃ«t e InteligjencÃ«s Artificiale</div>
        <div class="hint">Kliko mbi <span class="kbd">MIA</span> ose shtyp <span class="kbd">Enter</span>.</div>
      </div>
    </section>

    <!-- SCREEN 2: Main Menu -->
    <section class="screen" id="screen-menu" aria-label="Menuja">
      <div class="card">
        <div class="cardInner">
          <div class="topbar">
            <div class="brand">
              <div class="mia">MIA</div>
              <div class="tag">MjekÃ«t e InteligjencÃ«s Artificiale</div>
            </div>
            <div class="pill" id="profilePill">
              <strong>Profili:</strong> ende pa tÃ« dhÃ«na â€” plotÃ«so â€œVendos tÃ« dhÃ«natâ€
            </div>
          </div>

          <div class="btnRow">
            <button class="btn primary" id="btnData">Vendos tÃ« dhÃ«nat (e detyrueshme)</button>
            <button class="btn" id="btnRoutine">Gjenero RutinÃ«n Personale</button>
            <button class="btn" id="btnAI">Pyet Asistentin AI</button>
          </div>

          <div class="note" style="margin-top:16px;">
            <strong>ShÃ«nim:</strong> Ky projekt Ã«shtÃ« edukativ. Informacioni i gjeneruar nuk Ã«shtÃ« diagnozÃ« dhe nuk zÃ«vendÃ«son mjekun.
          </div>
        </div>
      </div>
    </section>

    <!-- SCREEN 3: Data Form -->
    <section class="screen" id="screen-data" aria-label="Vendos tÃ« dhÃ«nat">
      <div class="card">
        <div class="cardInner">
          <div class="topbar">
            <div class="brand">
              <div class="mia">MIA</div>
              <div class="tag">Vendos tÃ« dhÃ«nat</div>
            </div>
            <button class="btn small ghost" id="backToMenu1">Kthehu</button>
          </div>

          <div class="grid">
            <div class="field">
              <label>Mosha <span class="req">(e detyrueshme)</span></label>
              <input id="age" type="number" min="5" max="120" placeholder="p.sh. 16" />
            </div>

            <div class="field">
              <label>Gjinia <span class="req">(e detyrueshme)</span></label>
              <select id="gender">
                <option value="">Zgjidhâ€¦</option>
                <option value="F">FemÃ«r</option>
                <option value="M">Mashkull</option>
                <option value="X">TjetÃ«r / preferoj tÃ« mos them</option>
              </select>
            </div>

            <div class="field">
              <label>Problemi i zemrÃ«s <span style="opacity:.7">(opsional)</span></label>
              <select id="heartIssue">
                <option value="">â€”</option>
                <option value="tachy">Takikardi / rrahje tÃ« shpejta</option>
                <option value="brady">Bradikardi / rrahje tÃ« ngadalta</option>
                <option value="arr">Aritmi (tÃ« parregullta)</option>
                <option value="bp">Tension i lartÃ« / probleme presioni</option>
                <option value="pain">Dhimbje gjoksi / shqetÃ«sim</option>
                <option value="other">TjetÃ«r</option>
              </select>
            </div>

            <div class="field">
              <label>Emri <span class="req">(e detyrueshme)</span></label>
              <input id="name" type="text" placeholder="p.sh. Ardi" maxlength="32" />
            </div>
          </div>

          <div class="statusRow">
            <div class="chip" id="formStatus">PlotÃ«so fushat e detyrueshme pÃ«r tÃ« aktivizuar kthimin.</div>
            <button class="btn small primary" id="btnReturnFromData" style="display:none;">Kthehu nÃ« faqen kryesore</button>
          </div>

          <div class="footer">
            * Fushat e detyrueshme: Mosha, Gjinia, Emri. â€œProblemi i zemrÃ«sâ€ Ã«shtÃ« opsional.
          </div>
        </div>
      </div>
    </section>

    <!-- SCREEN 4: Routine Generator -->
    <section class="screen" id="screen-routine" aria-label="Gjenero rutinÃ«n">
      <div class="card">
        <div class="cardInner scrollable" id="routineInner">
          <div class="topbar">
            <div class="brand">
              <div class="mia">MIA</div>
              <div class="tag">Rutina personale (edukative)</div>
            </div>
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
              <button class="btn small ghost" id="backToMenu2">Kthehu</button>
              <button class="btn small primary" id="btnHomeFromRoutine">Faqja kryesore</button>
            </div>
          </div>

          <div class="note" id="routineIntro">
            Vendos <strong>BPM</strong> (rrahjet/minutÃ«). MIA do tÃ« krijojÃ« <strong>plan javor tÃ« personalizuar</strong>
            bazuar te mosha, konteksti i matjes dhe (nÃ«se ke zgjedhur) njÃ« shqetÃ«sim.
            <br><br>
            <strong>Kujdes:</strong> NÃ«se BPM Ã«shtÃ« shumÃ« i lartÃ« nÃ« qetÃ«si dhe pÃ«rsÃ«ritet, ose ka simptoma alarmi (dhimbje gjoksi, tÃ« fikÃ«t, gulÃ§im i rÃ«ndÃ«), kÃ«rko ndihmÃ« mjekÃ«sore.
          </div>

          <div class="grid" style="margin-top:12px;">
            <div class="field">
              <label>Rrahjet e zemrÃ«s (BPM) <span class="req">(e detyrueshme)</span></label>
              <input id="bpm" type="number" min="30" max="220" placeholder="p.sh. 92" />
            </div>
            <div class="field">
              <label>Kur u mat? <span style="opacity:.7">(opsional)</span></label>
              <select id="bpmContext">
                <option value="rest">NÃ« qetÃ«si / ulur</option>
                <option value="after">Pas aktiviteti tÃ« lehtÃ«</option>
                <option value="stress">NÃ« stres / ankth</option>
                <option value="unknown">Nuk jam i sigurt</option>
              </select>
            </div>
          </div>

          <div class="statusRow">
            <div class="chip" id="bpmStatus">Vendos BPM pÃ«r tÃ« gjeneruar planin.</div>
            <button class="btn small primary" id="btnGenerate">Gjenero planin</button>
          </div>

          <div class="out" id="output" style="display:none;">
            <h3 id="outTitle">Plani javor</h3>
            <div class="twoCol">
              <div>
                <div id="outSummary"></div>
                <div id="outTips"></div>
              </div>
              <div class="week" id="outWeek"></div>
            </div>

            <div style="margin-top:14px; display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;">
              <button class="btn small ghost" id="backToMenu3">Kthehu</button>
              <button class="btn small primary" id="homeFromOutput">Faqja kryesore</button>
              <button class="btn small ghost" id="scrollTopBtnInline">Shko lart</button>
            </div>
          </div>
        </div>

        <button class="fab" id="routineScrollFab" title="Shko lart/poshtÃ«" aria-label="Shko lart/poshtÃ«">â†•</button>
      </div>
    </section>

    <!-- SCREEN 5: AI Assistant (offline) -->
    <section class="screen" id="screen-ai" aria-label="Asistenti AI">
      <div class="card">
        <div class="cardInner">
          <div class="topbar">
            <div class="brand">
              <div class="mia">MIA</div>
              <div class="tag">Asistenti AI (offline, edukativ)</div>
            </div>
            <button class="btn small ghost" id="backToMenu4">Kthehu</button>
          </div>

          <div class="note">
            Mund tÃ« pyesÃ«sh pÃ«r: <strong>BPM</strong>, matjen e pulsit, <strong>EKG</strong> (Pâ€“QRSâ€“T), aritmi/palpitacione,
            tension, oksimetÃ«r (SpOâ‚‚), kafeinÃ«/energizantÃ«, duhan/vape, stres/ankth, gjumÃ«, ushqim, aktivitet.
            <br><br>
            PÃ«r situata urgjente (dhimbje gjoksi e fortÃ«, tÃ« fikÃ«t, gulÃ§im i rÃ«ndÃ«), kÃ«rko ndihmÃ« mjekÃ«sore.
          </div>

          <div class="chatBox" id="chatBox" aria-live="polite"></div>

          <div class="chatRow">
            <input id="chatInput" type="text" placeholder="Shkruaj pyetjenâ€¦" />
            <button class="btn small primary" id="chatSend">DÃ«rgo</button>
          </div>

          <div class="footer">
            * Asistenti Ã«shtÃ« offline (pa internet, pa API key) dhe jep pÃ«rgjigje tÃ« pÃ«rgjithshme edukative.
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // --------------------
    // Router
    // --------------------
    const screens = {
      landing: document.getElementById("screen-landing"),
      menu: document.getElementById("screen-menu"),
      data: document.getElementById("screen-data"),
      routine: document.getElementById("screen-routine"),
      ai: document.getElementById("screen-ai"),
    };

    function go(to){
      Object.values(screens).forEach(s => s.classList.remove("active"));
      screens[to].classList.add("active");
      setTimeout(() => {
        const focusables = screens[to].querySelectorAll("button, input, select, textarea");
        if (focusables.length) focusables[0].focus({preventScroll:true});
      }, 60);
    }

    // --------------------
    // State
    // --------------------
    const state = {
      profile: { age: null, gender: "", heartIssue: "", name: "" }
    };

    const profilePill = document.getElementById("profilePill");
    function updateProfilePill(){
      const p = state.profile;
      const ok = (p.age && p.gender && p.name);
      if(!ok){
        profilePill.innerHTML = "<strong>Profili:</strong> ende pa tÃ« dhÃ«na â€” plotÃ«so â€œVendos tÃ« dhÃ«natâ€";
        return;
      }
      const issueLabel = ({
        "": "pa problem tÃ« deklaruar",
        "tachy":"takikardi",
        "brady":"bradikardi",
        "arr":"aritmi",
        "bp":"tension i lartÃ«",
        "pain":"shqetÃ«sim/dhimbje gjoksi",
        "other":"tjetÃ«r"
      })[p.heartIssue ?? ""] || "â€”";
      const g = (p.gender==="F" ? "F" : (p.gender==="M" ? "M" : "X"));
      profilePill.innerHTML = `<strong>Profili:</strong> ${escapeHtml(p.name)} Â· ${p.age} vjeÃ§ Â· gjinia ${g} Â· ${issueLabel}`;
    }

    // --------------------
    // Landing
    // --------------------
    const miaLogo = document.getElementById("miaLogo");
    miaLogo.addEventListener("click", () => go("menu"));
    window.addEventListener("keydown", (e) => {
      if(screens.landing.classList.contains("active") && e.key === "Enter") go("menu");
    });

    // --------------------
    // Menu buttons
    // --------------------
    document.getElementById("btnData").addEventListener("click", () => go("data"));
    document.getElementById("btnRoutine").addEventListener("click", () => {
      const p = state.profile;
      if(!(p.age && p.gender && p.name)){
        go("data");
        flash(document.getElementById("formStatus"), "Duhet tÃ« plotÃ«sosh fillimisht Mosha, Gjinia, Emri.", 2200);
        return;
      }
      go("routine");
      setTimeout(() => document.getElementById("routineInner").scrollTo({top:0, behavior:"instant"}), 40);
      setTimeout(updateRoutineFab, 120);
    });
    document.getElementById("btnAI").addEventListener("click", () => {
      go("ai");
      bootChat();
      setTimeout(() => document.getElementById("chatInput").focus(), 120);
    });

    // --------------------
    // Data form
    // --------------------
    const ageEl = document.getElementById("age");
    const genderEl = document.getElementById("gender");
    const heartIssueEl = document.getElementById("heartIssue");
    const nameEl = document.getElementById("name");
    const formStatus = document.getElementById("formStatus");
    const btnReturnFromData = document.getElementById("btnReturnFromData");

    function validateProfile(){
      const age = parseInt(ageEl.value, 10);
      const gender = genderEl.value;
      const name = nameEl.value.trim();

      const ageOk = Number.isFinite(age) && age >= 5 && age <= 120;
      const genderOk = !!gender;
      const nameOk = name.length >= 2;

      const ok = ageOk && genderOk && nameOk;

      if(ok){
        formStatus.textContent = "Gati âœ… Tani mund tÃ« kthehesh nÃ« faqen kryesore.";
        btnReturnFromData.style.display = "inline-flex";
      } else {
        const missing = [];
        if(!ageOk) missing.push("Mosha (5â€“120)");
        if(!genderOk) missing.push("Gjinia");
        if(!nameOk) missing.push("Emri (min 2 shkronja)");
        formStatus.textContent = "PlotÃ«so: " + missing.join(" Â· ");
        btnReturnFromData.style.display = "none";
      }
      return ok;
    }

    function saveProfile(){
      state.profile.age = parseInt(ageEl.value, 10);
      state.profile.gender = genderEl.value;
      state.profile.heartIssue = heartIssueEl.value;
      state.profile.name = nameEl.value.trim();
      updateProfilePill();
    }

    [ageEl, genderEl, heartIssueEl, nameEl].forEach(el => {
      el.addEventListener("input", validateProfile);
      el.addEventListener("change", validateProfile);
    });

    btnReturnFromData.addEventListener("click", () => {
      if(validateProfile()){
        saveProfile();
        go("menu");
      }
    });

    document.getElementById("backToMenu1").addEventListener("click", () => go("menu"));

    // --------------------
    // Routine UI: buttons + scroll
    // --------------------
    document.getElementById("backToMenu2").addEventListener("click", () => go("menu"));
    document.getElementById("backToMenu3").addEventListener("click", () => go("menu"));
    document.getElementById("btnHomeFromRoutine").addEventListener("click", () => go("menu"));
    document.getElementById("homeFromOutput").addEventListener("click", () => go("menu"));

    const routineInner = document.getElementById("routineInner");
    const routineFab = document.getElementById("routineScrollFab");
    const scrollTopBtnInline = document.getElementById("scrollTopBtnInline");

    function updateRoutineFab(){
      const canScroll = routineInner.scrollHeight - routineInner.clientHeight > 40;
      routineFab.style.display = canScroll ? "inline-flex" : "none";
    }
    function routineScrollToggle(){
      const nearTop = routineInner.scrollTop < 60;
      routineInner.scrollTo({ top: nearTop ? routineInner.scrollHeight : 0, behavior:"smooth" });
    }
    routineFab.addEventListener("click", routineScrollToggle);
    scrollTopBtnInline.addEventListener("click", () => routineInner.scrollTo({top:0, behavior:"smooth"}));
    routineInner.addEventListener("scroll", () => {
      const nearTop = routineInner.scrollTop < 60;
      routineFab.textContent = nearTop ? "â†“" : "â†‘";
    });

    // --------------------
    // Routine generator (PERSONALIZED + realistic ranges)
    // --------------------
    const bpmEl = document.getElementById("bpm");
    const bpmContextEl = document.getElementById("bpmContext");
    const bpmStatus = document.getElementById("bpmStatus");
    const btnGenerate = document.getElementById("btnGenerate");
    const output = document.getElementById("output");
    const outTitle = document.getElementById("outTitle");
    const outSummary = document.getElementById("outSummary");
    const outTips = document.getElementById("outTips");
    const outWeek = document.getElementById("outWeek");

    function bpmOk(){
      const bpm = parseInt(bpmEl.value, 10);
      const ok = Number.isFinite(bpm) && bpm >= 30 && bpm <= 220;
      bpmStatus.textContent = ok ? "BPM i vlefshÃ«m âœ…" : "Vendos BPM (30â€“220).";
      return ok;
    }
    bpmEl.addEventListener("input", bpmOk);

    btnGenerate.addEventListener("click", () => {
      const p = state.profile;
      if(!(p.age && p.gender && p.name)){
        go("data");
        flash(formStatus, "PlotÃ«so tÃ« dhÃ«nat e detyrueshme pÃ«rpara rutinÃ«s.", 2200);
        return;
      }
      if(!bpmOk()){
        flash(bpmStatus, "BPM nuk Ã«shtÃ« i vlefshÃ«m. Provoni 30â€“220.", 2000);
        return;
      }
      const bpm = parseInt(bpmEl.value, 10);
      const ctx = bpmContextEl.value;
      const plan = buildPersonalPlan(p, bpm, ctx);
      renderPlan(p, bpm, ctx, plan);
      output.style.display = "block";

      setTimeout(() => {
        const y = output.offsetTop - 10;
        routineInner.scrollTo({ top: y, behavior:"smooth" });
        setTimeout(updateRoutineFab, 200);
      }, 80);
    });

    function ageGroup(age){
      if(age >= 12 && age <= 19) return "teen";
      if(age >= 20 && age <= 39) return "young";
      if(age >= 40 && age <= 59) return "adult";
      return "senior";
    }

    function bpmBand(bpm){
      // educational banding (not diagnostic)
      if(bpm < 50) return "veryLow";
      if(bpm < 60) return "low";
      if(bpm <= 84) return "typical";
      if(bpm <= 100) return "highTypical";
      if(bpm <= 120) return "high";
      return "veryHigh";
    }

    function ctxLabel(ctx){
      return ({
        rest: "NÃ« qetÃ«si",
        after: "Pas aktiviteti tÃ« lehtÃ«",
        stress: "NÃ« stres/ankth",
        unknown: "Kontekst i panjohur"
      })[ctx] || "â€”";
    }

    function issueLabel(issue){
      return ({
        "": "Pa problem tÃ« deklaruar",
        "tachy":"Takikardi / rrahje tÃ« shpejta",
        "brady":"Bradikardi / rrahje tÃ« ngadalta",
        "arr":"Aritmi (tÃ« parregullta)",
        "bp":"Tension i lartÃ« / probleme presioni",
        "pain":"Dhimbje gjoksi / shqetÃ«sim",
        "other":"TjetÃ«r"
      })[issue ?? ""] || "â€”";
    }

    function buildPersonalPlan(profile, bpm, ctx){
      const ag = ageGroup(profile.age);
      const band = bpmBand(bpm);
      const issue = profile.heartIssue || "";

      // Realistic sleep targets as ranges (and explained as "average", not perfect daily)
      const sleepRange = (ag === "teen") ? "8â€“10 orÃ« (syno mesatare javore)"
                        : (ag === "senior") ? "7â€“8 orÃ« (syno mesatare javore)"
                        : "7â€“9 orÃ« (syno mesatare javore)";

      // Hydration as range (not strict medical)
      let waterRange = (ag === "teen") ? "1.6â€“2.3 L/ditÃ«"
                    : (ag === "senior") ? "1.5â€“2.1 L/ditÃ«"
                    : "1.8â€“2.5 L/ditÃ«";
      if(ctx === "after") waterRange = bumpWater(waterRange);
      if(band === "high" || band === "veryHigh") waterRange = bumpWater(waterRange);

      // Intensity suggestion by context + bpm band
      const intensity = pickIntensity(band, ctx, issue);

      // Priority focus (what this week should optimize)
      const focus = computeFocus(band, ctx, issue);

      // Monitoring suggestion (how to re-check)
      const monitoring = computeMonitoring(band, ctx, issue);

      // Red flags / caution list
      const cautions = computeCautions(band, ctx, issue);

      // Daily routine template personalized
      const daily = buildDailyRoutine(band, ctx, issue, intensity);

      // Weekly plan personalized
      const weekly = buildWeeklyPlan(ag, band, ctx, issue, intensity);

      // â€œBPM interpretationâ€ short summary (educational)
      const interpretation = interpretBpm(bpm, band, ctx, ag);

      // Status classes for stat cards
      const riskClass = (band === "veryHigh" || (band === "high" && ctx === "rest") || issue === "pain") ? "bad"
                      : (band === "high" || band === "highTypical") ? "warn"
                      : "ok";

      return {
        meta: { ag, band, issue, riskClass },
        sleepRange,
        waterRange,
        intensity,
        focus,
        monitoring,
        cautions,
        daily,
        weekly,
        interpretation
      };
    }

    function bumpWater(rangeStr){
      // simple bump: add +0.2L to both ends if parseable
      const m = rangeStr.match(/(\d+(\.\d+)?)â€“(\d+(\.\d+)?)/);
      if(!m) return rangeStr;
      const a = (parseFloat(m[1]) + 0.2).toFixed(1);
      const b = (parseFloat(m[3]) + 0.2).toFixed(1);
      return `${a}â€“${b} L/ditÃ«`;
    }

    function pickIntensity(band, ctx, issue){
      // educational & conservative
      if(issue === "pain") return "ShumÃ« e lehtÃ« (prioritet siguria)";
      if(band === "veryHigh" && ctx === "rest") return "ShumÃ« e lehtÃ« (monitorim + qetÃ«sim)";
      if(band === "high" && ctx === "rest") return "E lehtÃ«â€“moderuar (pa e tepruar)";
      if(band === "veryHigh" && ctx !== "rest") return "E lehtÃ« (rikthim nÃ« qetÃ«si, mos e tepro)";
      if(band === "high") return "E lehtÃ«â€“moderuar";
      if(band === "highTypical") return "Moderuar";
      if(band === "veryLow") return "E lehtÃ«â€“moderuar (me ngrohje tÃ« gjatÃ«)";
      if(band === "low") return "Moderuar (me ngrohje)";
      return "Moderuar";
    }

    function computeFocus(band, ctx, issue){
      const arr = [];
      if(ctx === "stress") arr.push("Menaxhim stresi (frymÃ«marrje + pauza)");
      if(ctx === "after") arr.push("Rikuperim & hidratim pas aktivitetit");
      if(band === "high" || band === "veryHigh") arr.push("Stabilizim pulsi (kafeinÃ« â†“, ujÃ« â†‘, gjumÃ« i rregullt)");
      if(band === "veryLow" || band === "low") arr.push("Aktivizim gradual (ngrohje + ecje e kontrolluar)");
      if(issue === "arr") arr.push("VÃ«zhgim i palpitacioneve + shmang stimuluesit");
      if(issue === "bp") arr.push("MÃ« pak kripÃ« + ecje e rregullt");
      if(!arr.length) arr.push("KonsistencÃ«: ecje, gjumÃ«, ujÃ«");
      return arr;
    }

    function computeMonitoring(band, ctx, issue){
      const m = [];
      m.push("Mat pulsin nÃ« qetÃ«si (pas 5 min ulur), 1â€“2 herÃ«/ditÃ« pÃ«r 3 ditÃ« dhe mbaj shÃ«nim.");
      if(ctx !== "rest") m.push("NÃ«se matja ishte jo nÃ« qetÃ«si, pÃ«rsÃ«rite matjen edhe nÃ« qetÃ«si pÃ«r krahasim.");
      if(band === "high" || band === "veryHigh") m.push("Shmang kafeinÃ«/energizantÃ« pÃ«r 24â€“48 orÃ« dhe shiko nÃ«se BPM ulet.");
      if(issue === "arr") m.push("NÃ«se ndjen rrahje tÃ« parregullta, shÃ«no: sa zgjati, Ã§farÃ« po bÃ«je, dhe a pati marramendje/gulÃ§im.");
      if(band === "veryLow") m.push("NÃ«se je sportist, mund tÃ« jetÃ« normale; nÃ«se ke lodhje/tÃ« fikÃ«t, kÃ«rko kontroll mjekÃ«sor.");
      return m;
    }

    function computeCautions(band, ctx, issue){
      const c = [];
      if(issue === "pain") c.push("Dhimbja e gjoksit: nÃ«se Ã«shtÃ« e fortÃ«, me gulÃ§im, djersÃ« tÃ« ftohta, marramendje ose tÃ« fikÃ«t â€” urgjencÃ«.");
      if((band === "veryHigh" || band === "high") && ctx === "rest") c.push("BPM i lartÃ« nÃ« qetÃ«si qÃ« pÃ«rsÃ«ritet Ã«shtÃ« arsye e mirÃ« pÃ«r kontroll mjekÃ«sor.");
      if(band === "veryHigh") c.push("NÃ«se BPM Ã«shtÃ« >120 dhe nuk zbret me qetÃ«si/hidratim, kÃ«rko vlerÃ«sim mjekÃ«sor.");
      if(issue === "arr") c.push("Aritmi + marramendje/tÃ« fikÃ«t/gulÃ§im: kÃ«rko ndihmÃ« mjekÃ«sore.");
      return c;
    }

    function buildDailyRoutine(band, ctx, issue, intensity){
      // time blocks, but actions vary by band/context/issue
      const baseBreath = "FrymÃ«marrje 4-4-6 pÃ«r 3â€“5 min";
      const caffeineRule = (band === "high" || band === "veryHigh" || ctx === "stress" || issue === "arr")
        ? "Kufizo kafeinÃ«/energizantÃ« sot"
        : "KafeinÃ« me masÃ« (nÃ«se pÃ«rdor)";

      const activityBlock = (issue === "pain")
        ? "Aktivitet: vetÃ«m ecje e qetÃ« 10â€“15 min (nÃ«se je mirÃ«) + pushim"
        : (band === "veryHigh" && ctx === "rest")
          ? "Aktivitet: ecje shumÃ« e lehtÃ« 10â€“15 min ose pushim aktiv (shtrirje)"
          : (band === "high" && ctx === "rest")
            ? "Aktivitet: ecje e lehtÃ« 15â€“25 min (pa vrap/sprint)"
            : (band === "veryLow")
              ? "Aktivitet: ecje 20 min + ngrohje e gjatÃ« 8â€“10 min"
              : "Aktivitet: ecje 20â€“30 min (ritÃ«m i moderuar)";

      const hydration = (ctx === "after" || band === "high" || band === "veryHigh")
        ? "UjÃ«: shpÃ«rndaje gjatÃ« ditÃ«s + 1 gotÃ« pas aktivitetit"
        : "UjÃ«: shpÃ«rndaje gjatÃ« ditÃ«s";

      const meals = (issue === "bp")
        ? "Ushqim: mÃ« pak kripÃ«, mÃ« shumÃ« perime + burim proteine"
        : "Ushqim: pjatÃ« e balancuar (perime + proteinÃ« + karbo tÃ« plota)";

      return [
        {t:"08:00", a:"UjÃ« 1 gotÃ« + mÃ«ngjes i lehtÃ« (drithÃ«ra tÃ« plota/fruta/kos)"},
        {t:"11:00", a:`${baseBreath} + pauzÃ« nga ekrani 2â€“3 min`},
        {t:"14:00", a:`${meals} + ujÃ«`},
        {t:"17:00", a:`${activityBlock} Â· Intensitet: ${intensity}`},
        {t:"20:30", a:`Shtrirje 6â€“10 min + ${caffeineRule} + ekranet ulur 30 min para gjumit`},
        {t:"Para gjumit", a:`Mat pulsin nÃ« qetÃ«si (opsionale) dhe shÃ«no si u ndjeve (energji/stres)`},
        {t:"GjithÃ« ditÃ«n", a: hydration},
      ];
    }

    function buildWeeklyPlan(ag, band, ctx, issue, intensity){
      // Personalized weekly structure:
      // - Always: 1â€“2 "recovery" days
      // - Adjust volume for high/high in rest or pain
      const days = ["E HÃ«nÃ«","E MartÃ«","E MÃ«rkurÃ«","E Enjte","E Premte","E ShtunÃ«","E Diel"];

      const baseCardio = (ag === "teen") ? "20â€“35 min"
                      : (ag === "senior") ? "15â€“30 min"
                      : "20â€“40 min";
      const baseStrength = (ag === "teen") ? "15â€“20 min (peshÃ« trupi)"
                        : (ag === "senior") ? "10â€“15 min (shumÃ« e lehtÃ«)"
                        : "15â€“25 min (peshÃ« trupi)";

      let cardio = baseCardio;
      let strength = baseStrength;
      let breath = "3â€“5 min frymÃ«marrje";
      let screenBreaks = "Pauza nga ekrani 2â€“3 herÃ«/ditÃ«";

      if(issue === "pain"){
        cardio = "10â€“15 min ecje e qetÃ« (vetÃ«m nÃ«se je mirÃ«)";
        strength = "â€” (mos e detyro)";
        breath = "5 min frymÃ«marrje + qetÃ«sim";
        screenBreaks = "Pauza tÃ« shpeshta + qetÃ«si";
      } else if((band === "high" || band === "veryHigh") && ctx === "rest"){
        cardio = "15â€“25 min ecje e lehtÃ« (pa sprint)";
        strength = "10â€“15 min shumÃ« e lehtÃ«";
        breath = "5 min frymÃ«marrje Ã§do ditÃ«";
      } else if(band === "veryHigh"){
        cardio = "15â€“25 min ecje e lehtÃ«";
        strength = "10â€“15 min e lehtÃ«";
      } else if(band === "veryLow"){
        cardio = "20â€“30 min ecje + ngrohje e gjatÃ«";
      }

      const saltTip = (issue === "bp") ? "KripÃ« â†“ (shmang ushqimet shumÃ« tÃ« pÃ«rpunuara)" : "Ushqim i balancuar";
      const stimulantTip = (band === "high" || band === "veryHigh" || ctx === "stress" || issue === "arr")
        ? "KafeinÃ«/energizantÃ« â†“"
        : "KafeinÃ« me masÃ«";

      // template per day, but varied across the week
      const plan = [];

      // pattern: cardio (Mon, Wed, Fri, Sat), strength (Tue, Thu), recovery (Sun)
      for(let i=0;i<7;i++){
        const d = days[i];
        const items = [];

        // Always include one "core anchor"
        items.push(`${breath}`);
        items.push(`${screenBreaks}`);

        const isStrengthDay = (d === "E MartÃ«" || d === "E Enjte");
        const isLongerCardio = (d === "E ShtunÃ«");
        const isRecovery = (d === "E Diel");

        if(issue === "pain"){
          if(isRecovery){
            items.unshift("Prioritet: qetÃ«si + monitorim simptomash");
            items.push("NÃ«se ka dhimbje tÃ« fortÃ«/urgjente: kÃ«rko ndihmÃ« mjekÃ«sore");
          } else {
            items.unshift(`Ecje e qetÃ« ${cardio}`);
            items.push("ShÃ«nim: si u ndjeve (dhimbje/gulÃ§im/marramendje)");
          }
        } else if(isRecovery){
          items.unshift("DitÃ« rikuperimi: ecje shumÃ« e lehtÃ« 10â€“20 min ose shÃ«titje");
          items.push("Planifikim i javÃ«s + orar gjumi mÃ« i rregullt");
        } else if(isStrengthDay){
          items.unshift(`Ushtrime tÃ« lehta: ${strength} (pa e tepruar)`);
          items.push("Shtrirje 6â€“10 min");
        } else {
          let cmin = cardio;
          if(isLongerCardio && (band !== "high" && band !== "veryHigh")) cmin = (ag === "teen") ? "30â€“45 min" : "30â€“50 min";
          items.unshift(`Ecje/kardio: ${cmin} Â· Intensitet: ${intensity}`);
          items.push("Shtrirje 6â€“10 min");
        }

        // add heart-issue specific item
        if(issue === "arr") items.push("Shmang stimuluesit (kafeinÃ«/energizantÃ«) dhe mbaj shÃ«nim palpitacionet");
        if(issue === "bp") items.push(`${saltTip} + ecje e rregullt`);
        if((band === "high" || band === "veryHigh") && ctx === "rest") items.push("Mat pulsin nÃ« qetÃ«si 1 herÃ«/ditÃ« pÃ«r 3 ditÃ« (shÃ«nime)");

        // always include hydration + nutrition anchor
        items.push(`Hidratim: shpÃ«rndaje ujin gjatÃ« ditÃ«s Â· ${stimulantTip}`);

        plan.push({ d, items });
      }

      return plan;
    }

    function interpretBpm(bpm, band, ctx, ag){
      const base = [];
      base.push(`BPM i vendosur: ${bpm}.`);
      base.push(`Konteksti: ${ctxLabel(ctx)}.`);
      if(ctx !== "rest"){
        base.push("ShÃ«nim: jashtÃ« qetÃ«sisÃ« BPM rritet natyrshÃ«m; vlera krahasohet mÃ« mirÃ« kur matet nÃ« qetÃ«si.");
      }
      // Educational interpretation
      if(band === "veryHigh"){
        base.push("Kjo Ã«shtÃ« e lartÃ«. NÃ«se Ã«shtÃ« nÃ« qetÃ«si dhe pÃ«rsÃ«ritet, Ã«shtÃ« arsye e mirÃ« pÃ«r kontroll mjekÃ«sor.");
      } else if(band === "high" && ctx === "rest"){
        base.push("Kjo Ã«shtÃ« e lartÃ« pÃ«r matje nÃ« qetÃ«si. Provo qetÃ«si + ujÃ« + frymÃ«marrje dhe mat sÃ«rish.");
      } else if(band === "high"){
        base.push("Kjo Ã«shtÃ« e lartÃ«, por konteksti mund ta shpjegojÃ«. Mat sÃ«rish nÃ« qetÃ«si pÃ«r krahasim.");
      } else if(band === "veryLow"){
        base.push("Kjo Ã«shtÃ« e ulÃ«t. Te sportistÃ«t mund tÃ« jetÃ« normale; nÃ«se ka lodhje/tÃ« fikÃ«t, konsultohu.");
      } else if(band === "low"){
        base.push("Kjo Ã«shtÃ« pak e ulÃ«t. VlerÃ«soje bashkÃ« me simptomat dhe aktivitetin fizik.");
      } else {
        base.push("Kjo Ã«shtÃ« brenda njÃ« zone tipike edukative pÃ«r shumÃ« persona (varet nga individi).");
      }

      if(ag === "teen") base.push("Te adoleshentÃ«t ndikojnÃ« shumÃ«: gjumi, stresi, kafeina/energizantÃ«t dhe nikotina.");
      return base.join(" ");
    }

    function renderPlan(profile, bpm, ctx, plan){
      outTitle.textContent = `Plani i personalizuar pÃ«r ${profile.name}`;

      const issueTxt = issueLabel(profile.heartIssue || "");
      const bandTxt = ({
        veryLow: "shumÃ« i ulÃ«t",
        low: "i ulÃ«t",
        typical: "tipik",
        highTypical: "pak i lartÃ«",
        high: "i lartÃ«",
        veryHigh: "shumÃ« i lartÃ«"
      })[plan.meta.band] || "â€”";

      const bandClass = plan.meta.riskClass;

      // SUMMARY block (same structure, but now fully personalized)
      outSummary.innerHTML = `
        <div class="note" style="margin-top:0;">
          <strong>Profili:</strong> ${escapeHtml(profile.name)}, ${profile.age} vjeÃ§ Â· <strong>ShqetÃ«sim:</strong> ${escapeHtml(issueTxt)}<br>
          <strong>Interpretim edukativ:</strong> ${escapeHtml(plan.interpretation)}
          <div class="statGrid">
            <div class="stat ${bandClass}">
              <div class="k">BPM (kategorim edukativ)</div>
              <div class="v">${bpm} Â· ${bandTxt}</div>
            </div>
            <div class="stat ok">
              <div class="k">GjumÃ« i synuar</div>
              <div class="v">${escapeHtml(plan.sleepRange)}</div>
            </div>
            <div class="stat warn">
              <div class="k">Hidratim i synuar</div>
              <div class="v">${escapeHtml(plan.waterRange)}</div>
            </div>
          </div>
        </div>
      `;

      const focusList = plan.focus.map(x => `<li>${escapeHtml(x)}</li>`).join("");
      const monitorList = plan.monitoring.map(x => `<li>${escapeHtml(x)}</li>`).join("");

      const cautionBlock = plan.cautions.length ? `
        <div class="note" style="background: var(--bad); border-color: rgba(255,120,160,.22);">
          <strong>Kujdes (sinjale alarmi):</strong>
          <ul>${plan.cautions.map(x => `<li>${escapeHtml(x)}</li>`).join("")}</ul>
        </div>
      ` : "";

      const dailyList = plan.daily.map(x => `<li><strong>${escapeHtml(x.t)}</strong> â€” ${escapeHtml(x.a)}</li>`).join("");

      outTips.innerHTML = `
        <div class="out" style="margin-top:12px;">
          <h3>Fokus i javÃ«s</h3>
          <ul>${focusList}</ul>
        </div>

        <div class="out" style="margin-top:12px;">
          <h3>Rutina ditore (shembull i personalizuar)</h3>
          <ul>${dailyList}</ul>
          <p style="margin-top:10px; color: rgba(230,241,255,.72);">
            * GjumÃ«/hidratim janÃ« objektiva realistÃ« si <strong>mesatare javore</strong> â€” nuk dalin perfekt Ã§do ditÃ«.
          </p>
        </div>

        <div class="out" style="margin-top:12px;">
          <h3>Monitorim i thjeshtÃ« (i sigurt, edukativ)</h3>
          <ul>${monitorList}</ul>
        </div>

        ${cautionBlock}
      `;

      // WEEKLY plan (specific per day)
      outWeek.innerHTML = plan.weekly.map(d => `
        <div class="day">
          <strong>${escapeHtml(d.d)}</strong>
          <ul style="margin:0 0 0 18px;">
            ${d.items.map(it => `<li>${escapeHtml(it)}</li>`).join("")}
          </ul>
        </div>
      `).join("");
    }

    // --------------------
    // AI Assistant (offline) - unchanged core, still rich
    // --------------------
    const chatBox = document.getElementById("chatBox");
    const chatInput = document.getElementById("chatInput");
    const chatSend = document.getElementById("chatSend");
    document.getElementById("backToMenu4").addEventListener("click", () => go("menu"));

    function addMsg(text, who="bot"){
      const div = document.createElement("div");
      div.className = "msg" + (who==="me" ? " me" : "");
      div.textContent = text;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function bootChat(){
      chatBox.innerHTML = "";
      addMsg("PÃ«rshÃ«ndetje! UnÃ« jam MIA (offline). MÃ« pyet pÃ«r BPM, matjen e pulsit, EKG (Pâ€“QRSâ€“T), aritmi/palpitacione, tension, oksimetÃ«r (SpOâ‚‚), kafeinÃ«/energizantÃ«, duhan/vape, stres/ankth, gjumÃ«, ushqim, aktivitet.");
      const p = state.profile;
      if(p.age && p.gender && p.name){
        addMsg(`E shoh qÃ« profili yt Ã«shtÃ«: ${p.name}, ${p.age} vjeÃ§. Pyet sa tÃ« duash. (KÃ«shilla edukative)`);
      } else {
        addMsg("NÃ«se do pÃ«rgjigje mÃ« tÃ« pÃ«rshtatura, plotÃ«so mÃ« parÃ« â€œVendos tÃ« dhÃ«natâ€.");
      }
      addMsg("Mund tÃ« mÃ« thuash: â€œKam 105 BPM nÃ« qetÃ«siâ€, â€œSi je?â€, â€œÃ‡farÃ« do tÃ« thotÃ« QRS?â€, â€œSi ta mas pulsin saktÃ«?â€");
    }

    function answer(q){
      const p = state.profile;
      const raw = (q ?? "").trim();
      const text = raw.toLowerCase();

      const hasAny = (...keys) => keys.some(k => text.includes(k));
      const extractNumber = () => {
        const m = text.match(/(\d{2,3})/);
        return m ? parseInt(m[1], 10) : null;
      };
      const profileHint = (p.age && p.gender && p.name)
        ? ` (Bazuar te profili: ${p.name}, ${p.age} vjeÃ§)`
        : "";

      const t = text.replace(/[?!.,;:()]/g," ").replace(/\s+/g," ").trim();

      if(t === "si je" || hasAny("si je", "si jeni")){
        return "Jam mirÃ«, faleminderit qÃ« pyete ğŸ˜Š Jam kÃ«tu dhe gati tÃ« tÃ« ndihmoj. Ã‡farÃ« do tÃ« dish sot pÃ«r zemrÃ«n/pulsin?";
      }
      if(hasAny("faleminderit","rrofsh","thanks","thank you")){
        return "Me kÃ«naqÃ«si! NÃ«se do, mÃ« thuaj BPM-in (dhe nÃ«se ishte nÃ« qetÃ«si apo pas aktiviteti) dhe ta shpjegoj si informacion edukativ.";
      }
      if(hasAny("pÃ«rshÃ«ndetje","pershendetje","hello","hi","tung")){
        return "PÃ«rshÃ«ndetje! MÃ« pyet Ã§â€™tÃ« duash pÃ«r BPM, matjen e pulsit, EKG-nÃ«, aritmitÃ«, ose zakone tÃ« mira pÃ«r zemrÃ«n.";
      }
      if(hasAny("kush je","cfare je","Ã§farÃ« je")){
        return "UnÃ« jam MIA (offline) â€” asistent edukativ pÃ«r zemrÃ«n dhe shÃ«ndetin kardiovaskular. Nuk bÃ«j diagnozÃ«, por shpjegoj koncepte dhe hapa praktikÃ«.";
      }

      // red flags
      if(hasAny("dhimbje gjoksi","dhimbje ne gjoks","shtrengim gjoksi","shqetesim gjoksi")){
        return "Dhimbja e gjoksit mund tÃ« jetÃ« serioze. NÃ«se Ã«shtÃ« e fortÃ«, zgjat >10 minuta, shoqÃ«rohet me gulÃ§im, djersÃ« tÃ« ftohta, tÃ« pÃ«rziera, marramendje ose pÃ«rhapet nÃ« krah/qafÃ«/nofull â€” kÃ«rko ndihmÃ« mjekÃ«sore menjÃ«herÃ« (urgjencÃ«).";
      }
      if(hasAny("tÃ« fikÃ«t","te fiket","humbje vetedije","humbje ndjenje")){
        return "TÃ« fikÃ«t/humbja e ndjenjÃ«s nuk duhet injoruar. Ulu/shtrihu, mos ngis makinÃ«n dhe kontakto mjekun/urgjencÃ«n, sidomos nÃ«se pÃ«rsÃ«ritet.";
      }
      if(hasAny("gulÃ§im","veshtiresi ne frymemarrje","nuk marr fryme","s'marr dot fryme")){
        return "GulÃ§imi i papritur ose i rÃ«ndÃ«, sidomos me dhimbje gjoksi, Ã«shtÃ« sinjal alarmi. KÃ«rko ndihmÃ« mjekÃ«sore menjÃ«herÃ«.";
      }

      const bpm = extractNumber();
      if((hasAny("bpm","puls","rrahje") || text.includes("kam")) && bpm !== null){
        return [
          `NÃ«se BPM = ${bpm}, konteksti i matjes Ã«shtÃ« shumÃ« i rÃ«ndÃ«sishÃ«m.${profileHint}`,
          "Sugjerim: ulu 5 minuta, pi ujÃ«, bÃ«j frymÃ«marrje 4-4-6 pÃ«r 3â€“5 minuta dhe mat sÃ«rish nÃ« qetÃ«si.",
          "NÃ«se BPM Ã«shtÃ« i lartÃ« nÃ« qetÃ«si dhe pÃ«rsÃ«ritet, ose ka simptoma (dhimbje gjoksi, tÃ« fikÃ«t, gulÃ§im), kÃ«rko kontroll mjekÃ«sor."
        ].join("\n");
      }

      if(hasAny("ekg","ecg","p-qrs-t","p qrs t","qrs","t vale","valet")){
        return [
          "EKG/ECG Ã«shtÃ« regjistrimi elektrik i zemrÃ«s.",
          "â€¢ P-valÃ«: aktivizimi i atriumeve",
          "â€¢ QRS: aktivizimi i ventrikujve",
          "â€¢ T-valÃ«: rikthimi/relaksimi i ventrikujve",
          "MjekÃ«t shohin ritmin, shpejtÃ«sinÃ« dhe intervalet (p.sh. PR, QT) pÃ«r tÃ« kuptuar nÃ«se ka aritmi ose shenja stresi."
        ].join("\n");
      }

      if(hasAny("si ta mat","si mas","si matet pulsi","si mat pulsin")){
        return [
          "Si ta matÃ«sh pulsin (mÃ« saktÃ«):",
          "1) Ulu qetÃ« 5 minuta.",
          "2) Vendos 2 gishta te kyÃ§i i dorÃ«s (ana e gishtit tÃ« madh).",
          "3) NumÃ«ro 30 sekonda Ã—2 (ose 60 sekonda).",
          "4) PÃ«rsÃ«rite 2 herÃ« dhe merr mesataren.",
          "5) ShÃ«no kontekstin: qetÃ«si / pas aktiviteti / stres."
        ].join("\n");
      }

      return "E kuptova. Po kÃ«rkon diÃ§ka pÃ«r BPM, EKG, aritmi, tension, oksimetÃ«r (SpOâ‚‚), apo zakone (gjumÃ«, stres, kafeinÃ«, aktivitet)?";
    }

    function sendChat(){
      const q = chatInput.value.trim();
      if(!q) return;
      addMsg(q, "me");
      chatInput.value = "";
      setTimeout(() => addMsg(answer(q), "bot"), 180);
    }
    chatSend.addEventListener("click", sendChat);
    chatInput.addEventListener("keydown", (e) => { if(e.key === "Enter") sendChat(); });

    // --------------------
    // Helpers
    // --------------------
    function flash(el, text, ms=1800){
      const prev = el.textContent;
      el.textContent = text;
      el.style.borderColor = "rgba(255,220,140,.28)";
      el.style.background = "rgba(255,220,140,.10)";
      setTimeout(() => {
        el.textContent = prev;
        el.style.borderColor = "";
        el.style.background = "";
      }, ms);
    }

    function escapeHtml(str){
      return (str ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // --------------------
    // ECG canvas animation
    // --------------------
    const canvas = document.getElementById("ecg");
    const ctx = canvas.getContext("2d");
    let W=0, H=0, tt=0;

    function resize(){
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      W = canvas.clientWidth;
      H = canvas.clientHeight;
      canvas.width = Math.floor(W*dpr);
      canvas.height = Math.floor(H*dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    window.addEventListener("resize", resize);
    resize();

    function draw(){
      tt += 0.016;

      ctx.fillStyle = "rgba(0,0,0,0.18)";
      ctx.fillRect(0,0,W,H);

      ctx.save();
      ctx.globalAlpha = 0.10;
      ctx.strokeStyle = "rgba(120,220,255,0.35)";
      ctx.lineWidth = 1;
      const step = 42;
      for(let x=0; x<W; x+=step){
        ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke();
      }
      for(let y=0; y<H; y+=step){
        ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke();
      }
      ctx.restore();

      const mid = H*0.52;
      const amp = Math.min(64, H*0.10);

      ctx.save();
      ctx.lineWidth = 2.2;
      ctx.strokeStyle = "rgba(140,220,255,0.95)";
      ctx.shadowColor = "rgba(0,190,255,0.35)";
      ctx.shadowBlur = 18;

      ctx.beginPath();
      const speed = 220;
      const phase = (tt*speed) % W;

      for(let x=0; x<=W; x++){
        const u = ((x + phase) % 260) / 260;
        let y = 0;

        y += Math.sin((x*0.014) + tt*1.6) * (amp*0.08);

        if(u > 0.30 && u < 0.34) y += -amp*0.20;
        if(u >= 0.34 && u < 0.36) y +=  amp*0.55;
        if(u >= 0.36 && u < 0.40) y += -amp*1.00;
        if(u >= 0.40 && u < 0.44) y +=  amp*0.30;
        if(u >= 0.44 && u < 0.52) y +=  Math.sin((u-0.44)*Math.PI*6) * (amp*0.10);

        const yy = mid + y;
        if(x===0) ctx.moveTo(x, yy);
        else ctx.lineTo(x, yy);
      }
      ctx.stroke();

      ctx.globalAlpha = 0.25;
      ctx.lineWidth = 6;
      ctx.strokeStyle = "rgba(0,200,255,0.35)";
      ctx.stroke();

      ctx.restore();
      requestAnimationFrame(draw);
    }

    ctx.fillStyle = "rgba(0,0,0,1)";
    ctx.fillRect(0,0,W,H);
    requestAnimationFrame(draw);

    // --------------------
    // Initialize
    // --------------------
    updateProfilePill();
    validateProfile();
    window.addEventListener("resize", () => setTimeout(updateRoutineFab, 120));
  </script>
</body>
</html>
