<!doctype html>
<html lang="sq">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MIA â€” MjekÃ«t e InteligjencÃ«s Artificiale</title>
  <style>
    :root{
      --bg0:#030712;
      --bg1:#020817;
      --ink:#e6f1ff;
      --muted:#9bb3d3;
      --glass: rgba(255,255,255,.08);
      --glass2: rgba(255,255,255,.12);
      --line: rgba(255,255,255,.16);
      --aero1: rgba(120,190,255,.22);
      --aero2: rgba(0,170,255,.12);
      --ok: rgba(80,255,190,.18);
      --warn: rgba(255,220,120,.18);
      --bad: rgba(255,120,160,.18);
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius: 22px;
      --radius2: 28px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", sans-serif;
      color:var(--ink);
      background: radial-gradient(1200px 700px at 10% 0%, rgba(40,120,255,.22), transparent 60%),
                  radial-gradient(900px 600px at 80% 20%, rgba(0,220,255,.14), transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
    }

    /* --- Smooth page system --- */
    .app{ height:100%; width:100%; position:relative; }
    .screen{
      position:absolute; inset:0;
      display:grid;
      place-items:center;
      padding:24px;
      opacity:0;
      transform: translateY(18px) scale(.985);
      pointer-events:none;
      transition: opacity .5s ease, transform .55s cubic-bezier(.2,.9,.2,1);
    }
    .screen.active{
      opacity:1;
      transform: translateY(0) scale(1);
      pointer-events:auto;
    }

    /* --- Background ECG layer --- */
    .bg{
      position:absolute; inset:0;
      overflow:hidden;
    }
    .noise{
      position:absolute; inset:-40px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='120' height='120' filter='url(%23n)' opacity='.28'/%3E%3C/svg%3E");
      mix-blend-mode: overlay;
      opacity:.12;
      transform: rotate(3deg);
      pointer-events:none;
    }
    canvas#ecg{
      position:absolute; inset:0;
      width:100%; height:100%;
      opacity:.9;
      filter: drop-shadow(0 0 16px rgba(0,180,255,.25));
    }
    .vignette{
      position:absolute; inset:0;
      background: radial-gradient(1000px 600px at 50% 30%, transparent 30%, rgba(0,0,0,.55) 80%);
      pointer-events:none;
    }

    /* --- Cards / Aero glass --- */
    .card{
      width:min(980px, 94vw);
      border-radius: var(--radius2);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute; inset:-1px;
      background: radial-gradient(700px 240px at 20% 0%, rgba(140,220,255,.20), transparent 60%),
                  radial-gradient(600px 240px at 90% 20%, rgba(0,160,255,.16), transparent 55%);
      pointer-events:none;
    }
    .cardInner{
      position:relative;
      padding: 26px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      margin-bottom:18px;
    }
    .brand{
      display:flex;
      align-items:baseline;
      gap:10px;
      user-select:none;
    }
    .brand .mia{
      font-weight:900;
      letter-spacing:.16em;
      font-size: 22px;
      text-shadow: 0 0 18px rgba(0,190,255,.22);
    }
    .brand .tag{
      font-size: 13px;
      color: var(--muted);
      letter-spacing:.02em;
    }

    .pill{
      font-size:12px;
      color: rgba(230,241,255,.86);
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      padding: 8px 10px;
      border-radius: 999px;
      display:flex;
      gap:8px;
      align-items:center;
      max-width: 520px;
    }
    .pill strong{ font-weight:700; }

    /* --- Buttons (iOS glass + Aero shine) --- */
    .btnRow{ display:flex; gap:14px; flex-wrap:wrap; }
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      color: var(--ink);
      padding: 14px 16px;
      border-radius: 18px;
      font-weight:700;
      letter-spacing:.01em;
      cursor:pointer;
      min-width: 240px;
      transition: transform .15s ease, border-color .2s ease, box-shadow .2s ease, background .2s ease;
      box-shadow: 0 10px 28px rgba(0,0,0,.25);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      position:relative;
      overflow:hidden;
    }
    .btn::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(300px 80px at 20% 0%, rgba(255,255,255,.28), transparent 55%),
        radial-gradient(280px 90px at 80% 10%, rgba(120,220,255,.22), transparent 55%);
      opacity:.75;
      pointer-events:none;
      transform: translateY(-10px);
    }
    .btn:hover{
      transform: translateY(-1px);
      border-color: rgba(170,230,255,.35);
      box-shadow: 0 16px 38px rgba(0,0,0,.30);
    }
    .btn:active{ transform: translateY(0); }
    .btn.small{ min-width:auto; padding: 11px 14px; border-radius: 16px; font-size: 13px; }
    .btn.ghost{
      background: rgba(0,0,0,.10);
      border-color: rgba(255,255,255,.14);
      box-shadow:none;
    }
    .btn.primary{
      background: linear-gradient(180deg, rgba(120,220,255,.22), rgba(0,140,255,.10));
      border-color: rgba(140,220,255,.28);
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(255,120,160,.16), rgba(255,255,255,.06));
      border-color: rgba(255,160,190,.24);
    }

    .topActions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

    /* --- Landing --- */
    .landingWrap{
      width:min(920px, 94vw);
      text-align:center;
      padding: 30px 22px;
    }
    .bigMIA{
      font-size: clamp(54px, 10vw, 96px);
      font-weight: 950;
      letter-spacing: .22em;
      margin: 0;
      display:inline-block;
      cursor:pointer;
      position:relative;
      text-shadow: 0 0 22px rgba(0,200,255,.25);
      user-select:none;
    }
    .bigMIA::after{
      content:"";
      position:absolute; left:50%; top:100%;
      width: 70%;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(120,220,255,.75), transparent);
      transform: translateX(-50%);
      opacity:.7;
    }
    .subtitle{
      margin: 14px 0 0;
      color: var(--muted);
      font-size: clamp(14px, 2.2vw, 18px);
      letter-spacing:.02em;
    }
    .hint{
      margin-top: 22px;
      color: rgba(230,241,255,.75);
      font-size: 13px;
      opacity:.9;
    }
    .kbd{
      display:inline-block;
      padding: 3px 8px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      margin: 0 6px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
    }

    /* --- Forms --- */
    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 720px){
      .grid{ grid-template-columns: 1fr; }
      .btn{ min-width: 100%; }
      .topActions{ width:100%; justify-content:flex-start; }
    }

    .field{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      border-radius: 18px;
      padding: 12px 12px 10px;
      position:relative;
    }
    .field label{
      display:block;
      font-size: 12px;
      color: rgba(230,241,255,.80);
      margin-bottom: 8px;
      letter-spacing:.02em;
    }
    .field .req{
      color: rgba(180,240,255,.95);
      font-weight:700;
      margin-left: 6px;
      font-size: 11px;
      opacity:.9;
    }
    input, select, textarea{
      width:100%;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--ink);
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 14px;
      outline:none;
      transition: border-color .2s ease, box-shadow .2s ease;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(140,220,255,.32);
      box-shadow: 0 0 0 4px rgba(80,180,255,.10);
    }
    textarea{ resize: vertical; min-height: 92px; }

    .note{
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 18px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(230,241,255,.85);
      font-size: 13px;
      line-height: 1.35;
    }
    .note strong{ color: rgba(220,250,255,.95); }

    .statusRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-top: 14px;
      flex-wrap:wrap;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      font-size: 12px;
      color: rgba(230,241,255,.86);
    }

    /* --- Output --- */
    .out{
      margin-top: 14px;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.14);
      padding: 14px;
    }
    .out h3{
      margin: 0 0 10px;
      font-size: 15px;
      letter-spacing:.02em;
    }
    .out p, .out li{
      color: rgba(230,241,255,.86);
      line-height: 1.45;
      font-size: 13.5px;
    }
    .out ul{ margin: 8px 0 0 18px; }
    .twoCol{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
      margin-top: 12px;
    }
    @media (max-width: 860px){ .twoCol{ grid-template-columns: 1fr; } }

    .week{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      padding: 12px;
    }
    .week .day{
      padding: 10px 10px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      margin-bottom: 10px;
    }
    .week .day:last-child{ margin-bottom:0; }
    .week .day strong{ display:block; margin-bottom: 6px; letter-spacing:.02em; }

    .kpiRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }

    /* --- Floating scroll button in routine --- */
    .fab{
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 20;
      display:none;
    }
    .fab.show{ display:block; }
    .fab .btn{ min-width:auto; }

    /* --- Chat --- */
    .chatBox{
      height: 340px;
      overflow:auto;
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
    }
    .msg{
      max-width: 92%;
      padding: 10px 12px;
      border-radius: 16px;
      margin: 8px 0;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      line-height: 1.35;
      font-size: 13.5px;
      white-space: pre-wrap;
    }
    .msg.me{
      margin-left:auto;
      background: linear-gradient(180deg, rgba(120,220,255,.16), rgba(255,255,255,.06));
      border-color: rgba(140,220,255,.20);
    }
    .chatRow{
      display:flex; gap:10px; margin-top: 12px;
    }
    .chatRow input{ flex:1; }

    /* tiny footer */
    .footer{
      margin-top: 14px;
      color: rgba(230,241,255,.62);
      font-size: 12px;
      line-height: 1.35;
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="bg">
      <canvas id="ecg"></canvas>
      <div class="noise"></div>
      <div class="vignette"></div>
    </div>

    <!-- SCREEN 1: Landing -->
    <section class="screen active" id="screen-landing" aria-label="Faqja hyrÃ«se">
      <div class="landingWrap">
        <h1 class="bigMIA" id="miaLogo" title="Kliko pÃ«r tÃ« vazhduar">MIA</h1>
        <div class="subtitle">MjekÃ«t e InteligjencÃ«s Artificiale</div>
        <div class="hint">Kliko mbi <span class="kbd">MIA</span> ose shtyp <span class="kbd">Enter</span>.</div>
      </div>
    </section>

    <!-- SCREEN 2: Main Menu -->
    <section class="screen" id="screen-menu" aria-label="Menuja">
      <div class="card">
        <div class="cardInner">
          <div class="topbar">
            <div class="brand">
              <div class="mia">MIA</div>
              <div class="tag">MjekÃ«t e InteligjencÃ«s Artificiale</div>
            </div>
            <div class="pill" id="profilePill">
              <strong>Profili:</strong> ende pa tÃ« dhÃ«na â€” plotÃ«so â€œVendos tÃ« dhÃ«natâ€
            </div>
          </div>

          <div class="btnRow">
            <button class="btn primary" id="btnData">Vendos tÃ« dhÃ«nat (e detyrueshme)</button>
            <button class="btn" id="btnRoutine">Gjenero RutinÃ«n Personale</button>
            <button class="btn" id="btnAI">Pyet Asistentin AI</button>
          </div>

          <div class="note" style="margin-top:16px;">
            <strong>ShÃ«nim:</strong> Ky projekt Ã«shtÃ« edukativ pÃ«r panairin e shkencÃ«s. Nuk bÃ«n diagnozÃ« dhe nuk zÃ«vendÃ«son mjekun.
          </div>
        </div>
      </div>
    </section>

    <!-- SCREEN 3: Data Form -->
    <section class="screen" id="screen-data" aria-label="Vendos tÃ« dhÃ«nat">
      <div class="card">
        <div class="cardInner">
          <div class="topbar">
            <div class="brand">
              <div class="mia">MIA</div>
              <div class="tag">Vendos tÃ« dhÃ«nat</div>
            </div>
            <div class="topActions">
              <button class="btn small ghost" id="backToMenu1">Kthehu</button>
              <button class="btn small ghost" id="homeFromData">Kryefaqja</button>
            </div>
          </div>

          <div class="grid">
            <div class="field">
              <label>Mosha <span class="req">(e detyrueshme)</span></label>
              <input id="age" type="number" min="5" max="120" placeholder="p.sh. 16" />
            </div>

            <div class="field">
              <label>Gjinia <span class="req">(e detyrueshme)</span></label>
              <select id="gender">
                <option value="">Zgjidhâ€¦</option>
                <option value="F">FemÃ«r</option>
                <option value="M">Mashkull</option>
                <option value="X">TjetÃ«r / preferoj tÃ« mos them</option>
              </select>
            </div>

            <div class="field">
              <label>Problemi i zemrÃ«s <span style="opacity:.7">(opsional)</span></label>
              <select id="heartIssue">
                <option value="">â€”</option>
                <option value="tachy">Takikardi / rrahje tÃ« shpejta</option>
                <option value="brady">Bradikardi / rrahje tÃ« ngadalta</option>
                <option value="arr">Aritmi (tÃ« parregullta)</option>
                <option value="bp">Tension i lartÃ« / probleme presioni</option>
                <option value="pain">Dhimbje gjoksi / shqetÃ«sim</option>
                <option value="other">TjetÃ«r</option>
              </select>
            </div>

            <div class="field">
              <label>Emri <span class="req">(e detyrueshme)</span></label>
              <input id="name" type="text" placeholder="p.sh. Ardi" maxlength="32" />
            </div>
          </div>

          <div class="statusRow">
            <div class="chip" id="formStatus">PlotÃ«so fushat e detyrueshme pÃ«r tÃ« aktivizuar kthimin.</div>
            <button class="btn small primary" id="btnReturnFromData" style="display:none;">Ruaj & kthehu</button>
          </div>

          <div class="footer">
            * Fushat e detyrueshme: Mosha, Gjinia, Emri. â€œProblemi i zemrÃ«sâ€ Ã«shtÃ« opsional.
          </div>
        </div>
      </div>
    </section>

    <!-- SCREEN 4: Routine Generator -->
    <section class="screen" id="screen-routine" aria-label="Gjenero rutinÃ«n">
      <div class="card">
        <div class="cardInner">
          <div class="topbar">
            <div class="brand">
              <div class="mia">MIA</div>
              <div class="tag">Rutina personale (edukative)</div>
            </div>
            <div class="topActions">
              <button class="btn small ghost" id="backToMenu2">Kthehu</button>
              <button class="btn small ghost" id="homeFromRoutine">Kryefaqja</button>
            </div>
          </div>

          <div class="note" id="routineIntro">
            Jep <strong>numrin e rrahjeve tÃ« zemrÃ«s pÃ«r 1 minutÃ« (BPM)</strong>. MIA do tÃ« pÃ«rgatisÃ« njÃ« plan javor edukativ
            tÃ« pÃ«rshtatur sipas profilit dhe kontekstit tÃ« matjes.
          </div>

          <div class="grid" style="margin-top:12px;">
            <div class="field">
              <label>Rrahjet e zemrÃ«s (BPM) <span class="req">(e detyrueshme)</span></label>
              <input id="bpm" type="number" min="30" max="220" placeholder="p.sh. 92" />
            </div>
            <div class="field">
              <label>Kur u mat? <span style="opacity:.7">(opsional)</span></label>
              <select id="bpmContext">
                <option value="rest">NÃ« qetÃ«si / ulur</option>
                <option value="after">Pas aktiviteti tÃ« lehtÃ«</option>
                <option value="stress">NÃ« stres / ankth</option>
                <option value="unknown">Nuk jam i sigurt</option>
              </select>
            </div>
          </div>

          <div class="statusRow">
            <div class="chip" id="bpmStatus">Vendos BPM pÃ«r tÃ« gjeneruar planin.</div>
            <button class="btn small primary" id="btnGenerate">Gjenero planin</button>
          </div>

          <div class="out" id="output" style="display:none;">
            <h3 id="outTitle">Plani javor</h3>
            <div class="twoCol">
              <div>
                <div id="outSummary"></div>
                <div id="outTips"></div>
              </div>
              <div class="week" id="outWeek"></div>
            </div>

            <div style="margin-top:14px; display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;">
              <button class="btn small ghost" id="scrollToTopFromPlan">Lart â†‘</button>
              <button class="btn small ghost" id="backToMenu3">Kthehu</button>
              <button class="btn small ghost" id="homeFromPlan">Kryefaqja</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Floating scroll button (Routine screen) -->
    <div class="fab" id="fabScroll">
      <button class="btn small primary" id="scrollBtn">Shko te Plani â†“</button>
    </div>

    <!-- SCREEN 5: AI Assistant (offline) -->
    <section class="screen" id="screen-ai" aria-label="Asistenti AI">
      <div class="card">
        <div class="cardInner">
          <div class="topbar">
            <div class="brand">
              <div class="mia">MIA</div>
              <div class="tag">Asistenti AI (offline, edukativ)</div>
            </div>
            <div class="topActions">
              <button class="btn small ghost" id="backToMenu4">Kthehu</button>
              <button class="btn small ghost" id="homeFromAI">Kryefaqja</button>
            </div>
          </div>

          <div class="note">
            Ky asistent Ã«shtÃ« <strong>offline</strong> (pa internet, pa API key) dhe jep pÃ«rgjigje tÃ« pÃ«rgjithshme edukative.
            PÃ«r urgjenca (dhimbje gjoksi e fortÃ«, gulÃ§im, tÃ« fikÃ«t, dobÃ«si e papritur), kÃ«rko ndihmÃ« mjekÃ«sore.
          </div>

          <div class="chatBox" id="chatBox" aria-live="polite"></div>

          <div class="chatRow">
            <input id="chatInput" type="text" placeholder="Shkruaj pyetjenâ€¦" />
            <button class="btn small primary" id="chatSend">DÃ«rgo</button>
          </div>

          <div class="footer">
            * KÃ«shillat janÃ« tÃ« pÃ«rgjithshme. NÃ«se ke diagnozÃ«, mjekime ose simptoma tÃ« vazhdueshme, ndiq mjekun.
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // --------------------
    // Simple screen router
    // --------------------
    const screens = {
      landing: document.getElementById("screen-landing"),
      menu: document.getElementById("screen-menu"),
      data: document.getElementById("screen-data"),
      routine: document.getElementById("screen-routine"),
      ai: document.getElementById("screen-ai"),
    };

    function go(to){
      Object.values(screens).forEach(s => s.classList.remove("active"));
      screens[to].classList.add("active");

      // hide floating button by default
      document.getElementById("fabScroll").classList.remove("show");

      setTimeout(() => {
        const focusables = screens[to].querySelectorAll("button, input, select, textarea");
        if (focusables.length) focusables[0].focus({preventScroll:true});
      }, 60);
    }

    // --------------------
    // State
    // --------------------
    const state = {
      profile: {
        age: null,
        gender: "",
        heartIssue: "",
        name: ""
      }
    };

    // --------------------
    // Profile pill
    // --------------------
    const profilePill = document.getElementById("profilePill");
    function updateProfilePill(){
      const p = state.profile;
      const ok = (p.age && p.gender && p.name);
      if(!ok){
        profilePill.innerHTML = "<strong>Profili:</strong> ende pa tÃ« dhÃ«na â€” plotÃ«so â€œVendos tÃ« dhÃ«natâ€";
        return;
      }
      const issueLabel = ({
        "": "pa problem tÃ« deklaruar",
        "tachy":"takikardi",
        "brady":"bradikardi",
        "arr":"aritmi",
        "bp":"tension i lartÃ«",
        "pain":"shqetÃ«sim/dhimbje gjoksi",
        "other":"tjetÃ«r"
      })[p.heartIssue ?? ""] || "â€”";

      const g = p.gender === "F" ? "F" : (p.gender === "M" ? "M" : "X");
      profilePill.innerHTML =
        `<strong>Profili:</strong> ${escapeHtml(p.name)} Â· ${p.age} vjeÃ§ Â· gjinia ${g} Â· ${issueLabel}`;
    }

    // --------------------
    // Landing interaction
    // --------------------
    const miaLogo = document.getElementById("miaLogo");
    miaLogo.addEventListener("click", () => go("menu"));
    window.addEventListener("keydown", (e) => {
      if(screens.landing.classList.contains("active") && e.key === "Enter"){
        go("menu");
      }
    });

    // --------------------
    // Menu buttons
    // --------------------
    document.getElementById("btnData").addEventListener("click", () => go("data"));

    document.getElementById("btnRoutine").addEventListener("click", () => {
      const p = state.profile;
      if(!(p.age && p.gender && p.name)){
        go("data");
        flash(document.getElementById("formStatus"), "Duhet tÃ« plotÃ«sosh fillimisht Mosha, Gjinia, Emri.", 2200);
        return;
      }
      go("routine");
      // floating scroll appears only after a plan exists
      if(document.getElementById("output").style.display !== "none"){
        document.getElementById("fabScroll").classList.add("show");
      }
    });

    document.getElementById("btnAI").addEventListener("click", () => {
      go("ai");
      bootChat();
      setTimeout(() => document.getElementById("chatInput").focus(), 120);
    });

    // --------------------
    // Data form validation
    // --------------------
    const ageEl = document.getElementById("age");
    const genderEl = document.getElementById("gender");
    const heartIssueEl = document.getElementById("heartIssue");
    const nameEl = document.getElementById("name");
    const formStatus = document.getElementById("formStatus");
    const btnReturnFromData = document.getElementById("btnReturnFromData");

    function validateProfile(){
      const age = parseInt(ageEl.value, 10);
      const gender = genderEl.value;
      const name = nameEl.value.trim();

      const ageOk = Number.isFinite(age) && age >= 5 && age <= 120;
      const genderOk = !!gender;
      const nameOk = name.length >= 2;

      const ok = ageOk && genderOk && nameOk;

      if(ok){
        formStatus.textContent = "Gati âœ… Tani mund tÃ« ruash dhe tÃ« kthehesh.";
        btnReturnFromData.style.display = "inline-flex";
      } else {
        let missing = [];
        if(!ageOk) missing.push("Mosha (5â€“120)");
        if(!genderOk) missing.push("Gjinia");
        if(!nameOk) missing.push("Emri (min 2 shkronja)");
        formStatus.textContent = "PlotÃ«so: " + missing.join(" Â· ");
        btnReturnFromData.style.display = "none";
      }
      return ok;
    }

    function saveProfile(){
      state.profile.age = parseInt(ageEl.value, 10);
      state.profile.gender = genderEl.value;
      state.profile.heartIssue = heartIssueEl.value;
      state.profile.name = nameEl.value.trim();
      updateProfilePill();
    }

    [ageEl, genderEl, heartIssueEl, nameEl].forEach(el => {
      el.addEventListener("input", validateProfile);
      el.addEventListener("change", validateProfile);
    });

    btnReturnFromData.addEventListener("click", () => {
      if(validateProfile()){
        saveProfile();
        go("menu");
      }
    });

    document.getElementById("backToMenu1").addEventListener("click", () => go("menu"));
    document.getElementById("homeFromData").addEventListener("click", () => go("menu"));

    // --------------------
    // Routine generator - navigation
    // --------------------
    document.getElementById("backToMenu2").addEventListener("click", () => go("menu"));
    document.getElementById("homeFromRoutine").addEventListener("click", () => go("menu"));

    document.getElementById("backToMenu3").addEventListener("click", () => go("routine"));
    document.getElementById("homeFromPlan").addEventListener("click", () => go("menu"));
    document.getElementById("scrollToTopFromPlan").addEventListener("click", () => {
      document.getElementById("routineIntro").scrollIntoView({behavior:"smooth", block:"start"});
    });

    // Floating scroll button (Routine)
    const fabScroll = document.getElementById("fabScroll");
    document.getElementById("scrollBtn").addEventListener("click", () => {
      const out = document.getElementById("output");
      if(out.style.display !== "none"){
        out.scrollIntoView({behavior:"smooth", block:"start"});
      } else {
        document.getElementById("routineIntro").scrollIntoView({behavior:"smooth", block:"start"});
      }
    });

    // --------------------
    // Routine generator - logic
    // --------------------
    const bpmEl = document.getElementById("bpm");
    const bpmContextEl = document.getElementById("bpmContext");
    const bpmStatus = document.getElementById("bpmStatus");
    const btnGenerate = document.getElementById("btnGenerate");

    const output = document.getElementById("output");
    const outTitle = document.getElementById("outTitle");
    const outSummary = document.getElementById("outSummary");
    const outTips = document.getElementById("outTips");
    const outWeek = document.getElementById("outWeek");

    function bpmOk(){
      const bpm = parseInt(bpmEl.value, 10);
      const ok = Number.isFinite(bpm) && bpm >= 30 && bpm <= 220;
      bpmStatus.textContent = ok ? "BPM i vlefshÃ«m âœ…" : "Vendos BPM (30â€“220).";
      return ok;
    }
    bpmEl.addEventListener("input", bpmOk);

    btnGenerate.addEventListener("click", () => {
      const p = state.profile;
      if(!(p.age && p.gender && p.name)){
        go("data");
        flash(formStatus, "PlotÃ«so tÃ« dhÃ«nat e detyrueshme pÃ«rpara rutinÃ«s.", 2200);
        return;
      }
      if(!bpmOk()){
        flash(bpmStatus, "BPM nuk Ã«shtÃ« i vlefshÃ«m. Provoni 30â€“220.", 2000);
        return;
      }
      const bpm = parseInt(bpmEl.value, 10);
      const ctx = bpmContextEl.value;

      const plan = buildPlan(p, bpm, ctx);
      renderPlan(p, bpm, ctx, plan);

      output.style.display = "block";
      output.scrollIntoView({behavior:"smooth", block:"start"});

      // show floating button on routine screen
      if(screens.routine.classList.contains("active")){
        fabScroll.classList.add("show");
      }
    });

    function buildPlan(profile, bpm, ctx){
      const age = profile.age;

      const zone = bpm < 60 ? "low" : (bpm <= 100 ? "normal" : "high");
      const ctxNote = ({
        rest: "Matje nÃ« qetÃ«si: zakonisht mÃ« e krahasueshme me vlerat standarde.",
        after: "Pas aktiviteti: rritja e BPM Ã«shtÃ« normale; mat sÃ«rish pas 5â€“10 min qetÃ«si.",
        stress: "NÃ« stres/ankth: BPM mund tÃ« rritet pÃ«rkohÃ«sisht; ndihmon frymÃ«marrja dhe qetÃ«simi.",
        unknown: "Kontekst i paqartÃ«: mat sÃ«rish nÃ« qetÃ«si pÃ«r krahasim."
      })[ctx] || "";

      const issue = profile.heartIssue || "";
      const flags = [];
      if(zone === "high" && ctx === "rest") flags.push("BPM i lartÃ« nÃ« qetÃ«si");
      if(zone === "low" && ctx === "rest") flags.push("BPM i ulÃ«t nÃ« qetÃ«si");
      if(issue === "pain") flags.push("SimptomÃ« e deklaruar: dhimbje/shqetÃ«sim gjoksi");
      if(issue === "arr") flags.push("SimptomÃ« e deklaruar: rrahje tÃ« parregullta (aritmi)");

      // Sleep ranges (realistic, flexible)
      let sleepRange = "7â€“9 orÃ« (mesatarisht)";
      if(age >= 12 && age <= 19) sleepRange = "8â€“10 orÃ« (mesatarisht) â€” shpesh me luhatje";
      if(age >= 20 && age <= 64) sleepRange = "7â€“9 orÃ« (mesatarisht)";
      if(age >= 65) sleepRange = "7â€“8 orÃ« (mesatarisht)";

      // Practical sleep plan (not "every day 8h")
      const sleepPlan = [
        "Syno njÃ« orar tÃ« qÃ«ndrueshÃ«m fjetjeje/zgjimi (Â±60 min).",
        "NÃ« ditÃ«t e ngarkuara: syno tÃ« paktÃ«n 6.5â€“7 orÃ« dhe kompenso me njÃ« gjumÃ« mÃ« tÃ« mirÃ« nÃ« fundjavÃ« (pa e tepruar).",
        "Ule ekranin 30 min para gjumit; ajros dhomÃ«n."
      ];

      // Hydration (general)
      let waterTarget = "1.6â€“2.2 L/ditÃ«";
      if(age >= 12 && age <= 19) waterTarget = "1.7â€“2.4 L/ditÃ«";
      if(zone === "high") waterTarget = "1.8â€“2.6 L/ditÃ« (sidomos nÃ«se djersitesh)";

      // Caffeine guidance
      let caffeine = "NÃ«se pÃ«rdor kafeinÃ«, mbaje herÃ«t nÃ« ditÃ« dhe jo shumÃ«; shmang energizantÃ«t.";
      if(age < 18) caffeine = "Shmang energizantÃ«t; kafeina sa mÃ« pak (sidomos pasdite).";

      // Activity (tailored by zone + issue)
      const baseCardio = (zone === "high" && ctx === "rest")
        ? "10â€“20 min ecje e moderuar, 4 ditÃ«/javÃ« (me ritÃ«m tÃ« kontrolluar)"
        : (zone === "low" ? "15â€“25 min ecje e lehtÃ«, 4â€“5 ditÃ«/javÃ« (ngrohje e gjatÃ«)"
                          : "20â€“35 min ecje e shpejtÃ« / aktivitet i moderuar, 4â€“5 ditÃ«/javÃ«");

      const strength = (zone === "high" && ctx === "rest")
        ? "2 ditÃ«/javÃ« ushtrime shumÃ« tÃ« lehta + pushime (peshÃ« e trupit)"
        : "2 ditÃ«/javÃ« ushtrime tÃ« lehta (peshÃ« e trupit)";

      const breathing = (ctx === "stress" || zone === "high")
        ? "FrymÃ«marrje 4-4-6 pÃ«r 3â€“5 min, 1â€“2 herÃ«/ditÃ«"
        : "FrymÃ«marrje e qetÃ« 2â€“3 min kur ke nevojÃ«";

      const screenBreaks = (age <= 19)
        ? "Pushime nga ekrani: 5 min Ã§do 45â€“60 min."
        : "Pushime nga ekrani: 3â€“5 min Ã§do 60â€“90 min.";

      // Emphasis (personalized)
      const emphasis = [];
      if(age >= 12 && age <= 19){
        emphasis.push("Te adoleshentÃ«t, BPM ndikohet shpesh nga stresi, mungesa e gjumit, kafeina/energizantÃ«t dhe nikotina.");
      }
      if(zone === "high" && ctx === "rest"){
        emphasis.push("NÃ«se BPM i lartÃ« nÃ« qetÃ«si pÃ«rsÃ«ritet nÃ« ditÃ« tÃ« ndryshme, Ã«shtÃ« ide e mirÃ« njÃ« konsultÃ« mjekÃ«sore.");
      }
      if(ctx === "after"){
        emphasis.push("Pas aktivitetit, prit 5â€“10 min qetÃ«si dhe mat sÃ«rish pÃ«r krahasim.");
      }
      if(ctx === "stress"){
        emphasis.push("NÃ« stres/ankth, fokusohu te frymÃ«marrja dhe hidratimi; mos e kontrollo puls-in shumÃ« shpesh (rrit ankthin).");
      }
      if(issue === "tachy"){
        emphasis.push("Kufizo kafeinÃ«/energizantÃ«, hidrato, dhe shto ecje tÃ« moderuar me rritje graduale.");
      }
      if(issue === "brady"){
        emphasis.push("BPM i ulÃ«t mund tÃ« jetÃ« normal te personat aktivÃ«; nÃ«se shoqÃ«rohet me lodhje/tÃ« fikÃ«t, kÃ«rko vlerÃ«sim mjekÃ«sor.");
      }
      if(issue === "arr"){
        emphasis.push("NÃ«se ndjen rrahje tÃ« parregullta me marramendje, dobÃ«si ose dhimbje gjoksi, mos e neglizho.");
      }
      if(issue === "bp"){
        emphasis.push("Balanco kripÃ«n, rrit ecjen e rregullt, dhe mbaj njÃ« ritÃ«m tÃ« qÃ«ndrueshÃ«m gjumi/ushqimi.");
      }
      if(issue === "pain"){
        emphasis.push("Dhimbja e gjoksit kÃ«rkon kujdes profesional, sidomos nÃ«se shoqÃ«rohet me gulÃ§im, djersÃ« tÃ« ftohta ose pÃ«rhapje nÃ« krah/qafÃ«.");
      }

      // Routine day template (specific + variable)
      const daily = [
        {t:"08:00", a:"UjÃ« 250 ml + mÃ«ngjes i lehtÃ« (proteina + karbo tÃ« mira: kos/vezÃ« + fruta/drithÃ«ra)"},
        {t:"11:00", a:`UjÃ« 200â€“250 ml + ${breathing}`},
        {t:"14:00", a:"DrekÃ« e balancuar (perime + proteina) + ujÃ« 300 ml"},
        {t:"17:00", a:`Aktivitet: ${baseCardio}`},
        {t:"20:30", a:`Shtrirje 6â€“10 min + ${screenBreaks} (sidomos mbrÃ«mjes)`},
      ];

      // Week plan tailored by zone/issue/context
      const week = makeWeekPlan({age, zone, ctx, issue});

      // Caution / red flags
      const caution = [];
      caution.push("Ky plan Ã«shtÃ« edukativ dhe i pÃ«rgjithshÃ«m â€” jo diagnozÃ«.");
      caution.push("NÃ«se ke: tÃ« fikÃ«t, gulÃ§im i rÃ«ndÃ«, dhimbje gjoksi e fortÃ«, dobÃ«si e papritur, ose rrahje shumÃ« tÃ« Ã§rregullta â†’ kÃ«rko ndihmÃ« mjekÃ«sore.");
      if(zone === "high" && ctx === "rest"){
        caution.push("BPM i lartÃ« nÃ« qetÃ«si i pÃ«rsÃ«ritur Ã«shtÃ« arsye e mirÃ« pÃ«r kontroll mjekÃ«sor.");
      }
      if(zone === "low" && ctx === "rest"){
        caution.push("BPM i ulÃ«t nÃ« qetÃ«si mund tÃ« jetÃ« normal te sportistÃ«t; nÃ«se ka simptoma (lodhje e fortÃ«, marramendje), konsultohu.");
      }

      // â€œKPIâ€ summary chips
      const kpis = [
        {label:`UjÃ«: ${waterTarget}`},
        {label:`GjumÃ«: ${sleepRange}`},
        {label:`Aktivitet: ${baseCardio}`},
        {label:`KafeinÃ«: ${age < 18 ? "shmang energizantÃ«t" : "kujdes pasdite"}`},
      ];

      return {
        meta: { zone, ctxNote, flags, age, issue },
        waterTarget,
        sleepRange,
        sleepPlan,
        caffeine,
        activity: { cardio: baseCardio, strength, breathing, screenBreaks },
        daily,
        week,
        emphasis,
        caution,
        kpis
      };
    }

    function makeWeekPlan({age, zone, ctx, issue}){
      // intensity tuning
      const light = zone === "high" && ctx === "rest";
      const low = zone === "low" && ctx === "rest";

      const cardioA = light ? "Ecje e moderuar 12â€“18 min (pa sprint)" :
                      low ? "Ecje e lehtÃ« 15â€“20 min (ngrohje e gjatÃ«)" :
                            "Ecje e shpejtÃ« 20â€“30 min";

      const cardioB = light ? "Ecje 10â€“15 min + frymÃ«marrje 5 min" :
                      low ? "Ecje e lehtÃ« 15â€“25 min" :
                            "Aktivitet moderuar 25â€“35 min (ecje/biÃ§ikletÃ« e lehtÃ«)";

      const strength = light ? "ForcÃ« shumÃ« e lehtÃ« 10â€“15 min (pushime tÃ« shpeshta)" :
                       "ForcÃ« e lehtÃ« 15â€“20 min (peshÃ« e trupit)";

      const stressBlock = (ctx === "stress" || zone === "high") ? "FrymÃ«marrje 4-4-6 5 min + shÃ«titje e qetÃ«" : "Relaks 10 min";

      // issue-specific add-ons
      let addon = "ShÃ«nim: mat pulsin 1 herÃ« nÃ« javÃ« nÃ« qetÃ«si (jo Ã§do orÃ«).";
      if(issue === "tachy") addon = "ShÃ«nim: shmang energizantÃ«t dhe mat pulsin nÃ« qetÃ«si 2 herÃ« nÃ« javÃ« (jo shpesh).";
      if(issue === "bp") addon = "ShÃ«nim: kujdes me kripÃ«n dhe ushqimet shumÃ« tÃ« pÃ«rpunuara.";
      if(issue === "arr") addon = "ShÃ«nim: nÃ«se ndjen rrahje tÃ« parregullta + marramendje, shÃ«no kohÃ«n/simptomat dhe fol me mjek.";
      if(issue === "pain") addon = "ShÃ«nim: dhimbja e gjoksit nuk neglizhohetâ€”nÃ«se pÃ«rsÃ«ritet, kÃ«rko vlerÃ«sim mjekÃ«sor.";

      // teen-friendly structure
      const studyBreak = (age <= 19) ? "Pushim nga ekrani 5 min Ã§do 45â€“60 min" : "Pushim 3â€“5 min Ã§do 60â€“90 min";

      return [
        {d:"E HÃ«nÃ«", items:[cardioA, stressBlock, studyBreak, addon]},
        {d:"E MartÃ«", items:[strength, "Shtrirje 8â€“10 min", "Hidratim i rregullt gjatÃ« ditÃ«s", addon]},
        {d:"E MÃ«rkurÃ«", items:[cardioB, "Koha jashtÃ« 20â€“40 min (nÃ«se mundesh)", "GjumÃ« sa mÃ« i rregullt", addon]},
        {d:"E Enjte", items:[strength, "FrymÃ«marrje 3â€“5 min", "Ushqim mÃ« i lehtÃ« nÃ« mbrÃ«mje", addon]},
        {d:"E Premte", items:[cardioA, "Aktivitet relaksues (muzikÃ«/lexim) 15â€“20 min", "Shmang kafeinÃ« pas orÃ«s 15:00", addon]},
        {d:"E ShtunÃ«", items:[light ? "ShÃ«titje e qetÃ« 20â€“30 min" : "Aktivitet i lirÃ« 30â€“45 min (pa e tepruar)", "Shtrirje 10 min", addon]},
        {d:"E Diel", items:["Rikuperim: ecje shumÃ« e lehtÃ« 10â€“20 min", "Planifikim i javÃ«s (gjumi/ushqimi)", addon]},
      ];
    }

    function renderPlan(profile, bpm, ctx, plan){
      const zoneLabel = plan.meta.zone === "high" ? "i lartÃ«" : (plan.meta.zone==="low" ? "i ulÃ«t" : "normal");
      const issueLabel = ({
        "": "pa problem tÃ« deklaruar",
        "tachy":"takikardi",
        "brady":"bradikardi",
        "arr":"aritmi",
        "bp":"tension i lartÃ«",
        "pain":"dhimbje/shqetÃ«sim gjoksi",
        "other":"tjetÃ«r"
      })[profile.heartIssue ?? ""] || "â€”";

      outTitle.textContent = `Plani javor pÃ«r ${profile.name}`;

      const ctxLabel = ({
        rest:"nÃ« qetÃ«si",
        after:"pas aktiviteti",
        stress:"nÃ« stres/ankth",
        unknown:"kontekst i paqartÃ«"
      })[ctx] || ctx;

      const headline = `
        <div class="note" style="margin-top:0;">
          <p style="margin:0 0 8px;">
            <strong>Profili:</strong> ${escapeHtml(profile.name)}, ${profile.age} vjeÃ§ Â· problemi: <strong>${escapeHtml(issueLabel)}</strong>
          </p>
          <p style="margin:0;">
            <strong>BPM:</strong> ${bpm} (${zoneLabel}) Â· <strong>Matja:</strong> ${escapeHtml(ctxLabel)}<br>
            <span style="color: rgba(230,241,255,.72);">${escapeHtml(plan.meta.ctxNote)}</span>
          </p>
          <div class="kpiRow">
            ${plan.kpis.map(k => `<span class="chip">${escapeHtml(k.label)}</span>`).join("")}
          </div>
        </div>
      `;

      const emphasisList = (plan.emphasis.length ? `
        <div class="note" style="background: var(--aero2); border-color: rgba(120,220,255,.22);">
          <strong>PÃ«rshtatje sipas profilit:</strong>
          <ul>${plan.emphasis.map(e => `<li>${escapeHtml(e)}</li>`).join("")}</ul>
        </div>
      ` : "");

      const cautionList = (plan.caution.length ? `
        <div class="note" style="background: rgba(255,200,120,.10); border-color: rgba(255,220,140,.20);">
          <strong>Kujdes:</strong>
          <ul>${plan.caution.map(c => `<li>${escapeHtml(c)}</li>`).join("")}</ul>
        </div>
      ` : "");

      // Daily routine list
      const dailyList = plan.daily.map(x => `<li><strong>${x.t}</strong> â€” ${escapeHtml(x.a)}</li>`).join("");

      // Sleep tips list
      const sleepList = plan.sleepPlan.map(s => `<li>${escapeHtml(s)}</li>`).join("");

      outSummary.innerHTML = headline;

      outTips.innerHTML = `
        <div class="out" style="margin-top:12px;">
          <h3>Rutina ditore (shembull i zbatueshÃ«m)</h3>
          <ul>${dailyList}</ul>
        </div>

        <div class="out" style="margin-top:12px;">
          <h3>GjumÃ« & rikuperim (realist)</h3>
          <p style="margin:0 0 8px;">Synim: <strong>${escapeHtml(plan.sleepRange)}</strong> (jo domosdoshmÃ«risht Ã§do natÃ« njÃ«soj).</p>
          <ul>${sleepList}</ul>
        </div>

        <div class="out" style="margin-top:12px;">
          <h3>KÃ«shilla tÃ« shpejta</h3>
          <ul>
            <li><strong>Hidratim:</strong> ${escapeHtml(plan.waterTarget)} (ujÃ« gjatÃ« ditÃ«s, jo vetÃ«m nÃ« mbrÃ«mje).</li>
            <li><strong>KafeinÃ«/energizantÃ«:</strong> ${escapeHtml(plan.caffeine)}</li>
            <li><strong>Aktivitet:</strong> ${escapeHtml(plan.activity.cardio)} + ${escapeHtml(plan.activity.strength)}.</li>
            <li><strong>Stres:</strong> ${escapeHtml(plan.activity.breathing)}.</li>
          </ul>
          <p style="margin-top:10px; color: rgba(230,241,255,.72);">
            * Kjo Ã«shtÃ« rutinÃ« edukative. NÃ«se ke sÃ«mundje tÃ« diagnostikuar, mjekime, ose simptoma tÃ« forta, ndiq mjekun.
          </p>
        </div>

        ${emphasisList}
        ${cautionList}
      `;

      outWeek.innerHTML = plan.week.map(d => `
        <div class="day">
          <strong>${escapeHtml(d.d)}</strong>
          <ul style="margin:0 0 0 18px;">
            ${d.items.map(it => `<li>${escapeHtml(it)}</li>`).join("")}
          </ul>
        </div>
      `).join("");
    }

    // --------------------
    // AI Assistant (offline) - expanded
    // --------------------
    const chatBox = document.getElementById("chatBox");
    const chatInput = document.getElementById("chatInput");
    const chatSend = document.getElementById("chatSend");

    document.getElementById("backToMenu4").addEventListener("click", () => go("menu"));
    document.getElementById("homeFromAI").addEventListener("click", () => go("menu"));

    function addMsg(text, who="bot"){
      const div = document.createElement("div");
      div.className = "msg" + (who==="me" ? " me" : "");
      div.textContent = text;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function bootChat(){
      chatBox.innerHTML = "";

      addMsg("PÃ«rshÃ«ndetje! UnÃ« jam MIA (offline). Jam kÃ«tu pÃ«r shpjegime dhe kÃ«shilla tÃ« pÃ«rgjithshme rreth zemrÃ«s, pulsit dhe EKG-sÃ«.");
      const p = state.profile;
      if(p.age && p.gender && p.name){
        addMsg(`E shoh qÃ« profili yt Ã«shtÃ«: ${p.name}, ${p.age} vjeÃ§. Mund tÃ« pyesÃ«sh lirshÃ«m. (KÃ«shilla edukative)`);
      } else {
        addMsg("NÃ«se do pÃ«rgjigje mÃ« tÃ« pÃ«rshtatura, plotÃ«so mÃ« parÃ« â€œVendos tÃ« dhÃ«natâ€.");
      }

      addMsg(
`Shembuj pyetjesh:
â€¢ Si je?
â€¢ Kam 95 BPM nÃ« qetÃ«si, a Ã«shtÃ« normale?
â€¢ Pse mÃ« rritet pulsi kur jam nÃ« ankth?
â€¢ Si ta mas pulsin saktÃ«?
â€¢ Ã‡farÃ« Ã«shtÃ« vala P / QRS / QT?
â€¢ Ã‡farÃ« tÃ« bÃ«j kur ndjej rrahje tÃ« forta zemre?
â€¢ A ndikon kafeina, energizantÃ«t, nikotina?
â€¢ Ã‡farÃ« sinjalesh janÃ« urgjencÃ«?`
      );
    }

    // quick knowledge blocks
    const KB = {
      emergency: [
        "NÃ«se ke dhimbje gjoksi tÃ« fortÃ«, gulÃ§im, tÃ« fikÃ«t, dobÃ«si tÃ« papritur, konfuzion, ose dhimbje qÃ« pÃ«rhapet nÃ« krah/qafÃ«/ nofull â†’ kÃ«rko ndihmÃ« mjekÃ«sore menjÃ«herÃ«.",
        "NÃ«se pulsi Ã«shtÃ« shumÃ« i shpejtÃ« dhe nuk ulet pas qetÃ«simit (ose shoqÃ«rohet me marramendje), mos e neglizho."
      ],
      bpmBasics:
        "BPM = rrahje zemre pÃ«r minutÃ«. PÃ«r matje tÃ« saktÃ«: ulu qetÃ« 5 minuta, mat 30 sekonda dhe shumÃ«zo me 2 (ose mat 60 sekonda). Matja nÃ« qetÃ«si Ã«shtÃ« mÃ« krahasuese.",
      pulseHow:
        "Matja e pulsit: vendos 2 gishta te kyÃ§i i dorÃ«s (ana e gishtit tÃ« madh). Mos pÃ«rdor gishtin e madh. NumÃ«ro rrahjet 30 sekonda dhe shumÃ«zo me 2.",
      normalRanges:
        "NÃ« pÃ«rgjithÃ«si (tÃ« rritur): 60â€“100 BPM nÃ« qetÃ«si. Te sportistÃ«t mund tÃ« jetÃ« mÃ« i ulÃ«t. Te adoleshentÃ«t mund tÃ« ketÃ« luhatje me stres, gjumÃ«, kafeinÃ«.",
      ecgBasics:
        "EKG-ja regjistron aktivitetin elektrik tÃ« zemrÃ«s. Vala P (aktivizim i atriumeve), kompleksi QRS (aktivizim i ventrikujve), vala T (rikuperim i ventrikujve). Intervali QT lidhet me kohÃ«n e aktivizim+rikuperimit.",
      lifestyle:
        "Zakonet qÃ« shpesh stabilizojnÃ« pulsin: hidratim, gjumÃ« mÃ« i rregullt (mesatarisht), aktivitet i moderuar, ulje e energizantÃ«ve/kafeinÃ«s, pushime nga ekrani, frymÃ«marrje e qetÃ«.",
      stressBreath:
        "TeknikÃ« e thjeshtÃ«: 4-4-6 (thith 4s, mbaj 4s, nxirr 6s) pÃ«r 3â€“5 minuta. Mund tÃ« ulÃ« ndjesinÃ« e rrahjeve tÃ« forta nÃ« stres."
    };

    function normalize(s){
      return (s||"")
        .toLowerCase()
        .replaceAll("Ã«","e")
        .replaceAll("Ã§","c")
        .trim();
    }

    function extractNumber(text){
      const m = text.match(/(\d{2,3})/);
      if(!m) return null;
      const n = parseInt(m[1], 10);
      return Number.isFinite(n) ? n : null;
    }

    function isGreeting(t){
      return ["pershendetje","hi","hej","hello","tung","miremengjes","mirembrema","mirdita"].some(x => t.includes(x));
    }
    function isHowAreYou(t){
      return ["si je","si jeni","ca ben","Ã§ka ben","cka ben","si po shkon","si po ecen","si po kalon"].some(x => t.includes(x));
    }
    function isThanks(t){
      return ["faleminderit","rrofsh","thanks","thank you","shume faleminderit"].some(x => t.includes(x));
    }
    function isRandomSmallTalk(t){
      return ["kush je","cfare je","a je i vertete","a je robot","me njeh","me do","me ndihmon dot"].some(x => t.includes(x));
    }

    function answer(q){
      const p = state.profile;
      const t = normalize(q);

      // Emergency triggers (simple)
      const mentionsChest = (t.includes("dhimbje") && t.includes("gjoks")) || t.includes("dhimbje gjoksi");
      const mentionsFaint = t.includes("te fik") || t.includes("te fiket") || t.includes("humbje ndjenjash");
      const mentionsBreath = t.includes("gulcim") || t.includes("frym") && (t.includes("vesht") || t.includes("vÃ«sht"));
      const mentionsSevereDizzy = t.includes("marramend") && (t.includes("fort") || t.includes("shume"));

      if(mentionsChest || mentionsFaint || mentionsBreath || mentionsSevereDizzy){
        return [
          "Kjo mund tÃ« jetÃ« serioze.",
          ...KB.emergency,
          "",
          "NÃ«se je i sigurt qÃ« nuk Ã«shtÃ« urgjencÃ«, mÃ« thuaj: sa BPM ke, nÃ« Ã§farÃ« situate u mat, dhe Ã§farÃ« simptomash ke."
        ].join("\n");
      }

      // Greetings / small talk
      if(isGreeting(t) && !isHowAreYou(t)){
        return "PÃ«rshÃ«ndetje! ğŸ˜Š MÃ« thuaj Ã§farÃ« tÃ« shqetÃ«son: BPM/puls, EKG, stres, kafeinÃ«, lodhje, apo rutinÃ« javor?";
      }
      if(isHowAreYou(t)){
        return "Jam mirÃ«, faleminderit qÃ« pyet! ğŸ™‚ Jam gati tÃ« tÃ« ndihmoj. Ã‡farÃ« po do tÃ« kuptosh sot rreth pulsit/zemrÃ«s?";
      }
      if(isThanks(t)){
        return "Me kÃ«naqÃ«si! NÃ«se do, mund tÃ« mÃ« thuash BPM-nÃ« dhe kontekstin (nÃ« qetÃ«si / pas aktivitetit / nÃ« stres) qÃ« ta shpjegoj mÃ« konkret.";
      }
      if(isRandomSmallTalk(t)){
        return "Jam MIA, njÃ« asistent edukativ offline. Nuk bÃ«j diagnozÃ«, por tÃ« ndihmoj tÃ« kuptosh mÃ« mirÃ« pulsin, EKG-nÃ« dhe zakonet e shÃ«ndetshme. Ã‡farÃ« pyetje ke?";
      }

      // Direct BPM number handling
      const n = extractNumber(t);
      const mentionsBpm = t.includes("bpm") || t.includes("puls") || t.includes("rrahje") || t.includes("rrahjet");
      if(n && (mentionsBpm || (n>=30 && n<=220))){
        // interpret with context hints
        let ctxGuess = "nuk e di";
        if(t.includes("qet") || t.includes("ulur") || t.includes("pushim")) ctxGuess = "nÃ« qetÃ«si";
        if(t.includes("pas") && (t.includes("vrap")||t.includes("ecj")||t.includes("ushtrim")||t.includes("sport"))) ctxGuess = "pas aktivitetit";
        if(t.includes("stres") || t.includes("ankth") || t.includes("panik")) ctxGuess = "nÃ« stres/ankth";

        const zone = n < 60 ? "i ulÃ«t" : (n <= 100 ? "normal" : "i lartÃ«");

        const lines = [];
        lines.push(`BPM = ${n}. Kjo duket ${zone}${ctxGuess!=="nuk e di" ? " ("+ctxGuess+")" : ""}.`);
        lines.push("");

        // safe guidance
        if(n > 120 && (ctxGuess === "nÃ« qetÃ«si" || ctxGuess === "nuk e di")){
          lines.push("NÃ«se ky BPM Ã«shtÃ« nÃ« qetÃ«si dhe pÃ«rsÃ«ritet, Ã«shtÃ« mirÃ« ta diskutosh me mjekun, sidomos nÃ«se ke marramendje, dobÃ«si ose dhimbje gjoksi.");
        } else if(n > 100 && ctxGuess === "nÃ« stres/ankth"){
          lines.push("NÃ« stres, rritja e BPM mund tÃ« jetÃ« e pÃ«rkohshme. Provo 3â€“5 minuta frymÃ«marrje 4-4-6 dhe mat sÃ«rish pas 5 minutash qetÃ«si.");
        } else if(n > 100 && ctxGuess === "pas aktivitetit"){
          lines.push("Pas aktivitetit, BPM rritet normalisht. Prit 5â€“10 minuta nÃ« qetÃ«si dhe mat sÃ«rish pÃ«r krahasim.");
        } else if(n < 60){
          lines.push("BPM i ulÃ«t mund tÃ« jetÃ« normal te personat aktivÃ«. NÃ«se shoqÃ«rohet me lodhje tÃ« fortÃ«, marramendje ose tÃ« fikÃ«t, kÃ«rko vlerÃ«sim mjekÃ«sor.");
        } else {
          lines.push("NÃ«se ndihesh mirÃ« dhe Ã«shtÃ« matje normale, fokusohu te hidratimi, gjumi i rregullt (mesatarisht) dhe aktiviteti i moderuar.");
        }

        lines.push("");
        lines.push("NÃ«se do pÃ«rgjigje mÃ« tÃ« saktÃ«: mÃ« thuaj mosha + a ishte matje nÃ« qetÃ«si, pas aktivitetit, apo nÃ« stres.");
        return lines.join("\n");
      }

      // Core topics
      if(t.includes("bpm") || t.includes("puls") || t.includes("rrahje")){
        return [
          KB.bpmBasics,
          "",
          KB.pulseHow,
          "",
          KB.normalRanges
        ].join("\n");
      }

      // ECG questions
      if(t.includes("ekg") || t.includes("ecg") || t.includes("qrs") || t.includes("qt") || t.includes("vala p") || t.includes("vala t")){
        const extra = [];
        if(t.includes("qt")) extra.push("QT: NÃ« praktikÃ« vlerÃ«sohet shpesh si QTc (korrigjuar me ritmin). QT shumÃ« i gjatÃ«/shkurtÃ«r kÃ«rkon vlerÃ«sim mjekÃ«sor (sidomos me simptoma).");
        if(t.includes("qrs")) extra.push("QRS: Kompleksi i ventrikujve. QRS i zgjeruar mund tÃ« lidhet me pÃ«rcjelljen elektrike (p.sh. blloqe), por interpretimi Ã«shtÃ« klinik.");
        if(t.includes("vala p")) extra.push("Vala P: Aktivizimi i atriumeve. Mungesa/ndryshimet mund tÃ« shihen nÃ« disa aritmi.");
        return [KB.ecgBasics, ...(extra.length?["", ...extra]:[]), "", "NÃ«se do, mÃ« thuaj Ã§farÃ« po shikon (p.sh. â€˜QRS i madhâ€™, â€˜QTâ€™), dhe do ta shpjegoj me gjuhÃ« tÃ« thjeshtÃ«."].join("\n");
      }

      // Caffeine/energy drinks/nicotine
      if(t.includes("energ") || t.includes("kafein") || t.includes("kafe") || t.includes("duhan") || t.includes("nikotin")){
        return [
          "Poâ€”kÃ«to mund tÃ« ndikojnÃ« te pulsi.",
          "â€¢ Kafeina/energizantÃ«t: mund tÃ« rrisin BPM dhe ankthin (sidomos nÃ«se je i lodhur ose i dehidratuar).",
          "â€¢ Nikotina: rrit ritmin e zemrÃ«s dhe ngushton enÃ«t e gjakut.",
          "Ã‡farÃ« mund tÃ« bÃ«sh: redukto gradualisht, pi ujÃ«, ha rregullisht, dhe shiko si ndryshon pulsi pas 1â€“2 javÃ«sh."
        ].join("\n");
      }

      // Stress/anxiety
      if(t.includes("stres") || t.includes("ankth") || t.includes("panik") || t.includes("frym") || t.includes("frymarr")){
        return [
          "Stresi/ankthi shpesh rrit BPM pÃ«rkohÃ«sisht.",
          KB.stressBreath,
          "",
          "KÃ«shillÃ« praktike: ulu, vendos njÃ« dorÃ« nÃ« bark, bÃ«j 10 cikle 4-4-6 dhe mat pulsin vetÃ«m njÃ« herÃ« pas qetÃ«simit.",
        ].join("\n");
      }

      // Sleep
      if(t.includes("gjum") || t.includes("pagjumes") || t.includes("lodhje")){
        let s = "PÃ«r shumicÃ«n e tÃ« rriturve syno 7â€“9 orÃ« (mesatarisht), por jo Ã§do natÃ« del njÃ«soj.";
        if(p.age && p.age <= 19) s = "Te adoleshentÃ«t synimi shpesh Ã«shtÃ« 8â€“10 orÃ« (mesatarisht), por realisht ka luhatje.";
        return [
          s,
          "Praktikisht:",
          "â€¢ Vendos njÃ« orÃ« fikse zgjimi (edhe nÃ« fundjavÃ«, afÃ«rsisht).",
          "â€¢ Ule ekranin 30 min para gjumit.",
          "â€¢ NÃ«se njÃ« natÃ« fle pak, mos e â€˜dÃ«noâ€™ vetenâ€”syno rikuperim gradual ditÃ«t nÃ« vijim.",
        ].join("\n");
      }

      // Exercise
      if(t.includes("sport") || t.includes("vrap") || t.includes("ecje") || t.includes("ushtrim")){
        return [
          "Aktiviteti i moderuar zakonisht ndihmon zemrÃ«n nÃ« afatgjatÃ«.",
          "â€¢ NÃ«se je fillestar: ecje 15â€“25 min, 4 ditÃ«/javÃ«.",
          "â€¢ NÃ«se je ok: ecje e shpejtÃ« 20â€“35 min, 4â€“5 ditÃ«/javÃ«.",
          "â€¢ NÃ«se ke rrahje tÃ« shpejta nÃ« qetÃ«si: fillo mÃ« butÃ«, rrit gradualisht dhe mos e tepro.",
          "NÃ«se gjatÃ« aktivitetit ke dhimbje gjoksi, marramendje ose tÃ« fikÃ«t â€” ndalo dhe kÃ«rko ndihmÃ«."
        ].join("\n");
      }

      // Routine generator help
      if(t.includes("rut") || t.includes("plan") || t.includes("jav")){
        if(p.age && p.gender && p.name){
          return "PÃ«r planin: shko te â€œGjenero RutinÃ«n Personaleâ€, vendos BPM + kontekstin, dhe do marrÃ«sh javÃ«n tÃ« pÃ«rshtatur.";
        }
        return "PÃ«r plan tÃ« pÃ«rshtatur: plotÃ«so â€œVendos tÃ« dhÃ«natâ€, pastaj shko te â€œGjenero RutinÃ«n Personaleâ€.";
      }

      // Default fallback with suggested categories
      return [
        "MÃ« thuaj pak mÃ« konkret se pÃ«r Ã§farÃ« po pyet:",
        "â€¢ BPM/puls (p.sh. â€˜kam 88 bpm nÃ« qetÃ«siâ€™)",
        "â€¢ EKG (P, QRS, QT, aritmi)",
        "â€¢ Stres/ankth, gjumÃ«, kafeinÃ«/energizantÃ«, aktivitet fizik",
        "Dhe nÃ«se ke numra (BPM), shkruaji qÃ« ta interpretoj mÃ« qartÃ«."
      ].join("\n");
    }

    function sendChat(){
      const q = chatInput.value.trim();
      if(!q) return;
      addMsg(q, "me");
      chatInput.value = "";
      setTimeout(() => addMsg(answer(q), "bot"), 180);
    }
    chatSend.addEventListener("click", sendChat);
    chatInput.addEventListener("keydown", (e) => {
      if(e.key === "Enter") sendChat();
    });

    // --------------------
    // Helpers
    // --------------------
    function flash(el, text, ms=1800){
      const prev = el.textContent;
      el.textContent = text;
      el.style.borderColor = "rgba(255,220,140,.28)";
      el.style.background = "rgba(255,220,140,.10)";
      setTimeout(() => {
        el.textContent = prev;
        el.style.borderColor = "";
        el.style.background = "";
      }, ms);
    }

    function escapeHtml(str){
      return (str ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // --------------------
    // ECG canvas animation
    // --------------------
    const canvas = document.getElementById("ecg");
    const ctx = canvas.getContext("2d");
    let W=0, H=0, t=0;

    function resize(){
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      W = canvas.clientWidth;
      H = canvas.clientHeight;
      canvas.width = Math.floor(W*dpr);
      canvas.height = Math.floor(H*dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    window.addEventListener("resize", resize);
    resize();

    function draw(){
      t += 0.016;

      ctx.fillStyle = "rgba(0,0,0,0.18)";
      ctx.fillRect(0,0,W,H);

      // Grid
      ctx.save();
      ctx.globalAlpha = 0.10;
      ctx.strokeStyle = "rgba(120,220,255,0.35)";
      ctx.lineWidth = 1;
      const step = 42;
      for(let x=0; x<W; x+=step){
        ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke();
      }
      for(let y=0; y<H; y+=step){
        ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke();
      }
      ctx.restore();

      // ECG wave
      const mid = H*0.52;
      const amp = Math.min(64, H*0.10);

      ctx.save();
      ctx.lineWidth = 2.2;
      ctx.strokeStyle = "rgba(140,220,255,0.95)";
      ctx.shadowColor = "rgba(0,190,255,0.35)";
      ctx.shadowBlur = 18;

      ctx.beginPath();
      const speed = 220;
      const phase = (t*speed) % W;

      for(let x=0; x<=W; x++){
        const u = ((x + phase) % 260) / 260;
        let y = 0;

        y += Math.sin((x*0.014) + t*1.6) * (amp*0.08);

        if(u > 0.30 && u < 0.34) y += -amp*0.20;
        if(u >= 0.34 && u < 0.36) y +=  amp*0.55;
        if(u >= 0.36 && u < 0.40) y += -amp*1.00;
        if(u >= 0.40 && u < 0.44) y +=  amp*0.30;
        if(u >= 0.44 && u < 0.52) y +=  Math.sin((u-0.44)*Math.PI*6) * (amp*0.10);

        const yy = mid + y;
        if(x===0) ctx.moveTo(x, yy);
        else ctx.lineTo(x, yy);
      }
      ctx.stroke();

      ctx.globalAlpha = 0.25;
      ctx.lineWidth = 6;
      ctx.strokeStyle = "rgba(0,200,255,0.35)";
      ctx.stroke();

      ctx.restore();
      requestAnimationFrame(draw);
    }
    ctx.fillStyle = "rgba(0,0,0,1)";
    ctx.fillRect(0,0,W,H);
    requestAnimationFrame(draw);

    // --------------------
    // Initialize
    // --------------------
    updateProfilePill();
    validateProfile();

    // Home buttons
    document.getElementById("homeFromData").addEventListener("click", () => go("menu"));
  </script>
</body>
</html>
