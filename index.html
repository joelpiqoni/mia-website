<!doctype html>
<html lang="sq">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MIA — Mjekët e Inteligjencës Artificiale</title>
<style>
  :root{
    --bg0:#050914; --bg1:#020817;
    --ink:#EAF4FF; --muted:#A7C1DF;
    --glass1: rgba(255,255,255,.10);
    --glass2: rgba(255,255,255,.06);
    --line: rgba(255,255,255,.14);
    --shadow: 0 22px 70px rgba(0,0,0,.55);
    --r1:18px; --r2:26px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    color: var(--ink);
    background:
      radial-gradient(1200px 700px at 12% 0%, rgba(40,120,255,.22), transparent 60%),
      radial-gradient(900px 600px at 85% 20%, rgba(0,220,255,.14), transparent 55%),
      linear-gradient(180deg, var(--bg0), var(--bg1));
    overflow:hidden;
  }
  /* Background ECG */
  .bg{position:absolute; inset:0; overflow:hidden}
  #ecg{position:absolute; inset:0; width:100%; height:100%; opacity:.92; filter:drop-shadow(0 0 16px rgba(0,180,255,.22))}
  .noise{
    position:absolute; inset:-40px; pointer-events:none; opacity:.10; mix-blend-mode: overlay;
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='120' height='120' filter='url(%23n)' opacity='.30'/%3E%3C/svg%3E");
  }
  .vignette{position:absolute; inset:0; pointer-events:none; background:radial-gradient(1000px 600px at 50% 30%, transparent 30%, rgba(0,0,0,.62) 82%)}

  .app{position:relative; height:100%; width:100%}
  .screen{
    position:absolute; inset:0;
    display:grid; place-items:center;
    padding:24px;
    opacity:0;
    transform: translateY(16px) scale(.985);
    pointer-events:none;
    transition: opacity .45s ease, transform .55s cubic-bezier(.2,.9,.2,1);
  }
  .screen.active{opacity:1; transform:translateY(0) scale(1); pointer-events:auto}

  .card{
    width:min(980px, 94vw);
    border-radius: var(--r2);
    background: linear-gradient(180deg, var(--glass1), var(--glass2));
    border:1px solid var(--line);
    box-shadow: var(--shadow);
    backdrop-filter: blur(18px);
    -webkit-backdrop-filter: blur(18px);
    overflow:hidden;
    position:relative;
  }
  .card.wide{width:min(1160px, 96vw)}
  .card::before{
    content:"";
    position:absolute; inset:-2px;
    background:
      radial-gradient(700px 240px at 18% 0%, rgba(140,220,255,.20), transparent 60%),
      radial-gradient(600px 240px at 92% 18%, rgba(0,160,255,.16), transparent 55%);
    pointer-events:none;
  }
  .inner{position:relative; padding:24px}
  .topbar{
    display:flex; align-items:center; justify-content:space-between;
    gap:12px; flex-wrap:wrap; margin-bottom:16px;
  }
  .brand{display:flex; align-items:center; gap:12px; user-select:none}
  .logo{
    width:44px; height:44px; border-radius:14px;
    background: linear-gradient(180deg, rgba(120,220,255,.22), rgba(255,255,255,.06));
    border:1px solid rgba(140,220,255,.22);
    display:grid; place-items:center;
    box-shadow:0 12px 28px rgba(0,0,0,.30);
    position:relative; overflow:hidden;
  }
  .logo::before{
    content:""; position:absolute; inset:-2px;
    background: radial-gradient(100px 60px at 25% 10%, rgba(255,255,255,.32), transparent 60%);
    opacity:.9;
  }
  .logo span{
    position:relative;
    font-weight:950;
    letter-spacing:.18em;
    transform: translateX(2px);
    text-shadow: 0 0 18px rgba(0,200,255,.22);
  }
  .brandText .mia{font-weight:950; letter-spacing:.16em; font-size:18px; line-height:1.05}
  .brandText .sub{font-size:12.5px; color:var(--muted)}
  .pill{
    font-size:12px;
    color: rgba(234,244,255,.90);
    background: rgba(255,255,255,.08);
    border: 1px solid rgba(255,255,255,.12);
    padding:8px 10px;
    border-radius:999px;
    display:flex; gap:8px; align-items:center;
    max-width: 560px;
  }
  .pill strong{font-weight:800}

  .btnRow{display:flex; gap:12px; flex-wrap:wrap}
  .btn{
    appearance:none;
    border:1px solid rgba(255,255,255,.18);
    background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
    color: var(--ink);
    padding: 13px 16px;
    border-radius: 18px;
    font-weight: 850;
    cursor:pointer;
    min-width: 240px;
    transition: transform .15s ease, border-color .2s ease, box-shadow .2s ease, opacity .2s ease;
    box-shadow: 0 12px 30px rgba(0,0,0,.26);
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    position:relative; overflow:hidden;
  }
  .btn::before{
    content:"";
    position:absolute; inset:-2px;
    background:
      radial-gradient(320px 90px at 18% 0%, rgba(255,255,255,.28), transparent 55%),
      radial-gradient(280px 90px at 85% 8%, rgba(120,220,255,.22), transparent 55%);
    opacity:.78; pointer-events:none;
    transform: translateY(-10px);
  }
  .btn:hover{transform: translateY(-1px); border-color: rgba(170,230,255,.34); box-shadow:0 16px 38px rgba(0,0,0,.32)}
  .btn:active{transform: translateY(0)}
  .btn.primary{background: linear-gradient(180deg, rgba(120,220,255,.22), rgba(0,140,255,.10)); border-color: rgba(140,220,255,.28)}
  .btn.small{min-width:auto; padding:10px 12px; border-radius:16px; font-size:13px; font-weight:850}
  .btn.ghost{background: rgba(0,0,0,.12); border-color: rgba(255,255,255,.14); box-shadow:none}
  .btn:disabled{opacity:.45; cursor:not-allowed; transform:none; box-shadow:0 12px 30px rgba(0,0,0,.18)}
  @media (max-width:720px){ .btn{min-width:100%} }

  .landing{width:min(920px, 94vw); text-align:center; padding:26px 16px}
  .big{
    font-size: clamp(58px, 10vw, 96px);
    font-weight: 980;
    letter-spacing:.22em;
    margin:0;
    display:inline-block;
    cursor:pointer;
    text-shadow: 0 0 22px rgba(0,200,255,.25);
    user-select:none;
    position:relative;
  }
  .big::after{
    content:"";
    position:absolute; left:50%; top:100%;
    width:70%; height:2px;
    background: linear-gradient(90deg, transparent, rgba(120,220,255,.75), transparent);
    transform: translateX(-50%);
    opacity:.7;
  }
  .subtitle{margin-top:14px; color:var(--muted); font-size: clamp(14px, 2.2vw, 18px)}
  .hint{margin-top:18px; font-size:13px; color:rgba(234,244,255,.72)}
  .kbd{
    display:inline-block;
    padding:3px 8px;
    border-radius:10px;
    border:1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.08);
    margin:0 6px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    font-size:12px;
  }

  .grid{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px; margin-top:12px}
  @media(max-width:720px){ .grid{grid-template-columns:1fr} }

  .field{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    border-radius:18px;
    padding:12px;
  }
  .field label{display:block; font-size:12px; color:rgba(234,244,255,.82); margin-bottom:8px}
  .req{color: rgba(180,240,255,.95); font-weight:900; margin-left:6px; font-size:11px}
  input, select{
    width:100%;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.18);
    color: var(--ink);
    border-radius:14px;
    padding:12px;
    font-size:14px;
    outline:none;
  }
  input:focus, select:focus{
    border-color: rgba(140,220,255,.32);
    box-shadow: 0 0 0 4px rgba(80,180,255,.10);
  }

  .note{
    margin-top:12px;
    padding:12px 14px;
    border-radius:18px;
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.12);
    color: rgba(234,244,255,.88);
    font-size:13px;
    line-height:1.35;
  }
  .statusRow{
    display:flex; align-items:flex-start; justify-content:space-between;
    gap:12px; flex-wrap:wrap; margin-top:12px;
  }
  .chip{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06);
    font-size:12px;
    color: rgba(234,244,255,.86);
  }

  /* Output */
  .panel{
    margin-top:14px;
    border-radius:22px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.14);
    padding:14px;
    max-height:64vh;
    overflow:auto;
    scroll-behavior:smooth;
    position:relative;
  }
  .fab{
    position:absolute;
    right:14px;
    bottom:14px;
    display:flex;
    flex-direction:column;
    gap:10px;
    z-index:5;
  }
  .kpiRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
  .kpi{
    padding:8px 10px;
    border-radius:999px;
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.12);
    font-size:12px;
  }
  .section{
    margin-top:12px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.12);
    background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.05));
    padding:14px;
  }
  .section h3{
    margin:0 0 8px;
    font-size:14.5px;
    letter-spacing:.02em;
    display:flex; align-items:center; gap:8px;
  }
  .dot{width:10px;height:10px;border-radius:50%;background:rgba(140,220,255,.75);box-shadow:0 0 18px rgba(0,200,255,.22);border:1px solid rgba(255,255,255,.18)}
  ul{margin:8px 0 0 18px}
  li{color: rgba(234,244,255,.88); line-height:1.5; font-size:13.8px}

  /* NeuroSpark scene */
  .calmWrap{
    border-radius: 22px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.14);
    overflow:hidden;
    position:relative;
    min-height: 380px;
  }
  .calmSky{
    position:absolute; inset:0;
    background:
      radial-gradient(900px 500px at 20% 10%, rgba(120,220,255,.18), transparent 60%),
      radial-gradient(700px 500px at 80% 30%, rgba(0,220,255,.10), transparent 60%),
      linear-gradient(180deg, rgba(0,0,0,.20), rgba(0,0,0,.36));
    opacity:.95;
  }
  .sparkLine{
    position:absolute; left:-20%; top:50%;
    width:140%; height:3px;
    background: linear-gradient(90deg, transparent, rgba(140,220,255,.9), transparent);
    filter: drop-shadow(0 0 16px rgba(0,200,255,.25));
    opacity:.35;
    transform: translateY(-50%);
  }
  .nsStage{
    position:absolute; inset:0;
    display:grid; place-items:center;
    padding:18px;
    text-align:center;
  }
  .nsTitle{
    font-weight:950;
    letter-spacing:.06em;
    font-size: 18px;
    margin:0 0 6px;
  }
  .nsText{
    margin:0;
    color: rgba(234,244,255,.85);
    font-size: 13.5px;
    line-height:1.45;
    max-width: 620px;
  }
  .nsHUD{
    position:absolute;
    left: 14px;
    right: 14px;
    top: 14px;
    display:flex;
    justify-content:space-between;
    gap:10px;
    align-items:flex-start;
    pointer-events:none;
  }
  .nsPill{
    pointer-events:none;
    font-size:12px;
    color: rgba(234,244,255,.88);
    background: rgba(0,0,0,.22);
    border: 1px solid rgba(255,255,255,.12);
    padding: 8px 10px;
    border-radius: 999px;
    backdrop-filter: blur(10px);
  }

  .pulseDanger{
    position:absolute; inset:0;
    background: radial-gradient(700px 380px at 50% 50%, rgba(255,255,255,.35), transparent 60%);
    opacity:0;
    pointer-events:none;
  }
  .pulseDanger.on{
    animation: pulseFlash 0.8s ease-in-out infinite;
    opacity: .22;
  }
  @keyframes pulseFlash{
    0%,100%{opacity:.10}
    50%{opacity:.36}
  }

  .shake{
    position:absolute; inset:0;
    pointer-events:none;
    opacity:0;
  }
  .shake.on{
    opacity:1;
    animation: shake 0.6s ease-in-out infinite;
  }
  @keyframes shake{
    0%{transform:translate(0,0)}
    20%{transform:translate(-2px,1px)}
    40%{transform:translate(2px,-1px)}
    60%{transform:translate(-1px,-2px)}
    80%{transform:translate(1px,2px)}
    100%{transform:translate(0,0)}
  }

  .calmBreath{
    position:absolute; inset:0;
    pointer-events:none;
    opacity:0;
  }
  .calmBreath.on{
    opacity:.8;
    animation: breathe 5s ease-in-out infinite;
  }
  @keyframes breathe{
    0%,100%{transform:scale(1); opacity:.22}
    50%{transform:scale(1.08); opacity:.38}
  }

  table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    overflow:hidden;
    border-radius: 18px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.12);
    margin-top:10px;
  }
  th,td{
    padding:12px;
    border-bottom:1px solid rgba(255,255,255,.10);
    vertical-align:top;
    font-size:13px;
    color: rgba(234,244,255,.88);
  }
  th{
    font-size:12px;
    letter-spacing:.03em;
    text-transform:uppercase;
    color: rgba(234,244,255,.78);
    background: rgba(255,255,255,.06);
  }
  tr:last-child td{border-bottom:none}
</style>
</head>

<body>
<div class="app">
  <div class="bg">
    <canvas id="ecg"></canvas>
    <div class="noise"></div>
    <div class="vignette"></div>
  </div>

  <!-- Landing -->
  <section class="screen active" id="s-landing">
    <div class="landing">
      <h1 class="big" id="miaBig">MIA</h1>
      <div class="subtitle">Mjekët e Inteligjencës Artificiale</div>
      <div class="hint">Kliko mbi <span class="kbd">MIA</span> ose shtyp <span class="kbd">Enter</span>.</div>
    </div>
  </section>

  <!-- Menu -->
  <section class="screen" id="s-menu">
    <div class="card">
      <div class="inner">
        <div class="topbar">
          <div class="brand">
            <div class="logo"><span>MIA</span></div>
            <div class="brandText">
              <div class="mia">MIA</div>
              <div class="sub">Mjekët e Inteligjencës Artificiale</div>
            </div>
          </div>
          <div class="pill" id="pillProfile"><strong>Profili:</strong> ende pa të dhëna — vendos të dhënat</div>
        </div>

        <div class="btnRow">
          <button class="btn primary" id="bData">Vendos të dhënat (e detyrueshme)</button>
          <button class="btn" id="bRoutine">Gjenero Rutinën Personale</button>
          <button class="btn" id="bNeuro">NeuroSpark</button>
        </div>

        <div class="note">
          <strong>Shënim:</strong> Kjo faqe jep udhëzime edukative. Nuk zëvendëson mjekun.
          <br><strong>Kujdes:</strong> NeuroSpark përdor efekte vizuale/audio. Nëse ke epilepsi fotosensitive, migrenë, ose ndihesh keq, mos e përdor.
        </div>
      </div>
    </div>
  </section>

  <!-- Data -->
  <section class="screen" id="s-data">
    <div class="card">
      <div class="inner">
        <div class="topbar">
          <div class="brand">
            <div class="logo"><span>MIA</span></div>
            <div class="brandText">
              <div class="mia">Vendos të dhënat</div>
              <div class="sub">Detyrueshme: Mosha, Gjinia, Emri</div>
            </div>
          </div>
          <button class="btn small ghost" id="back1">Kthehu</button>
        </div>

        <div class="grid">
          <div class="field">
            <label>Mosha <span class="req">(det.)</span></label>
            <input id="age" type="number" min="5" max="120" placeholder="p.sh. 16"/>
          </div>

          <div class="field">
            <label>Gjinia <span class="req">(det.)</span></label>
            <select id="gender">
              <option value="">Zgjidh…</option>
              <option value="Femër">Femër</option>
              <option value="Mashkull">Mashkull</option>
              <option value="Tjetër / s’dua të them">Tjetër / s’dua të them</option>
            </select>
          </div>

          <div class="field">
            <label>Problemi i zemrës <span style="opacity:.75">(ops.)</span></label>
            <select id="issue">
              <option value="">—</option>
              <option value="Takikardi">Takikardi</option>
              <option value="Bradikardi">Bradikardi</option>
              <option value="Aritmi">Aritmi</option>
              <option value="Tension i lartë">Tension i lartë</option>
              <option value="Dhimbje gjoksi">Dhimbje gjoksi</option>
              <option value="Tjetër">Tjetër</option>
            </select>
          </div>

          <div class="field">
            <label>Emri <span class="req">(det.)</span></label>
            <input id="name" type="text" placeholder="p.sh. Ardi" maxlength="32"/>
          </div>
        </div>

        <div class="statusRow">
          <div class="chip" id="statusData">Plotëso fushat e detyrueshme.</div>
          <button class="btn small primary" id="saveGo" style="display:none;">Kthehu në faqen kryesore</button>
        </div>

        <div class="note" style="opacity:.92;">Të dhënat përdoren vetëm për personalizimin e rutinës në këtë website.</div>
      </div>
    </div>
  </section>

  <!-- Routine -->
  <section class="screen" id="s-routine">
    <div class="card wide">
      <div class="inner">
        <div class="topbar">
          <div class="brand">
            <div class="logo"><span>MIA</span></div>
            <div class="brandText">
              <div class="mia" id="routineTitle">Rutina personale</div>
              <div class="sub" id="routineSub">Vendos BPM për të gjeneruar planin</div>
            </div>
          </div>
          <button class="btn small ghost" id="back2">Kthehu</button>
        </div>

        <div class="note" style="margin-top:0;">
          Vendos <strong>BPM</strong> (rrahje/minutë) dhe (nëse do) <strong>SpO₂</strong>.
          <span id="measureHint" style="opacity:.9;"></span>
        </div>

        <div class="grid">
          <div class="field">
            <label>BPM <span class="req">(det.)</span></label>
            <input id="bpm" type="number" min="30" max="220" placeholder="p.sh. 92"/>
          </div>
          <div class="field">
            <label>SpO₂ (%) <span style="opacity:.75">(ops.)</span></label>
            <input id="spo2" type="number" min="50" max="100" placeholder="p.sh. 98"/>
          </div>
          <div class="field">
            <label>Konteksti i BPM <span style="opacity:.75">(ops.)</span></label>
            <select id="ctx">
              <option value="rest">Në qetësi</option>
              <option value="after">Pas aktiviteti</option>
              <option value="stress">Në stres/ankth</option>
              <option value="unknown">Nuk jam i sigurt</option>
            </select>
          </div>
          <div class="field">
            <label>Burimi <span style="opacity:.75">(informues)</span></label>
            <input id="source" type="text" value="Manual" disabled />
          </div>
        </div>

        <div class="statusRow">
          <div class="chip" id="statusBpm">Vendos BPM (30–220).</div>
          <button class="btn small primary" id="gen">Gjenero</button>
        </div>

        <div id="wrapOut" style="display:none;">
          <div class="panel" id="panelOut">
            <div class="fab">
              <button class="btn small ghost" id="topOut">⬆︎ Lart</button>
              <button class="btn small primary" id="backOut">↩︎ Mbrapa</button>
            </div>

            <div class="section" style="margin-top:0;">
              <h3><span class="dot"></span> Përmbledhje</h3>
              <div class="kpiRow" id="kpis"></div>
            </div>

            <div class="section">
              <h3><span class="dot"></span> Udhëzime ditore</h3>
              <ul id="bulletsDaily"></ul>
            </div>

            <div class="section">
              <h3><span class="dot"></span> Plan javor</h3>
              <ul id="bulletsWeek"></ul>
            </div>

            <div class="section">
              <h3><span class="dot"></span> Kujdes</h3>
              <ul id="bulletsCaution"></ul>
            </div>

            <div class="statusRow" style="margin-top:12px;">
              <div class="chip">Përdor scroll + “Lart” për ta lexuar rehat.</div>
              <button class="btn small primary" id="backOut2">Kthehu në faqen e mëparshme</button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- NeuroSpark -->
  <section class="screen" id="s-neuro">
    <div class="card wide">
      <div class="inner">
        <div class="topbar">
          <div class="brand">
            <div class="logo"><span>MIA</span></div>
            <div class="brandText">
              <div class="mia">NeuroSpark</div>
              <div class="sub">Test i thjeshtë i reagimit ndaj stimulimit</div>
            </div>
          </div>
          <button class="btn small ghost" id="backNeuro">Kthehu</button>
        </div>

        <div class="note" style="margin-top:0;">
          <strong>Kujdes:</strong> Nëse ke epilepsi fotosensitive, migrenë, ose ndihesh i/e parehatshëm, mos e vazhdo.
          <br>Audio nuk luhet automatikisht: duhet ta nisësh vetë.
        </div>

        <div class="calmWrap" id="nsWrap">
          <div class="calmSky"></div>
          <div class="sparkLine" id="nsLine"></div>

          <div class="pulseDanger" id="nsFlash"></div>
          <div class="shake" id="nsShake"></div>
          <div class="calmBreath" id="nsBreath" style="background:radial-gradient(700px 380px at 50% 50%, rgba(140,220,255,.22), transparent 60%);"></div>

          <div class="nsHUD">
            <div class="nsPill" id="nsPillLeft">Gjendja: gati</div>
            <div class="nsPill" id="nsPillRight">Safe Mode: ON</div>
          </div>

          <div class="nsStage">
            <div>
              <h3 class="nsTitle" id="nsTitle">Starto NeuroSpark</h3>
              <p class="nsText" id="nsText">
                Ky test simulon stres të lehtë (vizual + audio opsionale) dhe në fund të kërkon të rimatësh BPM/SpO₂.
                <br><br><strong>Fillimisht duhet të kesh bërë matjen e parë</strong> te “Gjenero Rutinën Personale”.
              </p>
              <div style="margin-top:14px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
                <button class="btn small primary" id="nsStart">Fillo testin</button>
                <button class="btn small ghost" id="nsToggleSafe">Ndrysho Safe Mode</button>
                <button class="btn small ghost" id="nsToggleAudio">Audio: OFF</button>
              </div>

              <div class="statusRow" style="justify-content:center; margin-top:14px;">
                <button class="btn small primary" id="nsRemeasure" style="display:none;">Mat përsëri rrahjet</button>
              </div>
            </div>
          </div>
        </div>

        <div class="note" style="opacity:.92;">
          <strong>Safe Mode</strong> ul intensitetin e efekteve. Rekomandohet ta lësh ON.
        </div>
      </div>
    </div>
  </section>

  <!-- Result -->
  <section class="screen" id="s-result">
    <div class="card wide">
      <div class="inner">
        <div class="topbar">
          <div class="brand">
            <div class="logo"><span>MIA</span></div>
            <div class="brandText">
              <div class="mia">Rezultati i stresit</div>
              <div class="sub">Krahasim Matja 1 vs Matja 2</div>
            </div>
          </div>
          <button class="btn small ghost" id="backResult">Kthehu</button>
        </div>

        <div class="note" id="resultNote" style="margin-top:0;"></div>

        <div class="section">
          <h3><span class="dot"></span> Krahasimi i vlerave</h3>
          <div class="kpiRow" id="resultKpis"></div>
        </div>

        <div class="section">
          <h3><span class="dot"></span> Strategji për menaxhimin e stresit</h3>
          <div id="resultTableWrap"></div>
        </div>

        <div class="statusRow">
          <div class="chip">Ky interpretim është edukativ (jo diagnozë).</div>
          <button class="btn small primary" id="toMenu">Kthehu në faqen kryesore</button>
        </div>
      </div>
    </div>
  </section>
</div>

<script>
/* ========= Helpers ========= */
const esc = (s)=> (s??"").toString()
  .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
  .replaceAll('"',"&quot;").replaceAll("'","&#039;");

const S = {
  landing: document.getElementById("s-landing"),
  menu: document.getElementById("s-menu"),
  data: document.getElementById("s-data"),
  routine: document.getElementById("s-routine"),
  neuro: document.getElementById("s-neuro"),
  result: document.getElementById("s-result"),
};
function go(name){
  Object.values(S).forEach(x => x.classList.remove("active"));
  S[name].classList.add("active");
  setTimeout(()=> {
    const f = S[name].querySelector("button, input, select");
    if(f) f.focus({preventScroll:true});
  }, 60);
}

/* ========= State ========= */
const state = {
  profile: { age:null, gender:"", issue:"", name:"" },
  measurements: {
    baseline: null,   // { bpm, spo2, ctx }
    second: null      // { bpm, spo2, ctx }
  },
  flow: {
    remeasureMode: false, // true when returning from NeuroSpark
    safeMode: true,
    audioOn: false
  }
};

/* ========= Landing ========= */
document.getElementById("miaBig").addEventListener("click", ()=> go("menu"));
window.addEventListener("keydown", (e)=>{
  if(S.landing.classList.contains("active") && e.key==="Enter") go("menu");
});

/* ========= Menu ========= */
const pillProfile = document.getElementById("pillProfile");
function updatePill(){
  const p = state.profile;
  if(!(p.age && p.gender && p.name)){
    pillProfile.innerHTML = "<strong>Profili:</strong> ende pa të dhëna — vendos të dhënat";
    return;
  }
  const prob = p.issue ? (" · " + esc(p.issue)) : " · pa problem të deklaruar";
  pillProfile.innerHTML = `<strong>Profili:</strong> ${esc(p.name)} · ${p.age} vjeç · ${esc(p.gender)}${prob}`;
}
updatePill();

document.getElementById("bData").addEventListener("click", ()=> go("data"));
document.getElementById("bRoutine").addEventListener("click", ()=>{
  const p = state.profile;
  if(!(p.age && p.gender && p.name)) return go("data");
  state.flow.remeasureMode = false;
  setRoutineHeader();
  go("routine");
});
const bNeuro = document.getElementById("bNeuro");
bNeuro.addEventListener("click", ()=>{
  // require baseline measurement
  if(!state.measurements.baseline){
    // gently guide user to baseline
    state.flow.remeasureMode = false;
    setRoutineHeader(true);
    go("routine");
    flashHint("measureHint","(Së pari bëj Matjen 1, pastaj NeuroSpark.)");
    return;
  }
  go("neuro");
});

/* ========= Data ========= */
const age = document.getElementById("age");
const gender = document.getElementById("gender");
const issue = document.getElementById("issue");
const name = document.getElementById("name");
const statusData = document.getElementById("statusData");
const saveGo = document.getElementById("saveGo");

function validateData(){
  const a = parseInt(age.value, 10);
  const okAge = Number.isFinite(a) && a>=5 && a<=120;
  const okG = !!gender.value;
  const okN = name.value.trim().length >= 2;
  const ok = okAge && okG && okN;

  if(ok){
    statusData.textContent = "Gati ✅";
    saveGo.style.display = "inline-flex";
  } else {
    const miss = [];
    if(!okAge) miss.push("Mosha (5–120)");
    if(!okG) miss.push("Gjinia");
    if(!okN) miss.push("Emri (min 2 shkronja)");
    statusData.textContent = "Plotëso: " + miss.join(" · ");
    saveGo.style.display = "none";
  }
  return ok;
}
[age,gender,issue,name].forEach(el=>{
  el.addEventListener("input", validateData);
  el.addEventListener("change", validateData);
});
document.getElementById("back1").addEventListener("click", ()=> go("menu"));
saveGo.addEventListener("click", ()=>{
  if(!validateData()) return;
  state.profile.age = parseInt(age.value,10);
  state.profile.gender = gender.value;
  state.profile.issue = issue.value;
  state.profile.name = name.value.trim();
  updatePill();
  go("menu");
});
validateData();

/* ========= Routine ========= */
const bpm = document.getElementById("bpm");
const spo2 = document.getElementById("spo2");
const ctx = document.getElementById("ctx");
const statusBpm = document.getElementById("statusBpm");
const wrapOut = document.getElementById("wrapOut");
const panelOut = document.getElementById("panelOut");
const routineTitle = document.getElementById("routineTitle");
const routineSub = document.getElementById("routineSub");
const measureHint = document.getElementById("measureHint");

function setRoutineHeader(forceBaseline=false){
  const re = state.flow.remeasureMode;
  if(re){
    routineTitle.textContent = "Rimatja (Matja 2)";
    routineSub.textContent = "Pas NeuroSpark — vendos vlerat e reja";
    measureHint.textContent = "(Tani po bën Matjen 2.)";
  } else {
    routineTitle.textContent = "Rutina personale";
    routineSub.textContent = "Vendos BPM për të gjeneruar planin";
    measureHint.textContent = forceBaseline ? "(Bëj Matjen 1 përpara se të vazhdosh.)" : "";
  }
}

function flashHint(id, text){
  const el = document.getElementById(id);
  if(!el) return;
  const old = el.textContent;
  el.textContent = text;
  setTimeout(()=> el.textContent = old, 2500);
}

function okBpm(){
  const v = parseInt(bpm.value,10);
  const ok = Number.isFinite(v) && v>=30 && v<=220;
  statusBpm.textContent = ok ? "BPM i vlefshëm ✅" : "Vendos BPM (30–220).";
  return ok;
}
bpm.addEventListener("input", okBpm);

function okSpo2(){
  if(!spo2.value) return true;
  const v = parseInt(spo2.value,10);
  return Number.isFinite(v) && v>=50 && v<=100;
}

document.getElementById("back2").addEventListener("click", ()=> { wrapOut.style.display="none"; go("menu"); });
document.getElementById("topOut").addEventListener("click", ()=> panelOut.scrollTo({top:0, behavior:"smooth"}));
function closeOut(){ wrapOut.style.display="none"; panelOut.scrollTop=0; }
document.getElementById("backOut").addEventListener("click", closeOut);
document.getElementById("backOut2").addEventListener("click", closeOut);

const kpis = document.getElementById("kpis");
const bulletsDaily = document.getElementById("bulletsDaily");
const bulletsWeek = document.getElementById("bulletsWeek");
const bulletsCaution = document.getElementById("bulletsCaution");

function ageGroup(a){
  if(a<=11) return "fëmijë";
  if(a<=19) return "adoleshent";
  if(a<=35) return "i ri";
  if(a<=59) return "i rritur";
  return "i moshuar";
}
function zoneOf(v){ return v<60 ? "i ulët" : (v<=100 ? "normal" : "i lartë"); }

function buildPlan(p, bpmVal, spo2Val, ctxVal){
  const zone = zoneOf(bpmVal);
  const group = ageGroup(p.age);
  const issueV = p.issue || "";

  let waterL = 1.7;
  if(group==="fëmijë") waterL = 1.2;
  if(group==="adoleshent") waterL = 1.8;
  if(group==="i ri") waterL = 2.0;
  if(group==="i rritur") waterL = 1.9;
  if(group==="i moshuar") waterL = 1.6;

  if(zone==="i lartë") waterL += 0.2;
  if(issueV==="Takikardi" || zone==="i lartë") waterL += 0.1;
  const water = Math.max(1.0, Math.min(2.4, waterL));

  let sleep = 7.5;
  if(group==="fëmijë") sleep = 9.0;
  if(group==="adoleshent") sleep = 8.5;
  if(group==="i moshuar") sleep = 7.0;

  let cardio = "20–30 min ecje e shpejtë, 4–5 ditë/javë";
  let strength = "2 ditë/javë ushtrime të lehta";
  let breathe = "2–3 herë/ditë, 2 minuta frymëmarrje (4-4-6)";

  if(zone==="i lartë"){
    cardio = "15–25 min ecje e moderuar, 4 ditë/javë (pa e tepruar)";
    strength = "2 ditë/javë ushtrime të lehta + pauza";
  }
  if(zone==="i ulët"){
    cardio = "20 min ecje e lehtë, 4 ditë/javë + ngrohje e gjatë";
    strength = "2 ditë/javë ritëm i kontrolluar";
  }

  const ctxNote = {
    rest: "Matje në qetësi: vlerë më e krahasueshme.",
    after: "Pas aktiviteti: BPM rritet natyrshëm; mat sërish pas 10 minutash qetësi.",
    stress: "Në stres/ankth: BPM mund të rritet përkohësisht.",
    unknown: "Kontekst i panjohur: interpreto me kujdes dhe mat sërish në qetësi."
  }[ctxVal] || "—";

  let spo2Note = "SpO₂ nuk është vendosur.";
  let spo2Flag = "none";
  if(Number.isFinite(spo2Val)){
    if(spo2Val >= 95) { spo2Note = "SpO₂ në nivel të mirë."; spo2Flag="ok"; }
    else if(spo2Val >= 92) { spo2Note = "SpO₂ pak e ulët: pusho, mat sërish dhe sigurohu që vlera është marrë saktë."; spo2Flag="mid"; }
    else { spo2Note = "SpO₂ e ulët: nëse shoqërohet me gulçim ose dobësi, kërko ndihmë mjekësore."; spo2Flag="low"; }
  }

  const daily = [];
  daily.push(`Ujë: ${water.toFixed(1)} L/ditë, të ndara në 5 momente (08:00, 11:00, 14:00, 17:00, 20:00).`);
  daily.push(`Gjumë: ${sleep.toFixed(1)} orë/natë. Vendos orar të qëndrueshëm.`);
  daily.push(`Aktivitet fizik: ${cardio}.`);
  daily.push(`Forcë muskulare: ${strength}.`);
  daily.push(`Relaksim: ${breathe}.`);
  daily.push(`Kontekst: ${ctxNote}`);
  if(group==="adoleshent") daily.push("Shmang energizantët dhe kafeinën e tepërt, sidomos pas orës 15:00.");
  if(issueV==="Takikardi" || zone==="i lartë") daily.push("Nëse BPM është i lartë në qetësi që përsëritet, rekomandohet konsultë mjekësore.");
  if(issueV==="Bradikardi" || zone==="i ulët") daily.push("Nëse BPM i ulët shoqërohet me të fikët/lodhje të fortë, kërko vlerësim mjekësor.");
  if(issueV==="Aritmi") daily.push("Nëse ndjen rrahje të parregullta: pusho, shëno kohën/ndjesitë dhe konsulto mjekun.");
  if(issueV==="Tension i lartë") daily.push("Ushqim: më pak kripë, më shumë fruta/perime; ecje e përditshme.");
  if(issueV==="Dhimbje gjoksi") daily.push("Dhimbja e gjoksit nuk neglizhohet—sidomos me gulçim ose marramendje.");
  daily.push(spo2Note);

  const week = [
    "E Hënë: ecje + shtrirje 8 min.",
    "E Martë: ushtrime të lehta (15–20 min) + shtrirje.",
    "E Mërkurë: ecje + frymëmarrje 5 min.",
    "E Enjte: ushtrime të lehta + shtrirje.",
    "E Premte: ecje + aktivitet relaksues (muzikë/lexim).",
    "E Shtunë: aktivitet i lehtë i lirë (shëtitje/biçikletë).",
    "E Diel: rikuperim + planifikim jave."
  ];

  const caution = [];
  if(zone==="i lartë" && ctxVal==="rest") caution.push("BPM i lartë në qetësi që përsëritet: rekomandohet vlerësim mjekësor.");
  if(zone==="i ulët" && ctxVal==="rest") caution.push("BPM i ulët në qetësi: nëse shoqërohet me simptoma, kërko vlerësim mjekësor.");
  if(spo2Flag==="low") caution.push("SpO₂ e ulët + gulçim/dobësi: kërko ndihmë mjekësore.");
  caution.push("Ky plan është edukativ dhe nuk zëvendëson mjekun.");

  return { zone, group, daily, week, caution };
}

function storeMeasurement(which, bpmVal, spo2Val, ctxVal){
  state.measurements[which] = { bpm:bpmVal, spo2: Number.isFinite(spo2Val) ? spo2Val : null, ctx: ctxVal };
}

document.getElementById("gen").addEventListener("click", ()=>{
  const p = state.profile;
  if(!(p.age && p.gender && p.name)) return go("data");
  if(!okBpm()) return;
  if(!okSpo2()){
    statusBpm.textContent = "SpO₂ duhet të jetë 50–100 (ose lëre bosh).";
    return;
  }

  const bpmVal = parseInt(bpm.value,10);
  const spo2Val = spo2.value ? parseInt(spo2.value,10) : NaN;
  const ctxVal = ctx.value;

  // Save measurement (baseline or second)
  if(state.flow.remeasureMode){
    storeMeasurement("second", bpmVal, spo2Val, ctxVal);
  } else {
    storeMeasurement("baseline", bpmVal, spo2Val, ctxVal);
  }

  // Build routine output (always show)
  const plan = buildPlan(p, bpmVal, spo2Val, ctxVal);

  kpis.innerHTML = `
    <div class="kpi">Emri: <strong>${esc(p.name)}</strong></div>
    <div class="kpi">Mosha: <strong>${p.age}</strong> (${plan.group})</div>
    <div class="kpi">BPM: <strong>${bpmVal}</strong> (${plan.zone})</div>
    <div class="kpi">SpO₂: <strong>${Number.isFinite(spo2Val)?(spo2Val+"%"):"—"}</strong></div>
    <div class="kpi">Problemi: <strong>${esc(p.issue||"—")}</strong></div>
  `;
  bulletsDaily.innerHTML = plan.daily.map(x=>`<li>${esc(x)}</li>`).join("");
  bulletsWeek.innerHTML = plan.week.map(x=>`<li>${esc(x)}</li>`).join("");
  bulletsCaution.innerHTML = plan.caution.map(x=>`<li>${esc(x)}</li>`).join("");

  wrapOut.style.display = "block";
  panelOut.scrollTop = 0;

  // Enable NeuroSpark button once baseline exists
  if(state.measurements.baseline) bNeuro.disabled = false;

  // If this was second measurement, go to result after showing routine briefly
  if(state.flow.remeasureMode){
    setTimeout(()=> {
      wrapOut.style.display = "none";
      state.flow.remeasureMode = false;
      setRoutineHeader();
      go("result");
      renderResult();
    }, 500); // quick smooth experience
  }
});

/* ========= NeuroSpark ========= */
document.getElementById("backNeuro").addEventListener("click", ()=> go("menu"));

const nsPillLeft = document.getElementById("nsPillLeft");
const nsPillRight = document.getElementById("nsPillRight");
const nsTitle = document.getElementById("nsTitle");
const nsText = document.getElementById("nsText");
const nsStart = document.getElementById("nsStart");
const nsToggleSafe = document.getElementById("nsToggleSafe");
const nsToggleAudio = document.getElementById("nsToggleAudio");
const nsRemeasure = document.getElementById("nsRemeasure");
const nsFlash = document.getElementById("nsFlash");
const nsShake = document.getElementById("nsShake");
const nsBreath = document.getElementById("nsBreath");

let audioCtx = null;
let beepOsc = null;
let beepGain = null;

function setSafeUI(){
  nsPillRight.textContent = "Safe Mode: " + (state.flow.safeMode ? "ON" : "OFF");
  // adjust intensity
  nsFlash.style.opacity = state.flow.safeMode ? ".18" : ".28";
}
setSafeUI();

nsToggleSafe.addEventListener("click", ()=>{
  state.flow.safeMode = !state.flow.safeMode;
  setSafeUI();
});

function stopAudio(){
  try{
    if(beepOsc){ beepOsc.stop(); }
  }catch{}
  beepOsc=null;
  if(audioCtx){
    try{ audioCtx.close(); }catch{}
  }
  audioCtx=null;
  beepGain=null;
  nsToggleAudio.textContent = "Audio: OFF";
  state.flow.audioOn = false;
}
function startAudio(){
  // User gesture required by browsers
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  beepOsc = audioCtx.createOscillator();
  beepGain = audioCtx.createGain();

  // softer in safe mode
  const vol = state.flow.safeMode ? 0.03 : 0.06;
  beepGain.gain.value = vol;

  beepOsc.type = "square";
  beepOsc.frequency.value = 880;
  beepOsc.connect(beepGain);
  beepGain.connect(audioCtx.destination);
  beepOsc.start();
  nsToggleAudio.textContent = "Audio: ON";
  state.flow.audioOn = true;
}
nsToggleAudio.addEventListener("click", ()=>{
  if(state.flow.audioOn){ stopAudio(); return; }
  try{ startAudio(); }catch{ stopAudio(); }
});

function resetNeuroUI(){
  nsFlash.classList.remove("on");
  nsShake.classList.remove("on");
  nsBreath.classList.remove("on");
  nsRemeasure.style.display = "none";
  nsTitle.textContent = "Starto NeuroSpark";
  nsText.innerHTML = `
    Ky test simulon stres të lehtë (vizual + audio opsionale) dhe në fund të kërkon të rimatësh BPM/SpO₂.
    <br><br><strong>Matja 1</strong> duhet të jetë bërë më parë.
  `;
  nsPillLeft.textContent = "Gjendja: gati";
}

function stageText(title, text, stateLabel){
  nsTitle.textContent = title;
  nsText.textContent = text;
  nsPillLeft.textContent = "Gjendja: " + stateLabel;
}

function delay(ms){ return new Promise(res=>setTimeout(res, ms)); }

async function runNeuroSpark(){
  if(!state.measurements.baseline){
    stageText("Së pari Matja 1", "Shko te “Gjenero Rutinën Personale” dhe vendos BPM/SpO₂ për Matjen 1.", "mungon matja 1");
    return;
  }

  nsStart.disabled = true;
  nsToggleSafe.disabled = true;
  nsRemeasure.style.display = "none";

  // Stage 1: visual pulses (gentle by default)
  stageText("Stimul vizual", "Drita pulsante për disa sekonda. Nëse ndihesh keq, ndalo testin.", "vizual");
  nsFlash.classList.add("on");
  await delay(state.flow.safeMode ? 4200 : 5200);

  // Stage 2: sound + shake (audio optional)
  stageText("Stimul audio", "Audio është opsional. Nëse e ke ON, do të dëgjosh një sinjal të shkurtër.", "audio");
  nsShake.classList.add("on");
  if(state.flow.audioOn){
    // modulate beep slightly
    const base = 780;
    for(let i=0;i<6;i++){
      if(beepOsc) beepOsc.frequency.value = base + i*80;
      await delay(state.flow.safeMode ? 220 : 180);
    }
  }
  await delay(state.flow.safeMode ? 2200 : 2600);
  nsShake.classList.remove("on");

  // Stage 3: cognitive load (the “something else”)
  // simple, calm reaction: show breathing + instruction to focus
  nsFlash.classList.remove("on");
  stageText("Fokus & rikuperim", "Tani shiko pikën në qendër dhe merr 4 frymëmarrje të ngadalta (4 sek, mbaj 2 sek, nxirr 6 sek).", "rikuperim");
  nsBreath.classList.add("on");
  await delay(6500);

  nsBreath.classList.remove("on");
  stageText("Gati për rimatje", "Tani rimat BPM/SpO₂ për të parë ndryshimin pas stimulimit.", "përfundoi");

  nsRemeasure.style.display = "inline-flex";
  nsStart.disabled = false;
  nsToggleSafe.disabled = false;
}

nsStart.addEventListener("click", ()=>{
  // avoid seizure risk: keep safe mode default on; test runs only on click
  runNeuroSpark();
});

nsRemeasure.addEventListener("click", ()=>{
  // Go to routine page for second measurement
  state.flow.remeasureMode = true;
  setRoutineHeader();
  wrapOut.style.display = "none";
  bpm.value = "";
  spo2.value = "";
  okBpm();
  go("routine");
});

/* ========= Result Page ========= */
document.getElementById("backResult").addEventListener("click", ()=> go("menu"));
document.getElementById("toMenu").addEventListener("click", ()=> go("menu"));

const resultNote = document.getElementById("resultNote");
const resultKpis = document.getElementById("resultKpis");
const resultTableWrap = document.getElementById("resultTableWrap");

function renderResult(){
  const a = state.measurements.baseline;
  const b = state.measurements.second;
  if(!a || !b){
    resultNote.innerHTML = "<strong>Gabim:</strong> mungon Matja 1 ose Matja 2.";
    resultKpis.innerHTML = "";
    resultTableWrap.innerHTML = "";
    return;
  }

  const dBpm = b.bpm - a.bpm;
  const pct = Math.round((dBpm / a.bpm) * 100);
  const dSpo2 = (b.spo2!=null && a.spo2!=null) ? (b.spo2 - a.spo2) : null;

  // Simple “anxiety-like stress response” heuristic (NOT diagnosis):
  // - If BPM increases >= 25 OR >= 20% from baseline (and baseline was not post-activity)
  const baselineContext = a.ctx || "rest";
  const likelyStress = (dBpm >= 25 || pct >= 20) && baselineContext !== "after";

  resultKpis.innerHTML = `
    <div class="kpi">Matja 1 BPM: <strong>${a.bpm}</strong></div>
    <div class="kpi">Matja 2 BPM: <strong>${b.bpm}</strong></div>
    <div class="kpi">Ndryshimi: <strong>${dBpm>0?"+":""}${dBpm}</strong> (${pct>0?"+":""}${pct}%)</div>
    <div class="kpi">SpO₂: <strong>${a.spo2??"—"}%</strong> → <strong>${b.spo2??"—"}%</strong> ${dSpo2==null?"":`(${dSpo2>0?"+":""}${dSpo2}%)`}</div>
  `;

  if(likelyStress){
    resultNote.innerHTML = `
      <strong>Interpretim edukativ:</strong> Ndryshimi i BPM është relativisht i madh.
      Kjo mund të tregojë <strong>reagim të fortë ndaj stresit/ankthit</strong>.
      <br><span style="opacity:.9">Nuk është diagnozë. Nëse kjo të ndodh shpesh, konsultohu me mjekun ose psikologun.</span>
    `;
    resultTableWrap.innerHTML = `
      <table>
        <thead>
          <tr><th>Teknika</th><th>Si bëhet</th><th>Kur ndihmon</th></tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Frymëmarrja 4-4-6</strong></td>
            <td>Merr frymë 4 sek, mbaj 4 sek, nxirr 6 sek. 5 cikle.</td>
            <td>Kur ndjen rrahje të shpejta, tension, shqetësim.</td>
          </tr>
          <tr>
            <td><strong>Rikthimi në trup</strong></td>
            <td>Shtri duart, ndjej këmbët në tokë, numëro 5 gjëra që sheh.</td>
            <td>Kur mendimet “vrapojnë” ose ndihesh i/e humbur.</td>
          </tr>
          <tr>
            <td><strong>Ecje 10 minuta</strong></td>
            <td>Ecje e lehtë, fokus tek ritmi i hapave dhe frymëmarrja.</td>
            <td>Kur stresi rritet gjatë ditës.</td>
          </tr>
          <tr>
            <td><strong>Kufizo stimuluesit</strong></td>
            <td>Ul kafeinën/energizantët dhe ekranet para gjumit.</td>
            <td>Për rrahje të shpejta dhe gjumë të dobët.</td>
          </tr>
          <tr>
            <td><strong>Rutina e gjumit</strong></td>
            <td>Ora fikse gjumi + 30 min qetësi pa ekran.</td>
            <td>Kur ankthi rritet nga lodhja.</td>
          </tr>
        </tbody>
      </table>
    `;
  } else {
    resultNote.innerHTML = `
      <strong>Interpretim edukativ:</strong> Matjet nuk tregojnë ndryshim të madh të BPM.
      <br>Website sugjeron që je <strong>pa shenja të forta reagimi ndaj stresit</strong> në këtë test.
      <br><span style="opacity:.9">Vazhdo me rutinë të shëndetshme dhe menaxhim të mirë të gjumit.</span>
    `;
    resultTableWrap.innerHTML = `
      <table>
        <thead>
          <tr><th>Çfarë të vazhdosh</th><th>Pse</th></tr>
        </thead>
        <tbody>
          <tr><td><strong>Aktivitet i rregullt</strong></td><td>Ndihmon zemrën dhe ul stresin në mënyrë natyrale.</td></tr>
          <tr><td><strong>Gjumë i qëndrueshëm</strong></td><td>Stabilizon ritmin kardiak dhe energjinë.</td></tr>
          <tr><td><strong>Hidratim</strong></td><td>Dehidratimi mund të rrisë pulsin.</td></tr>
          <tr><td><strong>Pushime të shkurtra</strong></td><td>2–3 min qetësi gjatë ditës rrisin fokusin dhe qetësinë.</td></tr>
        </tbody>
      </table>
    `;
  }
}

/* ========= Neuro page setup: buttons and safe defaults ========= */
document.getElementById("nsToggleSafe").addEventListener("click", ()=>{});
document.getElementById("nsToggleAudio").addEventListener("click", ()=>{});

/* Ensure neuro UI is always clean when entering */
const origGo = go;
go = function(name){
  origGo(name);
  if(name==="neuro"){
    resetNeuroUI();
    // keep safe mode default ON
    setSafeUI();
    nsToggleAudio.textContent = state.flow.audioOn ? "Audio: ON" : "Audio: OFF";
    nsPillLeft.textContent = "Gjendja: gati";
  }
  if(name==="menu"){
    // disable NeuroSpark until baseline exists
    bNeuro.disabled = !state.measurements.baseline;
  }
};

/* ========= ECG Background animation ========= */
const canvasEcg = document.getElementById("ecg");
const c = canvasEcg.getContext("2d");
let W=0,H=0,t=0;
function resizeEcg(){
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  W = canvasEcg.clientWidth; H = canvasEcg.clientHeight;
  canvasEcg.width = Math.floor(W*dpr);
  canvasEcg.height = Math.floor(H*dpr);
  c.setTransform(dpr,0,0,dpr,0,0);
}
window.addEventListener("resize", resizeEcg);
resizeEcg();

function drawEcg(){
  t += 0.016;
  c.fillStyle = "rgba(0,0,0,0.18)";
  c.fillRect(0,0,W,H);

  c.save();
  c.globalAlpha = 0.10;
  c.strokeStyle = "rgba(120,220,255,0.35)";
  c.lineWidth = 1;
  const step = 42;
  for(let x=0;x<W;x+=step){ c.beginPath(); c.moveTo(x,0); c.lineTo(x,H); c.stroke(); }
  for(let y=0;y<H;y+=step){ c.beginPath(); c.moveTo(0,y); c.lineTo(W,y); c.stroke(); }
  c.restore();

  const mid = H*0.52;
  const amp = Math.min(64, H*0.10);

  c.save();
  c.lineWidth = 2.2;
  c.strokeStyle = "rgba(140,220,255,0.95)";
  c.shadowColor = "rgba(0,190,255,0.35)";
  c.shadowBlur = 18;

  c.beginPath();
  const speed = 220;
  const phase = (t*speed) % W;

  for(let x=0;x<=W;x++){
    const u = ((x + phase) % 260) / 260;
    let y = 0;
    y += Math.sin((x*0.014) + t*1.6) * (amp*0.08);
    if(u > 0.30 && u < 0.34) y += -amp*0.20;
    if(u >= 0.34 && u < 0.36) y +=  amp*0.55;
    if(u >= 0.36 && u < 0.40) y += -amp*1.00;
    if(u >= 0.40 && u < 0.44) y +=  amp*0.30;
    if(u >= 0.44 && u < 0.52) y +=  Math.sin((u-0.44)*Math.PI*6) * (amp*0.10);

    const yy = mid + y;
    if(x===0) c.moveTo(x,yy); else c.lineTo(x,yy);
  }
  c.stroke();

  c.globalAlpha = 0.25;
  c.lineWidth = 6;
  c.strokeStyle = "rgba(0,200,255,0.35)";
  c.stroke();
  c.restore();

  requestAnimationFrame(drawEcg);
}
requestAnimationFrame(drawEcg);

/* ========= Final init ========= */
document.getElementById("backNeuro").addEventListener("click", ()=> { stopAudio(); go("menu"); });
document.getElementById("backResult").addEventListener("click", ()=> go("menu"));
document.getElementById("toMenu").addEventListener("click", ()=> go("menu"));

bNeuro.disabled = true; // until baseline exists
setRoutineHeader();
</script>
</body>
</html>
